<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NR KPI Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<style>
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f0f2f5; overflow-x:hidden; }
header { text-align:center; padding:20px 0; font-size:32px; font-weight:bold; color:#2F80ED; background:white; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:16px; }
.navbar { display:flex; justify-content:center; gap:10px; margin-bottom:16px; flex-wrap:wrap; }
.navbar button { padding:8px 16px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:bold; transition:0.2s; }
.navbar button:hover { background:#1f5ab5; }
.tabs { display:flex; justify-content:center; margin-bottom:16px; flex-wrap:wrap; gap:8px; }
.tab { padding:10px 20px; cursor:pointer; border:1px solid #ccc; border-radius:8px; background:#eee; font-weight:bold; transition:0.3s; }
.tab.active { background:#2F80ED; color:white; }
.tab:hover:not(.active) { background:#d0e1ff; }
.controls { display:flex; justify-content:center; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
#siteFilter { padding:8px; width:250px; border-radius:6px; border:1px solid #ccc; }
#dropdown { position:absolute; background:white; border:1px solid #ccc; max-height:150px; overflow-y:auto; display:none; z-index:10; width:250px; top:38px; left:0; border-radius:6px; }
#dropdown div { padding:6px 10px; cursor:pointer; transition:0.2s; }
#dropdown div:hover { background:#2F80ED; color:white; }
#siteDropdownBtn { padding:8px 10px; cursor:pointer; border:1px solid #ccc; border-radius:6px; background:white; min-width:250px; text-align:left; position:relative; z-index:5; }
#siteDropdownList { position:absolute; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; display:none; z-index:10; width:250px; border-radius:6px; padding:6px; }

button { padding:10px 18px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:bold; transition:0.2s; }
button:hover { background:#1f5ab5; }

.chart-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:20px; padding:0 20px 20px 20px; }
canvas { background:white; border-radius:12px; padding:16px; width:100% !important; height:250px !important; }
.chart-card { padding:10px; border-radius:12px; background:white; box-shadow:0 2px 12px rgba(0,0,0,0.1); transition:0.3s; }
.chart-card:hover { transform:translateY(-4px); box-shadow:0 6px 20px rgba(0,0,0,0.15); }
.chart-title { text-align:center; font-weight:bold; margin-bottom:10px; color:#333; }

/* Drawer */
.kpiDrawer { 
  position:fixed; top:0; right:0; width:320px; height:100%; background:white; 
  box-shadow:-4px 0 12px rgba(0,0,0,0.15); transition:0.3s; z-index:20; padding:20px; 
  overflow-y:auto; display:none; 
}
.kpiDrawer.open { display:block; }
.kpiDrawer h3 { margin-top:0; margin-bottom:12px; color:#2F80ED; }
.kpiOption { margin-bottom:6px; }
#applyAcceptanceBtn, #applyMonitoringBtn { margin-top:10px; width:100%; }

/* Minimal blue toggle button */
.kpiDrawerToggle { position:fixed; top:20px; right:0; width:30px; height:80px; background:#2F80ED; border-radius:6px 0 0 6px; cursor:pointer; z-index:25; }
.kpiDrawerToggle:hover { background:#1f5ab5; }
</style>
</head>
<body>

<header>NR KPI Dashboard</header>

<div class="navbar">
  <button onclick="window.location.href='index.html'">LTE</button>
  <button onclick="window.location.href='gsm.html'">GSM</button>
  <button onclick="window.location.href='nr.html'">NR</button>
  <button onclick="window.location.href='nsa.html'">NSA</button>
</div>

<div class="tabs">
  <div class="tab active" data-tab="acceptance">Acceptance KPIs</div>
  <div class="tab" data-tab="monitoring">Monitoring KPIs</div>
</div>

<div class="controls">
  <div style="position:relative;">
    <input type="text" id="siteFilter" placeholder="Search NR Site Name">
    <div id="dropdown"></div>
  </div>
  <div style="position:relative;">
    <button id="siteDropdownBtn">All Sites ▼</button>
    <div id="siteDropdownList"></div>
  </div>
  <button id="refreshBtn">Refresh Data</button>
</div>

<div id="acceptancePage">
  <div class="chart-grid" id="acceptanceChartContainer"></div>
</div>
<div id="monitoringPage" style="display:none;">
  <div class="chart-grid" id="monitoringChartContainer"></div>
</div>

<div id="acceptanceDrawer" class="kpiDrawer">
  <h3>KPIs</h3>
  <div><input type="checkbox" id="selectAllAcceptance"> <label for="selectAllAcceptance"><b>Select All</b></label></div>
  <div id="acceptanceKpiOptions"></div>
  <button id="applyAcceptanceBtn">Apply</button>
</div>
<div id="monitoringDrawer" class="kpiDrawer">
  <h3>KPIs</h3>
  <div><input type="checkbox" id="selectAllMonitoring"> <label for="selectAllMonitoring"><b>Select All</b></label></div>
  <div id="monitoringKpiOptions"></div>
  <button id="applyMonitoringBtn">Apply</button>
</div>

<div id="drawerToggle" class="kpiDrawerToggle"></div>

<script>
// --- FULL JS COPIED FROM LTE ---
// Change site column name to "NR Site Name" or keep same if your CSV uses "eNodeB Name"
let allData=[], fuse=null, allSites=[];
let selectedSites=[];
let acceptanceKpisList=[], monitoringKpisList=[];
let selectedAcceptanceKpis=[], selectedMonitoringKpis=[];
const animationDuration=150;

const acceptanceKpis = [
  "NSA Average User Number","SgNB Addition Success Rate (CU)","SgNB TriSgNB Abnormal Release Rate","SCG PSCell Change Success Rate","Intra-SgNB IntraFreq PSCell Change Success Rate",
  "Intra-SgNB Pscell Change Success Rate","Inter-SgNB Pscell Change Success Rate","Inter-SgNB PSCell IntraFreq Change Success Rate","DL Avg Latency (ms)"

];
const monitoringKpis = [
  
];

async function fetchData(){
  const res = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=0&single=true&output=csv");
  const text = await res.text();
  const rows = text.trim().split('\n').map(r=>r.split(','));
  const headers = rows.shift().map(h=>h.trim());
  allData = rows.map(r=>{ const obj={}; headers.forEach((h,i)=>{ const val=r[i]?r[i].trim():"0"; obj[h]=isNaN(val)?val:parseFloat(val); }); return obj; });
  fuse = new Fuse(allData,{ keys:['eNodeB Name'], threshold:0.4 });
  allSites = [...new Set(allData.map(d=>d["eNodeB Name"]))].sort();
  populateSiteDropdown();
  populateKpiDrawers();
  drawAcceptanceCharts();
}

function populateSiteDropdown(){
  const list = document.getElementById("siteDropdownList");
  list.innerHTML="";
  const selectAllDiv = document.createElement("div");
  selectAllDiv.style.padding="6px 10px"; selectAllDiv.style.borderBottom="1px solid #ddd"; selectAllDiv.style.cursor="pointer";
  selectAllDiv.innerHTML = `<b>Select All Sites</b>`;
  selectAllDiv.onclick = () => { selectedSites = allSites.slice(); list.querySelectorAll(".siteOption").forEach(c => c.checked = true); updateSiteButtonLabel(); drawCurrentPageCharts(); };
  list.appendChild(selectAllDiv);
  const clearDiv = document.createElement("div");
  clearDiv.style.padding="6px 10px"; clearDiv.style.borderBottom="1px solid #ddd"; clearDiv.style.cursor="pointer";
  clearDiv.innerHTML = `<b>Clear Filter</b>`; clearDiv.onclick = () => { selectedSites=[]; list.querySelectorAll(".siteOption").forEach(c=>c.checked=false); updateSiteButtonLabel(); drawCurrentPageCharts(); };
  list.appendChild(clearDiv);
  allSites.forEach((site,i)=>{ const div=document.createElement("div"); div.innerHTML=`<input type="checkbox" class="siteOption" id="site_${i}" value="${site}"><label for="site_${i}">${site}</label>`; div.style.padding="6px 10px"; list.appendChild(div); });
  document.getElementById("siteDropdownBtn").onclick = ()=>{ list.style.display = list.style.display==="block" ? "none" : "block"; };
  list.querySelectorAll(".siteOption").forEach(chk=>{ chk.addEventListener("change", ()=>{ selectedSites = Array.from(list.querySelectorAll(".siteOption:checked")).map(c=>c.value); updateSiteButtonLabel(); drawCurrentPageCharts(); }); });
}

function updateSiteButtonLabel(){ const btn=document.getElementById("siteDropdownBtn"); if(selectedSites.length===0 || selectedSites.length===allSites.length){ btn.textContent="All Sites ▼"; } else if(selectedSites.length===1){ btn.textContent=selectedSites[0]+" ▼"; } else{ btn.textContent="Multiple Sites ▼"; } }

function populateKpiDrawers(){
  function renderDrawer(kpiArr,idDrawer,idOptions,idSelectAll){
    const drawer=document.getElementById(idDrawer); const kpiDiv=document.getElementById(idOptions); let tempSelected = kpiArr.slice();
    const selectAllChk = document.getElementById(idSelectAll); selectAllChk.checked=true;
    selectAllChk.onchange=()=>{ if(selectAllChk.checked) tempSelected=kpiArr.slice(); else tempSelected=[]; renderOptions(); };
    function renderOptions(){ kpiDiv.innerHTML=""; kpiArr.forEach(kpi=>{ const checked=tempSelected.includes(kpi)?"checked":""; const div=document.createElement("div"); div.className="kpiOption"; div.innerHTML=`<input type="checkbox" class="kpiCheckbox" value="${kpi}" ${checked}> ${kpi}`; kpiDiv.appendChild(div); });
      kpiDiv.querySelectorAll(".kpiCheckbox").forEach(chk=>{ chk.onchange=()=>{ tempSelected=Array.from(kpiDiv.querySelectorAll(".kpiCheckbox:checked")).map(c=>c.value); selectAllChk.checked=tempSelected.length===kpiArr.length; }; }); }
    renderOptions(); return ()=>tempSelected.slice();
  }
  acceptanceKpisList = renderDrawer(acceptanceKpis,"acceptanceDrawer","acceptanceKpiOptions","selectAllAcceptance");
  monitoringKpisList = renderDrawer(monitoringKpis,"monitoringDrawer","monitoringKpiOptions","selectAllMonitoring");
}

document.getElementById("drawerToggle").addEventListener("click", ()=>{ const drawer = document.getElementById(currentTab+"Drawer"); if(drawer.style.display==="block"){ drawer.classList.remove("open"); setTimeout(()=>drawer.style.display="none",300); } else { drawer.style.display="block"; setTimeout(()=>drawer.classList.add("open"),10); } });
document.getElementById("applyAcceptanceBtn").addEventListener("click",()=>{ selectedAcceptanceKpis=acceptanceKpisList(); document.getElementById("acceptanceDrawer").classList.remove("open"); setTimeout(()=>document.getElementById("acceptanceDrawer").style.display="none",300); drawAcceptanceCharts(); });
document.getElementById("applyMonitoringBtn").addEventListener("click",()=>{ selectedMonitoringKpis=monitoringKpisList(); document.getElementById("monitoringDrawer").classList.remove("open"); setTimeout(()=>document.getElementById("monitoringDrawer").style.display="none",300); drawMonitoringCharts(); });

let currentTab="acceptance";
document.querySelectorAll(".tab").forEach(tab=>{ tab.addEventListener("click",()=>{ document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active")); tab.classList.add("active"); const tabName=tab.dataset.tab; document.getElementById("acceptancePage").style.display=tabName==="acceptance"?"block":"none"; document.getElementById("monitoringPage").style.display=tabName==="monitoring"?"block":"none"; currentTab=tabName; drawCurrentPageCharts(); }); });

function drawCurrentPageCharts(){ if(currentTab==="acceptance") drawAcceptanceCharts(); else drawMonitoringCharts(); }
function drawAcceptanceCharts(){ drawCharts(selectedAcceptanceKpis.length?selectedAcceptanceKpis:acceptanceKpis,"acceptanceChartContainer"); }
function drawMonitoringCharts(){ drawCharts(selectedMonitoringKpis.length?selectedMonitoringKpis:monitoringKpis,"monitoringChartContainer"); }

function drawCharts(kpis,containerId){
  const container=document.getElementById(containerId); container.innerHTML="";
  const timeline = [...new Set(allData.map(d=>d["Date"]))];
  timeline.sort((a,b)=>{ const [da,ma,ya]=a.split('/').map(Number); const [db,mb,yb]=b.split('/').map(Number); return new Date(ya,ma-1,da)-new Date(yb,mb-1,db); });
  const timelineLabels = timeline.map(d=>{ const [day,month]=d.split('/').map(Number); const monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]; return `${day} ${monthNames[month-1]}`; });
  kpis.forEach(kpi=>{
    const card=document.createElement("div"); card.className="chart-card"; const title=document.createElement("div"); title.className="chart-title";
    let labelText="All Sites"; if(selectedSites.length===1) labelText=selectedSites[0]; else if(selectedSites.length>1 && selectedSites.length<allSites.length) labelText="Multiple Sites";
    title.textContent=`${kpi} - ${labelText}`;
    const canvas=document.createElement("canvas"); card.appendChild(title); card.appendChild(canvas); container.appendChild(card);
    let filteredData=allData; if(selectedSites.length>0) filteredData=allData.filter(d=>selectedSites.includes(d["eNodeB Name"]));
    const dataPoints=timeline.map(date=>{ const vals = filteredData.filter(d=>d["Date"]===date).map(d=>{ const v=d[kpi]; return (v===""||v==null||isNaN(v))?0:v; }); if(vals.length===0) return 0; if(kpi.toLowerCase().includes("%")||kpi.toLowerCase().includes("rate")||kpi.toLowerCase().includes("average")||kpi.toLowerCase().includes("ratio")){ return vals.reduce((a,b)=>a+b,0)/vals.length; }else return vals.reduce((a,b)=>a+b,0); });
    new Chart(canvas.getContext("2d"),{ type:'line', data:{ labels:timelineLabels,datasets:[{label:labelText,data:dataPoints,borderColor:'#'+Math.floor(Math.random()*16777215).toString(16),fill:false,tension:0.3,pointRadius:3}] }, options:{ responsive:true, maintainAspectRatio:false, animation:{ x:{ type:'number', easing:'linear', duration:animationDuration, from:NaN, delay(ctx){ return ctx.index*10; } }, y:{duration:0} }, scales:{x:{display:true},y:{beginAtZero:true,ticks:{maxTicksLimit:6}}}, plugins:{legend:{position:'top'}} } });
  });
}

const siteInput=document.getElementById("siteFilter"); const dropdown=document.getElementById("dropdown");
siteInput.addEventListener("input", ()=>{ const val=siteInput.value.trim(); if(!val || !fuse){ dropdown.style.display="none"; return; } const results=fuse.search(val).slice(0,5).map(r=>r.item["eNodeB Name"]); dropdown.innerHTML=""; results.forEach(r=>{ const div=document.createElement("div"); div.textContent=r; div.onclick=()=>{ siteInput.value=r; dropdown.style.display="none"; selectedSites=[r]; document.querySelectorAll(".siteOption").forEach(c=>c.checked=c.value===r); updateSiteButtonLabel(); drawCurrentPageCharts(); }; dropdown.appendChild(div); }); dropdown.style.display=results.length?"block":"none"; });
document.addEventListener("click", e=>{ if(e.target!==siteInput) dropdown.style.display="none"; });
document.getElementById("refreshBtn").addEventListener("click", fetchData);

fetchData();
</script>

</body>
</html>
