<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NR/NSA KPI Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<style>
body { font-family:'Segoe UI', sans-serif; margin:0; padding:0; background:#f0f2f5; overflow-x:hidden; }
header { text-align:center; padding:20px 0; font-size:28px; font-weight:bold; color:#2F80ED; background:white; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:16px; }
.navbar { display:flex; justify-content:center; gap:10px; margin-bottom:16px; flex-wrap:wrap; }
.navbar button { padding:8px 16px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:bold; transition:0.2s; }
.navbar button:hover { background:#1f5ab5; }
.controls { display:flex; justify-content:center; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
#siteFilter { padding:8px; width:250px; border-radius:6px; border:1px solid #ccc; }
#siteDropdownBtn { padding:8px 10px; cursor:pointer; border:1px solid #ccc; border-radius:6px; background:white; min-width:250px; text-align:left; position:relative; z-index:5; }
#siteDropdownList { position:absolute; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; display:none; z-index:10; width:250px; border-radius:6px; padding:6px; }
button { padding:10px 18px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:bold; transition:0.2s; }
button:hover { background:#1f5ab5; }
.chart-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:20px; padding:0 20px 20px 20px; }
canvas { background:white; border-radius:12px; padding:16px; width:100% !important; height:250px !important; }
.chart-card { padding:10px; border-radius:12px; background:white; box-shadow:0 2px 12px rgba(0,0,0,0.1); transition:0.3s; }
.chart-card:hover { transform:translateY(-4px); box-shadow:0 6px 20px rgba(0,0,0,0.15); }
.chart-title { text-align:center; font-weight:bold; margin-bottom:10px; color:#333; }
</style>
</head>
<body>

<header>NR KPI Dashboard</header>

<div class="navbar">
  <button id="nrBtn">NR</button>
  <button id="nsaBtn">NSA</button>
</div>

<div class="controls">
  <input type="text" id="siteFilter" placeholder="Search Site Name">
  <button id="siteDropdownBtn">All Sites ▼</button>
  <div id="siteDropdownList"></div>
  <button id="refreshBtn">Refresh Data</button>
</div>

<div class="chart-grid" id="chartContainer"></div>

<script>
let allData=[], fuse=null, allSites=[], selectedSites=[];
let RAT="NR";
let animationDuration=150;

// ---------------- KPIs ----------------
const NR_KPIs=[
  "Average User Number",
  "SgNB Addition Success Rate (CU)",
  "SgNB TriSgNB Abnormal Release Rate",
  "SCG PSCell Change Success Rate",
  "Intra-SgNB IntraFreq PSCell Change Success Rate",
  "Intra-SgNB Pscell Change Success Rate",
  "Inter-SgNB Pscell Change Success Rate",
  "Inter-SgNB PSCell IntraFreq Change Success Rate",
  "DL Avg Latency (ms)"
];
const NSA_KPIs=[
  "RRC Re-establish Rate",
  "Avg NSA DC User Num",
  "L.Thpt.bits.DL.McgSplit.MeNB",
  "L.Thpt.bits.DL.McgSplit.SgNB",
  "L.Thpt.bits.UL.McgSplit.MeNB",
  "L.Thpt.bits.UL.McgSplit.SgNB",
  "SCG Failure Rate",
  "NSA E-RAB Drop Rate",
  "e-RAB Mod Success Rate",
  "SCG Mod Success Rate(4G initiated)",
  "SCG Mod Success Rate(5G initiated)",
  "DL RB Utilization (NSA DC)",
  "UL RB Utilization (NSA DC)",
  "User Downlink Split Average Throughput (NSA DC)",
  "User Uplink Split Average Throughput (NSA DC)"
];

function getKPIs(){ return RAT==="NR"? NR_KPIs : NSA_KPIs; }
function getSiteColumn(){ return RAT==="NR"? "gNodeB Name" : "eNodeB Name"; }

// ---------------- RAT Buttons ----------------
document.getElementById("nrBtn").onclick = ()=>{
  RAT="NR"; 
  document.getElementById("dashboardHeader").textContent = "NR KPI Dashboard";
  fetchData();
};

document.getElementById("nsaBtn").onclick = ()=>{
  RAT="NSA"; 
  document.getElementById("dashboardHeader").textContent = "NSA KPI Dashboard";
  fetchData();
};

// ---------------- Fetch CSV ----------------
async function fetchData(){
  const url = RAT==="NR" 
    ? "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=1617739873&single=true&output=csv" 
    : "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=670588387&single=true&output=csv";
  try{
    const res = await fetch(url);
    const text = await res.text();
    const rows = text.trim().split("\n").map(r=>r.split(","));
    const headers = rows.shift().map(h=>h.trim());
    allData = rows.map(r=>{
      const obj={};
      headers.forEach((h,i)=>{ const val=r[i]?r[i].trim():"0"; obj[h]=isNaN(val)?val:parseFloat(val); });
      return obj;
    });
    const siteColumn = getSiteColumn();
    fuse = new Fuse(allData,{ keys:[siteColumn], threshold:0.4 });
    allSites = [...new Set(allData.map(d=>d[siteColumn]))].sort();
    selectedSites=[];
    populateSiteDropdown();
    drawCharts();
  }catch(e){ console.error("Fetch error:", e); }
}

// ---------------- Site Dropdown ----------------
function populateSiteDropdown(){
  const list = document.getElementById("siteDropdownList"); list.innerHTML="";
  const siteColumn = getSiteColumn();

  // Select All
  const selectAllDiv = document.createElement("div");
  selectAllDiv.style.padding="6px 10px"; selectAllDiv.style.borderBottom="1px solid #ddd"; selectAllDiv.style.cursor="pointer";
  selectAllDiv.innerHTML = `<b>Select All Sites</b>`;
  selectAllDiv.onclick = () => { selectedSites=allSites.slice(); list.querySelectorAll(".siteOption").forEach(c=>c.checked=true); updateSiteButtonLabel(); drawCharts(); };
  list.appendChild(selectAllDiv);

  // Clear
  const clearDiv = document.createElement("div");
  clearDiv.style.padding="6px 10px"; clearDiv.style.borderBottom="1px solid #ddd"; clearDiv.style.cursor="pointer";
  clearDiv.innerHTML = `<b>Clear Filter</b>`;
  clearDiv.onclick = ()=>{ selectedSites=[]; list.querySelectorAll(".siteOption").forEach(c=>c.checked=false); updateSiteButtonLabel(); drawCharts(); };
  list.appendChild(clearDiv);

  allSites.forEach((site,i)=>{
    const div=document.createElement("div");
    div.innerHTML = `<input type="checkbox" class="siteOption" id="site_${i}" value="${site}"> <label for="site_${i}">${site}</label>`;
    div.style.padding="6px 10px"; list.appendChild(div);
  });

  document.getElementById("siteDropdownBtn").onclick = ()=>{ list.style.display=list.style.display==="block"?"none":"block"; };
  list.querySelectorAll(".siteOption").forEach(chk=>{
    chk.addEventListener("change", ()=>{
      selectedSites = Array.from(list.querySelectorAll(".siteOption:checked")).map(c=>c.value); 
      updateSiteButtonLabel(); drawCharts(); 
    });
  });
}
function updateSiteButtonLabel(){
  const btn=document.getElementById("siteDropdownBtn");
  if(selectedSites.length===0 || selectedSites.length===allSites.length) btn.textContent="All Sites ▼";
  else if(selectedSites.length===1) btn.textContent=selectedSites[0]+" ▼";
  else btn.textContent="Multiple Sites ▼";
}

// ---------------- Charts ----------------
function drawCharts(){
  const container=document.getElementById("chartContainer"); container.innerHTML="";
  const timeline = [...new Set(allData.map(d=>d["Date"]))].sort();
  const timelineLabels = timeline.map(d=>d);

  const KPIs=getKPIs(); 
  const siteColumn=getSiteColumn();

  KPIs.forEach(kpi=>{
    const card=document.createElement("div"); card.className="chart-card";
    const title=document.createElement("div"); title.className="chart-title";
    let labelText = selectedSites.length===1 ? selectedSites[0] : selectedSites.length>1?"Multiple Sites":"All Sites";
    title.textContent = `${kpi} - ${labelText}`;
    const canvas=document.createElement("canvas"); card.appendChild(title); card.appendChild(canvas); container.appendChild(card);

    let filteredData = selectedSites.length? allData.filter(d=>selectedSites.includes(d[siteColumn])) : allData;
    const dataPoints = timeline.map(date=>{
      const vals = filteredData.filter(d=>d["Date"]===date).map(d=>d[kpi]||0);
      if(vals.length===0) return 0;
      if(kpi.toLowerCase().includes("rate")||kpi.toLowerCase().includes("average")||kpi.toLowerCase().includes("avg")||kpi.toLowerCase().includes("utilization")||kpi.toLowerCase().includes("throughput")){
        return vals.reduce((a,b)=>a+b,0)/vals.length;
      } else return vals.reduce((a,b)=>a+b,0);
    });

    new Chart(canvas.getContext("2d"),{
      type:'line',
      data:{ labels:timelineLabels, datasets:[{label:labelText, data:dataPoints, borderColor:'#'+Math.floor(Math.random()*16777215).toString(16), fill:false, tension:0.3, pointRadius:3}] },
      options:{ responsive:true, maintainAspectRatio:false, animation:{ x:{duration:animationDuration}, y:{duration:0} }, scales:{x:{display:true},y:{beginAtZero:true}}, plugins:{legend:{position:'top'}} }
    });
  });
}

// ---------------- Fuzzy Search ----------------
const siteInput=document.getElementById("siteFilter");
const dropdown=document.getElementById("siteDropdownList");
siteInput.addEventListener("input", ()=>{
  const val=siteInput.value.trim();
  if(!val || !fuse){ dropdown.style.display="none"; return; }
  const results=fuse.search(val).slice(0,5).map(r=>r.item[getSiteColumn()]);
  dropdown.innerHTML="";
  results.forEach(r=>{
    const div=document.createElement("div"); div.textContent=r; div.style.padding="6px 10px"; div.style.cursor="pointer";
    div.onclick=()=>{ siteInput.value=r; dropdown.style.display="none"; selectedSites=[r]; updateSiteButtonLabel(); drawCharts(); };
    dropdown.appendChild(div);
  });
  dropdown.style.display=results.length?"block":"none";
});
document.addEventListener("click", e=>{ if(e.target!==siteInput) dropdown.style.display="none"; });

// ---------------- Refresh ----------------
document.getElementById("refreshBtn").addEventListener("click", fetchData);

// ---------------- Initial Load ----------------
fetchData();
</script>

</body>
</html>
