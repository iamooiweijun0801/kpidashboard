<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NR KPI Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<style>
/* --- BASE STYLES --- */
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f4f7f6; overflow-x:hidden; }
header { text-align:center; padding:15px 0; font-size:28px; font-weight:700; color:#333; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.05); margin-bottom:15px; }

/* --- NAVIGATION --- */
.navbar { display:flex; justify-content:center; gap:12px; margin-bottom:15px; }
.nav-btn { padding:8px 24px; cursor:pointer; border:1px solid #ccc; background:white; color:#555; border-radius:20px; font-weight:600; text-decoration:none; transition:0.2s; display:inline-block; }
.nav-btn:hover { background:#f0f0f0; color:#333; }
.nav-btn.active { background:#2F80ED; color:white; border-color:#2F80ED; }

/* --- TABS (Updated for NR & NSA) --- */
.tabs { display:flex; justify-content:center; margin-bottom:20px; gap:8px; }
.tab { padding:8px 20px; cursor:pointer; border-radius:6px; background:#e0e0e0; color:#555; font-weight:bold; border:none; transition:0.2s; }
.tab:hover { background:#d0d0d0; }
.tab.active { background:#2F80ED; color:white; }

/* --- CONTROLS --- */
.controls { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
.control-group { position:relative; }
input, select { padding:8px; border-radius:6px; border:1px solid #ccc; font-size:14px; outline:none; }
button.action-btn { padding:8px 16px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:600; transition:0.2s; }
button.action-btn:hover { background:#1f5ab5; }
button.ppt-btn { background:#D24726; } /* PowerPoint Orange */
button.ppt-btn:hover { background:#a8381e; }

/* --- GRID LAYOUT (3 Graphs per row) --- */
.chart-grid { 
  display:grid; 
  grid-template-columns: repeat(3, 1fr); 
  gap:20px; 
  padding:0 20px 40px 20px; 
  max-width: 1800px; 
  margin: 0 auto; 
}
@media (max-width: 1400px) { .chart-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) { .chart-grid { grid-template-columns: 1fr; } }

/* --- CARDS & CHARTS --- */
.chart-card { background:white; border-radius:8px; padding:15px; box-shadow:0 2px 8px rgba(0,0,0,0.08); display:flex; flex-direction:column; }
.chart-title { display:none; } 
.chart-container { position: relative; height: 280px; width: 100%; }

/* --- DROPDOWNS --- */
#dropdown, #siteDropdownList, #onAirDateDropdownList { 
  position:absolute; 
  background:white; 
  border:1px solid #ccc; 
  max-height:200px; 
  overflow-y:auto; 
  display:none; 
  z-index:100; 
  width:100%; 
  top:105%; 
  border-radius:6px; 
  box-shadow:0 4px 10px rgba(0,0,0,0.1); 
}
#dropdown div, #siteDropdownList div, #onAirDateDropdownList div { padding:6px 10px; cursor:pointer; font-size:13px; border-bottom:1px solid #eee; }
#dropdown div:hover, #siteDropdownList div:hover, #onAirDateDropdownList div:hover { background:#f0f7ff; color:#2F80ED; }

/* --- KPI Drawer Fixes --- */
.kpiDrawerToggle { position:fixed; top:100px; right:0; width:36px; height:36px; background:#2F80ED; color:white; border-radius:6px 0 0 6px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:20px; z-index:900; }
.kpiDrawer { 
  position:fixed; top:0; right:0; 
  width:320px; 
  height:100%; background:white; 
  box-shadow:-2px 0 10px rgba(0,0,0,0.1); z-index:1000; 
  transform:translateX(100%); transition:0.3s; padding:20px; 
  display: flex; flex-direction: column; 
}
.kpiDrawer.open { transform:translateX(0); }
.drawer-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 10px; 
    padding-bottom: 10px; 
    border-bottom: 1px solid #eee; 
}
.drawer-header h3 { margin: 0; }
.drawer-controls { 
    display: flex; 
    gap: 5px; /* Reduced gap */
    align-items: center; 
}
.drawer-controls .action-btn { 
    padding: 6px 10px; /* Smaller padding for density */
    font-size: 13px; /* Smaller font for density */
}
.kpi-options-body { flex-grow: 1; overflow-y: auto; padding-right: 5px; padding-bottom: 40px; } 

/* --- PREVIEW MODAL --- */
.modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(3px); }
.modal-content { 
    background:white; 
    width:95%; 
    max-width: 1400px; 
    height:90vh; 
    border-radius:12px; 
    display:flex; 
    flex-direction:column; 
    box-shadow:0 10px 25px rgba(0,0,0,0.3); 
}
.modal-header { padding:15px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; font-weight:bold; font-size:18px; }
.modal-body { flex:1; display: flex; padding:0; overflow: hidden; } 

/* Preview Side */
#previewBody { 
    flex: 1; 
    overflow-y:auto; 
    padding:20px; 
    background:#f5f5f5; 
}
.preview-slide { background:white; border:1px solid #ddd; margin-bottom:20px; padding:20px; box-shadow:0 2px 5px rgba(0,0,0,0.05); aspect-ratio: 16/9; position:relative; }
.preview-slide-title { position:absolute; top:10px; left:20px; font-size:16px; font-weight:bold; color:#D24726; }
.preview-grid { display:grid; height:100%; align-items:center; padding-top:30px; }
.preview-img-box { text-align:center; padding:5px; height:100%; display:flex; flex-direction:column; justify-content:center; }
.preview-img-box img { max-width:100%; max-height:calc(100% - 20px); object-fit:contain; border:1px solid #eee; }
.preview-label { display: none; } 

/* Settings Side (Fixed, not scrollable) */
#previewSettingsPanel {
    width: 250px;
    background: #fff;
    border-left: 1px solid #eee;
    padding: 20px;
    display: flex;
    flex-direction: column;
    flex-shrink: 0; 
}
.settings-group { margin-bottom: 20px; }
.settings-group h4 { margin-top: 0; margin-bottom: 10px; font-size: 14px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.graph-options button { margin: 5px; width: 100px; padding: 6px; font-size: 13px; }

/* Color Selector */
.color-option { margin: 5px; display: inline-block; cursor: pointer; border: 2px solid transparent; border-radius: 50%; width: 25px; height: 25px; transition: border 0.1s; }
.color-option.selected { border-color: #333; }

.modal-footer { 
    padding:15px 20px; 
    border-top:1px solid #eee; 
    text-align:right;
    flex-shrink: 0; 
}
</style>
</head>
<body>

<header>NR & NSA KPI Dashboard</header>

<div class="navbar">
  <a href="gsm.html" class="nav-btn">GSM</a>
  <a href="lte.html" class="nav-btn">LTE</a>
  <a href="nr.html" class="nav-btn active">NR</a>
</div>

<div class="tabs">
  <button class="tab active" onclick="switchTab('both')">All KPIs (NR & NSA)</button> 
  <button class="tab" onclick="switchTab('nr')">NR KPIs</button>
  <button class="tab" onclick="switchTab('nsa')">NSA KPIs</button>
</div>

<div class="controls">
  <div class="control-group" style="width:200px;">
    <button id="onAirDateDropdownBtn" class="action-btn" style="background:white; color:#333; border:1px solid #ccc; width:100%; text-align:left; display:flex; justify-content:space-between;">
      <span id="onAirDateBtnLabel">All On-Air Dates</span> <span>▼</span>
    </button>
    <div id="onAirDateDropdownList"></div>
  </div>

  <div class="control-group" style="width:200px;">
    <button id="siteDropdownBtn" class="action-btn" style="background:white; color:#333; border:1px solid #ccc; width:100%; text-align:left; display:flex; justify-content:space-between;">
      <span id="siteBtnLabel">All gNodeB Sites</span> <span>▼</span>
    </button>
    <div id="siteDropdownList"></div>
  </div>

  <button onclick="fetchData()" class="action-btn">Refresh</button>
  <button onclick="openPreview()" class="action-btn ppt-btn">Export PPT</button>
</div>

<div class="chart-grid" id="mainChartContainer"></div>

<div class="kpiDrawerToggle" onclick="toggleDrawer()">⚙</div>
<div id="kpiDrawer" class="kpiDrawer">
  <div class="drawer-header">
    <h3 id="drawerHeaderTitle">KPI Settings</h3>
    <div class="drawer-controls">
        <button class="action-btn" onclick="selectVisibleKpis()" style="background:#5cb85c;">Select All</button>
        <button class="action-btn" onclick="clearVisibleKpis()" style="background:#f0ad4e;">Clear All</button>
        <button class="action-btn" onclick="applyKpis()">Apply</button>
        <button onclick="toggleDrawer()" style="border:none; background:none; font-size:24px; cursor:pointer; color:#777;">✕</button>
    </div>
  </div>
  <div class="kpi-options-body" id="kpiOptionsList"></div>
</div>


<div id="previewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span id="previewTitle">PPT Export Preview</span>
      <button onclick="closePreview()" style="border:none; background:none; font-size:20px; cursor:pointer;">✕</button>
    </div>
    <div class="modal-body">
        
        <div id="previewBody">
          </div>

        <div id="previewSettingsPanel">
            <h3>Export Settings</h3>

            <div class="settings-group">
                <h4>Graphs per Slide (Rows)</h4>
                <div class="graph-options">
                    <button class="action-btn" data-count="1" onclick="updatePreviewSettings(1, chartExportColor, chartExportTitleColor)">1 Graph</button>
                    <button class="action-btn" data-count="2" onclick="updatePreviewSettings(2, chartExportColor, chartExportTitleColor)">2 Graphs</button>
                    <button class="action-btn" data-count="3" onclick="updatePreviewSettings(3, chartExportColor, chartExportTitleColor)">3 Graphs</button>
                    <button class="action-btn" data-count="4" onclick="updatePreviewSettings(4, chartExportColor, chartExportTitleColor)">4 Graphs</button>
                    <button class="action-btn" data-count="6" onclick="updatePreviewSettings(6, chartExportColor, chartExportTitleColor)">6 Graphs</button>
                    <button class="action-btn" data-count="9" onclick="updatePreviewSettings(9, chartExportColor, chartExportTitleColor)">9 Graphs</button>
                </div>
            </div>

            <div class="settings-group">
                <h4>Line & Dot Color for PPT</h4>
                <div id="lineColorOptions">
                    <span class="color-option" style="background-color:#2F80ED;" data-color="#2F80ED" onclick="updatePreviewSettings(graphsPerSlide, '#2F80ED', chartExportTitleColor)"></span>
                    <span class="color-option" style="background-color:#27AE60;" data-color="#27AE60" onclick="updatePreviewSettings(graphsPerSlide, '#27AE60', chartExportTitleColor)"></span>
                    <span class="color-option" style="background-color:#D24726;" data-color="#D24726" onclick="updatePreviewSettings(graphsPerSlide, '#D24726', chartExportTitleColor)"></span>
                    <span class="color-option" style="background-color:#8E44AD;" data-color="#8E44AD" onclick="updatePreviewSettings(graphsPerSlide, '#8E44AD', chartExportTitleColor)"></span>
                    <span class="color-option" style="background-color:#F39C12;" data-color="#F39C12" onclick="updatePreviewSettings(graphsPerSlide, '#F39C12', chartExportTitleColor)"></span>
                </div>
            </div>

            <div class="settings-group">
                <h4>Chart Title Color for PPT</h4>
                <div id="titleColorOptions">
                    <span class="color-option" style="background-color:#333333;" data-color="#333333" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#333333')"></span>
                    <span class="color-option" style="background-color:#000000;" data-color="#000000" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#000000')"></span>
                    <span class="color-option" style="background-color:#2F80ED;" data-color="#2F80ED" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#2F80ED')"></span>
                    <span class="color-option" style="background-color:#8E44AD;" data-color="#8E44AD" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#8E44AD')"></span>
                    <span class="color-option" style="background-color:#D24726;" data-color="#D24726" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#D24726')"></span>
                </div>
            </div>

            <div style="margin-top: auto; padding-top: 15px; border-top: 1px solid #eee;">
                <p style="font-size: 12px; color: #777;">Preview updates instantly.</p>
            </div>
        </div>

    </div>
    <div class="modal-footer">
      <button class="action-btn" style="background:#888;" onclick="closePreview()">Cancel</button>
      <button class="action-btn ppt-btn" onclick="downloadPPT()">Download .PPTX</button>
    </div>
  </div>
</div>

<script>
// --- CONFIG & STATE ---
let nrData = []; // NEW: NR Data
let nsaData = []; // NEW: NSA Data
let allData = []; // Combined Data for timeline/site list compatibility
let fuse = null;
let allSites = []; // Holds gNodeB Names
let siteCutoverMap = {}; // Maps gNodeB Name -> On-Air Date
let linkedSiteMap = {}; // Maps eNodeB Name -> gNodeB Name
let allOnAirDates = [];
let selectedOnAirDates = [];

let selectedSites = []; // Holds selected gNodeB Names
let currentTab = "both"; // 'both', 'nr', 'nsa'
let graphsPerSlide = 2;	

let chartExportColor = '#2F80ED'; 
let chartExportTitleColor = '#333333'; 

// NR KPIs (Acceptance category from your original code)
const nrKpis = [
  "NSA Average User Number","SgNB Addition Success Rate (CU)(%)","SgNB TriSgNB Abnormal Release Rate(%)","SCG PSCell Change Success Rate(%)","Intra-SgNB IntraFreq PSCell Change Success Rate(%)",
  "Intra-SgNB Pscell Change Success Rate(%)","Inter-SgNB Pscell Change Success Rate(%)","Inter-SgNB PSCell IntraFreq Change Success Rate(%)","DL Avg Latency (ms)"
];

// NSA KPIs (Example list for the NSA tab - you need to populate this based on your data)
const nsaKpis = [
  "RRC Re-establish Rate(%)","Avg NSA DC User Num","L.Thpt.bits.DL.McgSplit.MeNB","L.Thpt.bits.DL.McgSplit.SgNB",
  "L.Thpt.bits.UL.McgSplit.MeNB","L.Thpt.bits.UL.McgSplit.SgNB","SCG Failure Rate(%)","NSA E-RAB Drop Rate(%)",
  "e-RAB Mod Success Rate(%)","SCG Mod Success Rate(4G initiated)(%)","SCG Mod Success Rate(5G initiated)(%)",
  "DL RB Utilization (NSA DC)(%)","UL RB Utilization (NSA DC)(%)","User Downlink Split Average Throughput (NSA DC)",
  "User Uplink Split Average Throughput (NSA DC)"
];


let selectedKpis = {
  nr: [...nrKpis],
  nsa: [...nsaKpis]
};

// --- GLOBAL UTILITY FUNCTIONS ---

/**
 * Switches the active tab (NR, NSA, All).
 * @param {string} tab - The tab identifier ('nr', 'nsa', 'both').
 */
function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
    currentTab = tab;
    renderCharts(); 
}

// --- NEW HELPER FUNCTION TO PARSE CSV ---
/**
 * Fetches and parses a single Google Sheet CSV URL.
 * @param {string} url - The public CSV export URL.
 * @returns {Promise<Array<Object>>} - An array of objects with header keys.
 */
async function fetchAndParse(url) {
    const res = await fetch(url);
    const text = await res.text();
    const rows = text.trim().split('\n').map(r => r.split(','));
    const headers = rows.shift().map(h => h.trim());

    return rows.map(r => {
        const obj = {};
        headers.forEach((h, i) => {
            const val = r[i] ? r[i].trim() : "";
            obj[h] = val === "" ? null : (isNaN(val) ? val : parseFloat(val));
        });
        return obj;
    });
}


// --- UPDATED DATA FETCHING & MAPPING (Loads 3 Sheets) ---
async function fetchData(){
  try {
    // --- 1. Define URLs for the three distinct sheets ---
    // GID 1930867305 (Assumed NR KPI Data)
    const nrUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=1930867305&single=true&output=csv&t=" + Date.now();
    
    // !!! CRITICAL: REPLACE YOUR_NSA_GID_HERE with the GID for your NSA KPI data sheet !!!
    const nsaUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=670588387&single=true&output=csv&t=" + Date.now(); 

    // GID 19616562 (Confirmed Cutover/Mapping Data)
    const cutoverUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=19616562&single=true&output=csv&t=" + Date.now();
    
    
    // --- 2. Fetch all three data sets concurrently using the helper ---
    const [cutoverRawData, nrRawData, nsaRawData] = await Promise.all([
        fetchAndParse(cutoverUrl),
        fetchAndParse(nrUrl),
        fetchAndParse(nsaUrl)
    ]);

    // Store separate and combined data
    nrData = nrRawData;
    nsaData = nsaRawData;
    allData = [...nrData, ...nsaData]; // Combine for full timeline and site list generation

    // Determine all gNodeB sites present in the NR data
    allSites = [...new Set(nrData.map(d=>d["gNodeB Name"]))].filter(s=>s).sort();

    // --- 3. Process Cutover Data for Mapping/Dates ---
    siteCutoverMap = {};
    linkedSiteMap = {}; // eNodeB Name -> gNodeB Name
    cutoverRawData.forEach(r => {
        // Check for required headers and existence
        const gNodeB = r["gNodeB Name"];
        const eNodeB = r["eNodeB Name"];
        const onAirDate = r["On-Air Date"];
        
        if (gNodeB && onAirDate && allSites.includes(gNodeB)) {
            siteCutoverMap[gNodeB] = onAirDate;
        }
        // Create the link: NSA site (eNodeB) is linked to NR site (gNodeB)
        if (eNodeB && gNodeB) {
            linkedSiteMap[eNodeB] = gNodeB;
        }
    });


    // 4. Initialize Date Filter Options and State
    allOnAirDates = [...new Set(Object.values(siteCutoverMap))].filter(d => d).sort();
    selectedOnAirDates = [...allOnAirDates]; // Default: Select All Dates
    selectedSites = []; // Reset site selection

    // 5. Update UI
    setupOnAirDateDropdown();
    setupSiteDropdown();
    renderCharts();

  } catch(e) { console.error(e); alert("Failed to load data. Please ensure your 3 Google Sheets are published as CSV and links are correct."); }
}

// --- FILTER UI LOGIC (ON-AIR DATE) - UNCHANGED FOR SIMPLICITY ---

function setupOnAirDateDropdown(){
  const list = document.getElementById("onAirDateDropdownList");
  const btn = document.getElementById("onAirDateDropdownBtn");
  list.innerHTML = "";
  
  const setAll = () => { 
    selectedOnAirDates = [...allOnAirDates]; 
    // When All Dates are selected, all sites MUST be selected as well
    const allActiveSites = allSites.filter(site => siteCutoverMap[site] && allOnAirDates.includes(siteCutoverMap[site]));
    selectedSites = [...allActiveSites]; 

    // Update UI but DO NOT close the dropdown
    updateDateFilterUI({close: false}); 
    setupSiteDropdown(); // This re-renders charts
  };

  const clearAll = () => { 
    selectedOnAirDates = []; 
    // When All Dates are cleared, all sites MUST be cleared
    selectedSites = []; 
    
    // Update UI but DO NOT close the dropdown
    updateDateFilterUI({close: false}); 
    setupSiteDropdown(); 
  };
  
  // Actions
  list.innerHTML += `<div onclick="window.dateSetAll()"><b>Select All</b></div>`;
  list.innerHTML += `<div onclick="window.dateClearAll()"><b>Clear All</b></div>`;

  // Options
  allOnAirDates.forEach(date => {
    const d = document.createElement("div");
    const checked = selectedOnAirDates.includes(date) ? "checked" : "";
    d.innerHTML = `<input type='checkbox' value='${date}' class='date-chk' ${checked}> ${date}`;
    d.onclick = (e) => {
       if(e.target.tagName !== "INPUT") {
          const chk = d.querySelector("input");
          chk.checked = !chk.checked;
       }
       updateSelectedDates(); // Individual selection
    };
    list.appendChild(d);
  });
  
  btn.onclick = () => list.style.display = list.style.display==="block" ? "none" : "block";
  
  // Expose helpers globally for inline HTML
  window.dateSetAll = setAll;
  window.dateClearAll = clearAll;
  updateDateFilterUI({close: true}); // Initial UI update
}

function updateSelectedDates() {
    const list = document.getElementById("onAirDateDropdownList");
    selectedOnAirDates = Array.from(list.querySelectorAll(".date-chk:checked")).map(c => c.value);
    
    // Update the sites based on the new dates (select all sites under the new date scope)
    let activeSites = allSites.filter(site => {
        const date = siteCutoverMap[site];
        return date && selectedOnAirDates.includes(date);
    });
    selectedSites = [...activeSites]; 
    
    // Do not close dropdown on individual check
    updateDateFilterUI({close: false}); 
    setupSiteDropdown(); 
}

function updateDateFilterUI(options = {close: true}) {
    const btn = document.getElementById("onAirDateDropdownBtn");
    const span = document.getElementById("onAirDateBtnLabel");
    const list = document.getElementById("onAirDateDropdownList");
    
    span.textContent = selectedOnAirDates.length === 0 ? "No Dates Selected" : (selectedOnAirDates.length === allOnAirDates.length ? "All On-Air Dates" : `Selected (${selectedOnAirDates.length})`);
    
    // Update checkboxes visually
    list.querySelectorAll(".date-chk").forEach(c => c.checked = selectedOnAirDates.includes(c.value));
    
    // Close dropdown only if requested
    if (options.close) {
        list.style.display = "none";
    } else {
        // If not closing, ensure it's open
        list.style.display = "block";
    }
}

// --- FILTER UI LOGIC (gNodeB Name) - UNCHANGED FOR SIMPLICITY ---

function setupSiteDropdown(){
  const list = document.getElementById("siteDropdownList");
  const btn = document.getElementById("siteDropdownBtn");
  list.innerHTML = "";

  // 1. Determine which gNodeB sites are active based on the date filter
  let activeSites = allSites.filter(site => {
      const date = siteCutoverMap[site];
      return date && selectedOnAirDates.includes(date);
  });
  
  // 2. Filter selectedSites to only include those that are currently active
  selectedSites = selectedSites.filter(site => activeSites.includes(site));
  
  // Actions
  const setAll = () => { 
    selectedSites = [...activeSites]; 
    updateSiteFilterUI({close: false}); 
    renderCharts();
  }; 

  const clearAll = () => { 
    selectedSites = []; 
    updateSiteFilterUI({close: false}); 
    renderCharts(); 
  };
  
  // Inject setAll/clearAll actions
  list.innerHTML += `<div onclick="window.siteSetAll()"><b>Select All (${activeSites.length})</b></div>`;
  list.innerHTML += `<div onclick="window.siteClearAll()"><b>Clear All</b></div>`;

  // Options
  activeSites.forEach(site => {
    const d = document.createElement("div");
    // Check if the site is in the current selectedSites list
    const checked = selectedSites.includes(site) ? "checked" : ""; 
    d.innerHTML = `<input type='checkbox' value='${site}' class='site-chk' ${checked}> ${site}`;
    d.onclick = (e) => {
       if(e.target.tagName !== "INPUT") {
          const chk = d.querySelector("input");
          chk.checked = !chk.checked;
       }
       updateSelectedSites(); // Individual selection
    };
    list.appendChild(d);
  });
  
  btn.onclick = () => list.style.display = list.style.display==="block" ? "none" : "block";

  // Expose helpers globally for inline HTML
  window.siteSetAll = setAll;
  window.siteClearAll = clearAll;
  
  // Initial UI update for site dropdown and rendering
  updateSiteFilterUI({close: true});
  renderCharts();
}

function updateSelectedSites() {
    const list = document.getElementById("siteDropdownList");
    // Ensure we only look at the sites currently visible/active in the list
    selectedSites = Array.from(list.querySelectorAll(".site-chk:checked")).map(c => c.value);
    // Do not close dropdown on individual check
    updateSiteFilterUI({close: false});
    renderCharts();
}

function updateSiteFilterUI(options = {close: true}) {
    const btn = document.getElementById("siteDropdownBtn");
    const span = document.getElementById("siteBtnLabel");
    const list = document.getElementById("siteDropdownList");
    
    let activeSites = allSites.filter(site => {
        const date = siteCutoverMap[site];
        return selectedOnAirDates.includes(date);
    });

    if(selectedSites.length === 0) span.textContent = "All Active Sites";
    else if(selectedSites.length === activeSites.length) span.textContent = `All Active Sites (${selectedSites.length})`;
    else if(selectedSites.length === 1) span.textContent = selectedSites[0];
    else span.textContent = `Selected (${selectedSites.length})`;

    // Re-check all site checkboxes to reflect the selectedSites state 
    list.querySelectorAll(".site-chk").forEach(c => c.checked = selectedSites.includes(c.value));
    
    // Close dropdown only if requested
    if (options.close) {
        list.style.display = "none";
    } else {
        // If not closing, ensure it's open
        list.style.display = "block";
    }
}

// --- UPDATED CHART RENDERING (OPTIMIZED FOR NR/NSA SEPARATION) ---

function renderCharts(){
  const container = document.getElementById("mainChartContainer");
  container.innerHTML = "";
  
  let kpisToShow = [];
  if(currentTab === "nr") kpisToShow = selectedKpis.nr.map(k => ({kpi: k, type: 'nr'}));
  else if(currentTab === "nsa") kpisToShow = selectedKpis.nsa.map(k => ({kpi: k, type: 'nsa'}));
  else if(currentTab === "both") kpisToShow = [
    ...selectedKpis.nr.map(k => ({kpi: k, type: 'nr'})),
    ...selectedKpis.nsa.map(k => ({kpi: k, type: 'nsa'}))
  ];

  // 1. Determine final list of gNodeB sites based on date filter AND site filter
  let sitesFromDate = allSites.filter(site => {
      const date = siteCutoverMap[site];
      return selectedOnAirDates.includes(date);
  });

  let finalGNodeBList;
  if (selectedSites.length > 0) {
      finalGNodeBList = selectedSites;
  } else {
      finalGNodeBList = sitesFromDate;
  }
  
  // 2. Determine the corresponding eNodeB sites for the filter
  const finalENodeBList = Object.keys(linkedSiteMap).filter(eNodeB => 
      finalGNodeBList.includes(linkedSiteMap[eNodeB])
  );
  
  // 3. Pre-filter the data by selected sites only once (using the separate arrays)
  const filteredNRData = nrData.filter(d => finalGNodeBList.includes(d["gNodeB Name"]));
  const filteredNSAData = nsaData.filter(d => finalENodeBList.includes(d["eNodeB Name"]));
  const combinedFilteredData = [...filteredNRData, ...filteredNSAData];


  // 4. Process Timeline - Use the combined filtered data for date range
  const timeline = [...new Set(combinedFilteredData.map(d=>d["Date"]))].filter(d => d).sort((a,b)=>{
    const [da,ma,ya]=a.split('/').map(Number);
    const [db,mb,yb]=b.split('/').map(Number);
    return new Date(ya,ma-1,da)-new Date(yb,mb-1,db);
  });

  const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
  const timelineLabels = timeline.map(d => {
      const [day, month] = d.split('/').map(Number);
      return `${day} ${monthNames[month - 1]}`; // e.g., "5 Jan"
  });

  // 5. Generate Charts
  kpisToShow.forEach((kpiInfo, idx) => {
    const { kpi, type } = kpiInfo;
    
    const card = document.createElement("div");
    card.className = "chart-card";
    
    const wrapper = document.createElement("div");
    wrapper.className = "chart-container";
    
    const canvas = document.createElement("canvas");
    canvas.id = `chart_${idx}`;
    
    wrapper.appendChild(canvas);
    card.appendChild(wrapper);
    container.appendChild(card);

    // Get the correct data source for aggregation
    const sourceData = (type === 'nr') ? filteredNRData : filteredNSAData;
    const filteredSiteList = (type === 'nr') ? finalGNodeBList : finalENodeBList;


    // Calculate Data
    const dataPoints = timeline.map(date => {
      const values = sourceData
        .filter(d => d["Date"] === date)
        .map(d => Number(d[kpi]))
        .filter(v => !isNaN(v));

      if(values.length === 0) return null;

      const avg = values.reduce((a,b) => a+b, 0) / values.length;
      return avg;
    });

    let validValues = dataPoints.filter(v => v !== null);
    let minVal = Math.min(...validValues);
    let maxVal = Math.max(...validValues);

    // Special rule: if min >= 95 and max <= 100, set scale explicitly (for percentage metrics)
    if(kpi.includes('Success Rate') || kpi.includes('%')) {
        if(minVal >= 95 && maxVal <= 100) {
            minVal = 95;
            maxVal = 100;
        } else {
            minVal = Math.floor(minVal / 5) * 5;
            maxVal = Math.ceil(maxVal / 5) * 5;
        }
    } else {
        // Generic scaling logic for non-percentage KPIs
        if (validValues.length > 0) {
            minVal = Math.floor(minVal * 0.95); // 5% buffer below min
            maxVal = Math.ceil(maxVal * 1.05); // 5% buffer above max
        } else {
            minVal = 0; maxVal = 100;
        }
    }

    // Draw Chart with Animation
    new Chart(canvas.getContext("2d"), {
      type: 'line',
      data: {
        labels: timelineLabels,
        datasets: [{
          label: (filteredSiteList.length > 0 && dataPoints.some(p => p !== null)) ? `${type.toUpperCase()} Aggregate` : "No Data",
          data: dataPoints,
          borderColor: getRandomColor(),
          backgroundColor: 'transparent',
          borderWidth: 2,
          pointRadius: 3,
          tension: 0.1,
          spanGaps: true 
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
            x: {
                type: 'number',
                easing: 'linear',
                duration: 500,
                from: NaN,
                delay: (ctx) => ctx.index * 30 
            },
            y: { duration: 0 }
        },
        plugins: { 
            legend: { display: false },
            title: { // Chart.js built-in title
                display: true,
                text: kpi,
                font: {
                    size: 14,
                    weight: 'bold'
                },
                color: '#333'
            }
        },
        scales: {
           x: { 
               ticks: { font: {size:8} }, 
               grid: {display:false} 
           },
           y: { 
               beginAtZero: false, 
               grid: {color:'#eee'},
               min: (filteredSiteList.length === 0 || dataPoints.every(p => p === null)) ? 0 : minVal,
               max: (filteredSiteList.length === 0 || dataPoints.every(p => p === null)) ? 100 : maxVal
           }
        }
      }
    });
  });
}

function getRandomColor() {
  const colors = ['#2F80ED', '#27AE60', '#D24726', '#8E44AD', '#F39C12', '#2980B9'];
  return colors[Math.floor(Math.random() * colors.length)];
}

// --- KPI DRAWER & UTILITY LOGIC (UPDATED FOR NR/NSA) ---

function toggleDrawer(){
  const d = document.getElementById("kpiDrawer");
  d.classList.toggle("open");
  if(d.classList.contains("open")) populateKpiOptions();
}

function populateKpiOptions(){
  const list = document.getElementById("kpiOptionsList");
  list.innerHTML = "";
  
  document.getElementById('drawerHeaderTitle').textContent = 'KPI Settings';

  const nrSection = currentTab === 'nr' || currentTab === 'both';
  const nsaSection = currentTab === 'nsa' || currentTab === 'both';
  
  const createGroup = (title, key, sourceArr) => {
    const h4 = document.createElement("h4");
    h4.textContent = title;
    h4.style.marginTop = "15px";
    list.appendChild(h4);
    
    sourceArr.forEach(kpi => {
      const div = document.createElement("div");
      const checked = selectedKpis[key].includes(kpi) ? "checked" : "";
      div.innerHTML = `<input type='checkbox' class='kpi-chk' data-group='${key}' value='${kpi}' ${checked}> <span style='font-size:13px'>${kpi}</span>`;
      div.onclick = (e) => {
        if(e.target.tagName !== "INPUT") {
            const chk = div.querySelector("input");
            chk.checked = !chk.checked;
        }
        // No auto-apply here, user must click Apply
      };
      list.appendChild(div);
    });
  };

  if (nrSection) createGroup("NR KPIs", "nr", nrKpis);
  if (nsaSection) createGroup("NSA KPIs", "nsa", nsaKpis);
}

/**
 * Selects all visible KPI checkboxes and updates the internal state.
 */
function selectVisibleKpis() {
    const chks = document.getElementById("kpiOptionsList").querySelectorAll(".kpi-chk");
    chks.forEach(c => c.checked = true);
    applyKpis(false); // Apply but do not close
}

/**
 * Clears all visible KPI checkboxes and updates the internal state.
 */
function clearVisibleKpis() {
    const chks = document.getElementById("kpiOptionsList").querySelectorAll(".kpi-chk");
    chks.forEach(c => c.checked = false);
    applyKpis(false); // Apply but do not close
}

/**
 * Applies the selected KPIs to the global state and re-renders charts.
 */
function applyKpis(shouldClose = true) {
    const newSelectedKpis = { nr: [], nsa: [] };
    const chks = document.getElementById("kpiOptionsList").querySelectorAll(".kpi-chk:checked");
    
    chks.forEach(c => {
        const group = c.getAttribute('data-group');
        newSelectedKpis[group].push(c.value);
    });
    
    selectedKpis = newSelectedKpis;
    renderCharts();

    if (shouldClose) toggleDrawer();
}


// --- PPT EXPORT LOGIC (UNCHANGED, relies on renderCharts structure) ---

function openPreview() {
    if (document.getElementById('mainChartContainer').children.length === 0) {
        alert("Please fetch data and select KPIs before exporting.");
        return;
    }
    // Reset settings to default if needed, then render preview
    updatePreviewSettings(2, chartExportColor, chartExportTitleColor);
    document.getElementById('previewModal').style.display = 'flex';
}

function closePreview() {
    document.getElementById('previewModal').style.display = 'none';
}

function updatePreviewSettings(count, lineColor, titleColor) {
    graphsPerSlide = count;
    chartExportColor = lineColor;
    chartExportTitleColor = titleColor;

    // Update active button/color indicators
    document.querySelectorAll('.graph-options button').forEach(btn => {
        btn.classList.remove('active');
        if (parseInt(btn.dataset.count) === count) btn.classList.add('active');
    });
    document.querySelectorAll('#lineColorOptions .color-option').forEach(span => {
        span.classList.remove('selected');
        if (span.dataset.color === lineColor) span.classList.add('selected');
    });
    document.querySelectorAll('#titleColorOptions .color-option').forEach(span => {
        span.classList.remove('selected');
        if (span.dataset.color === titleColor) span.classList.add('selected');
    });

    renderPreview();
}

async function renderPreview() {
    const previewBody = document.getElementById('previewBody');
    previewBody.innerHTML = '';
    const charts = Array.from(document.querySelectorAll('.chart-card canvas'));
    
    if (charts.length === 0) return;

    for (let i = 0; i < charts.length; i += graphsPerSlide) {
        const slide = document.createElement('div');
        slide.className = 'preview-slide';
        
        const slideTitle = document.createElement('div');
        slideTitle.className = 'preview-slide-title';
        slideTitle.textContent = `Slide ${Math.ceil((i + 1) / graphsPerSlide)}/${Math.ceil(charts.length / graphsPerSlide)}`;
        slide.appendChild(slideTitle);

        const grid = document.createElement('div');
        grid.className = 'preview-grid';
        
        let cols = 1;
        if (graphsPerSlide === 2 || graphsPerSlide === 4 || graphsPerSlide === 6) cols = 2;
        if (graphsPerSlide === 3 || graphsPerSlide === 9) cols = 3;
        
        // Adjust grid template columns based on the number of graphs per slide
        grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        grid.style.gridTemplateRows = `repeat(${Math.ceil(graphsPerSlide / cols)}, 1fr)`;
        
        const chartsOnSlide = charts.slice(i, i + graphsPerSlide);
        
        for (const chartCanvas of chartsOnSlide) {
            const imgBox = document.createElement('div');
            imgBox.className = 'preview-img-box';

            const base64Image = await exportChartToImage(chartCanvas);
            const img = document.createElement('img');
            img.src = base64Image;
            img.alt = chartCanvas.chart.options.plugins.title.text;

            const label = document.createElement('div');
            label.className = 'preview-label';
            label.textContent = chartCanvas.chart.options.plugins.title.text;

            imgBox.appendChild(img);
            imgBox.appendChild(label);
            grid.appendChild(imgBox);
        }
        
        slide.appendChild(grid);
        previewBody.appendChild(slide);
    }
}

async function exportChartToImage(chartCanvas) {
    // Get the current chart instance from the canvas
    const chart = chartCanvas.chart;
    
    // Temporarily override chart options for high-quality PPTX export
    const originalOptions = JSON.parse(JSON.stringify(chart.options)); // Deep copy
    const originalData = JSON.parse(JSON.stringify(chart.data));
    
    // Apply export customizations
    chart.options.plugins.title.color = chartExportTitleColor;
    chart.data.datasets.forEach(dataset => {
        dataset.borderColor = chartExportColor;
        dataset.pointBackgroundColor = chartExportColor;
        dataset.pointBorderColor = '#fff';
        dataset.pointRadius = 5; 
    });
    chart.options.scales.x.ticks.color = '#555';
    chart.options.scales.y.ticks.color = '#555';
    chart.options.scales.y.grid.color = '#ddd';

    // Force update the chart before generating image
    chart.update();

    // Generate the image (PNG for best quality in PPTX)
    const base64Image = chartCanvas.toDataURL('image/png', 1.0);

    // Restore original options to maintain dashboard appearance
    chart.options = originalOptions;
    chart.data = originalData;
    chart.update();
    
    return base64Image;
}


async function downloadPPT() {
    const pptx = new PptxGenJS();
    pptx.layout = 'LAYOUT_16X9';
    
    const charts = Array.from(document.querySelectorAll('.chart-card canvas'));
    const slides = [];
    
    // 1. Generate all images with custom PPT settings first
    for (const chartCanvas of charts) {
        const base64Image = await exportChartToImage(chartCanvas);
        slides.push({ 
            title: chartCanvas.chart.options.plugins.title.text,
            base64: base64Image 
        });
    }

    // 2. Create PPTX Slides
    for (let i = 0; i < slides.length; i += graphsPerSlide) {
        const slide = pptx.addSlide();
        slide.background = { fill: 'FFFFFF' };
        
        const chartsOnSlide = slides.slice(i, i + graphsPerSlide);
        
        let cols = 1;
        let rows = 1;
        let w = 9.5; // full width
        let h = 5.0; // max height

        if (graphsPerSlide === 2) { cols = 2; rows = 1; w = 4.7; h = 5.0; }
        else if (graphsPerSlide === 3) { cols = 3; rows = 1; w = 3.15; h = 5.0; }
        else if (graphsPerSlide === 4) { cols = 2; rows = 2; w = 4.7; h = 2.5; }
        else if (graphsPerSlide === 6) { cols = 3; rows = 2; w = 3.15; h = 2.5; }
        else if (graphsPerSlide === 9) { cols = 3; rows = 3; w = 3.15; h = 1.66; }

        const margin = 0.25;
        
        chartsOnSlide.forEach((chartData, chartIndex) => {
            const colIndex = chartIndex % cols;
            const rowIndex = Math.floor(chartIndex / cols);
            
            slide.addImage({
                data: chartData.base64,
                x: margin + (colIndex * w) + (colIndex * margin/2),
                y: margin * 2 + (rowIndex * h) + (rowIndex * margin),
                w: w,
                h: h,
                sizing: { type: 'contain', w: w, h: h }
            });
        });
    }

    // Final download
    const now = new Date();
    const fileName = `NR_NSA_KPI_Dashboard_${now.getFullYear()}${String(now.getMonth()+1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.pptx`;
    pptx.writeFile({ fileName: fileName }).then(closePreview);
}

// --- INIT ---
document.addEventListener("DOMContentLoaded", fetchData);

</script>
</body>
</html>
