<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>NR & NSA KPI Dashboard (fixed - eNodeB only)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
<style>
/* Minimal CSS kept from your previous file (cleaned) */
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f4f7f6; }
header { text-align:center; padding:15px 0; font-size:28px; font-weight:700; color:#333; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.05); margin-bottom:15px; }
.navbar { display:flex; justify-content:center; gap:12px; margin-bottom:15px; }
.nav-btn { padding:8px 24px; cursor:pointer; border-radius:20px; border:1px solid #ccc; background:white; color:#555; text-decoration:none; font-weight:600; }
.nav-btn.active { background:#2F80ED; color:white; border-color:#2F80ED; }
.tabs { display:flex; justify-content:center; gap:8px; margin-bottom:20px; }
.tab { padding:8px 20px; cursor:pointer; border-radius:6px; background:#e0e0e0; color:#555; font-weight:bold; border:none; }
.tab.active { background:#2F80ED; color:white; }
.controls { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
.control-group { position:relative; }
button.action-btn { padding:8px 16px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:600; }
button.ppt-btn { background:#D24726; color:white; }
.chart-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; padding:0 20px 40px 20px; max-width:1800px; margin:0 auto; }
@media (max-width:1400px){ .chart-grid{ grid-template-columns: repeat(2,1fr);} }
@media (max-width:768px){ .chart-grid{ grid-template-columns: 1fr; } }
.chart-card { background:white; border-radius:8px; padding:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); display:flex; flex-direction:column; }
.chart-container { position:relative; height:280px; width:100%; }
#dropdown,#siteDropdownList,#onAirDateDropdownList { position:absolute; background:white; border:1px solid #ccc; max-height:240px; overflow-y:auto; display:none; z-index:200; width:100%; top:105%; border-radius:6px; box-shadow:0 4px 10px rgba(0,0,0,0.08); }
#dropdown div,#siteDropdownList div,#onAirDateDropdownList div { padding:6px 10px; cursor:pointer; border-bottom:1px solid #eee; }
.kpiDrawerToggle { position:fixed; top:100px; right:0; width:36px; height:36px; background:#2F80ED; color:white; border-radius:6px 0 0 6px; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:900; }
.kpiDrawer { position:fixed; top:0; right:0; width:320px; height:100%; background:white; box-shadow:-2px 0 10px rgba(0,0,0,0.1); transform:translateX(100%); transition:0.3s; padding:20px; display:flex; flex-direction:column; z-index:1000; }
.kpiDrawer.open { transform:translateX(0); }
.kpi-options-body { flex:1; overflow:auto; padding-right:6px; }
.modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:2000; }
.modal-content { width:95%; max-width:1200px; height:85vh; background:#fff; border-radius:12px; display:flex; flex-direction:column; overflow:hidden; }
.modal-body { display:flex; flex:1; overflow:hidden; }
#previewBody { flex:1; overflow:auto; padding:20px; background:#f5f5f5; }
#previewSettingsPanel { width:260px; background:#fff; border-left:1px solid #eee; padding:18px; }
.preview-slide { background:#fff; border:1px solid #ddd; margin-bottom:18px; padding:14px; box-shadow:0 2px 5px rgba(0,0,0,0.05); aspect-ratio:16/9; position:relative; }
.preview-grid { display:grid; gap:10px; height:100%; align-items:center; }
.preview-img-box { display:flex; align-items:center; justify-content:center; background:#fff; padding:8px; border-radius:6px; }
.color-option { width:25px; height:25px; border-radius:50%; display:inline-block; margin-right:6px; cursor:pointer; border:2px solid transparent; }
.color-option.selected{ border-color:#333; }
.modal-footer { padding:12px; border-top:1px solid #eee; text-align:right; }
</style>
</head>
<body>
<header>NR & NSA KPI Dashboard</header>

<div class="navbar">
  <a class="nav-btn" href="gsm.html">GSM</a>
  <a class="nav-btn" href="index.html">LTE</a>
  <a class="nav-btn active" href="nr.html">NR</a>
</div>

<div class="tabs">
  <button class="tab active" onclick="switchTab('both')">All KPIs (NR & NSA)</button>
  <button class="tab" onclick="switchTab('nr')">NR KPIs</button>
  <button class="tab" onclick="switchTab('nsa')">NSA KPIs</button>
</div>

<div class="controls">
  <div class="control-group" style="width:220px;">
    <button id="onAirDateDropdownBtn" class="action-btn" style="background:white;color:#333;border:1px solid #ccc;width:100%;text-align:left;display:flex;justify-content:space-between;">
      <span id="onAirDateBtnLabel">All On-Air Dates</span><span>▼</span>
    </button>
    <div id="onAirDateDropdownList"></div>
  </div>

  <div class="control-group" style="width:220px;">
    <button id="siteDropdownBtn" class="action-btn" style="background:white;color:#333;border:1px solid #ccc;width:100%;text-align:left;display:flex;justify-content:space-between;">
      <span id="siteBtnLabel">All Sites</span><span>▼</span>
    </button>
    <div id="siteDropdownList"></div>
  </div>

  <button class="action-btn" onclick="fetchData()">Refresh</button>
  <button class="action-btn ppt-btn" onclick="openPreview()">Export PPT</button>
</div>

<div class="chart-grid" id="mainChartContainer"></div>

<div class="kpiDrawerToggle" onclick="toggleDrawer()">⚙</div>
<div id="kpiDrawer" class="kpiDrawer">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <h3 style="margin:0;">KPI Settings</h3>
    <div>
      <button class="action-btn" onclick="selectVisibleKpis()" style="background:#5cb85c;margin-right:6px;">Select All</button>
      <button class="action-btn" onclick="clearVisibleKpis()" style="background:#f0ad4e;">Clear All</button>
    </div>
  </div>
  <div class="kpi-options-body" id="kpiOptionsList"></div>
  <div style="padding-top:8px;">
    <button class="action-btn" onclick="applyKpis()">Apply</button>
    <button class="action-btn" style="background:#888;margin-left:8px;" onclick="toggleDrawer()">Close</button>
  </div>
</div>

<div id="previewModal" class="modal">
  <div class="modal-content">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #eee;">
      <strong id="previewTitle">PPT Export Preview</strong>
      <button onclick="closePreview()" style="border:none;background:none;font-size:20px;cursor:pointer;">✕</button>
    </div>

    <div class="modal-body">
      <div id="previewBody"></div>
      <div id="previewSettingsPanel">
        <h4 style="margin-top:0;">Export Settings</h4>
        <div style="margin-bottom:12px;">
          <label><strong>Graphs per Slide</strong></label>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;">
            <button class="action-btn" data-count="1" onclick="updatePreviewSettings(1, chartExportColor, chartExportTitleColor)">1</button>
            <button class="action-btn" data-count="2" onclick="updatePreviewSettings(2, chartExportColor, chartExportTitleColor)">2</button>
            <button class="action-btn" data-count="3" onclick="updatePreviewSettings(3, chartExportColor, chartExportTitleColor)">3</button>
            <button class="action-btn" data-count="4" onclick="updatePreviewSettings(4, chartExportColor, chartExportTitleColor)">4</button>
            <button class="action-btn" data-count="6" onclick="updatePreviewSettings(6, chartExportColor, chartExportTitleColor)">6</button>
            <button class="action-btn" data-count="9" onclick="updatePreviewSettings(9, chartExportColor, chartExportTitleColor)">9</button>
          </div>
        </div>

        <div style="margin-bottom:12px;">
          <label><strong>Line Color</strong></label>
          <div style="display:flex;gap:6px;margin-top:8px;">
            <span class="color-option" style="background:#2F80ED" data-color="#2F80ED" onclick="updatePreviewSettings(graphsPerSlide, '#2F80ED', chartExportTitleColor)"></span>
            <span class="color-option" style="background:#27AE60" data-color="#27AE60" onclick="updatePreviewSettings(graphsPerSlide, '#27AE60', chartExportTitleColor)"></span>
            <span class="color-option" style="background:#D24726" data-color="#D24726" onclick="updatePreviewSettings(graphsPerSlide, '#D24726', chartExportTitleColor)"></span>
            <span class="color-option" style="background:#8E44AD" data-color="#8E44AD" onclick="updatePreviewSettings(graphsPerSlide, '#8E44AD', chartExportTitleColor)"></span>
          </div>
        </div>

        <div>
          <label><strong>Title Color</strong></label>
          <div style="display:flex;gap:6px;margin-top:8px;">
            <span class="color-option" style="background:#333333" data-color="#333333" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#333333')"></span>
            <span class="color-option" style="background:#D24726" data-color="#D24726" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#D24726')"></span>
            <span class="color-option" style="background:#2F80ED" data-color="#2F80ED" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#2F80ED')"></span>
          </div>
        </div>

      </div>
    </div>

    <div class="modal-footer">
      <button class="action-btn" style="background:#888" onclick="closePreview()">Cancel</button>
      <button class="action-btn ppt-btn" onclick="downloadPPT()">Download .PPTX</button>
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG / STATE
   ========================= */
let nrData = [];
let nsaData = [];
let allSites = [];
let siteCutoverMap = {};      // eNodeB Name -> On-Air Date
let allOnAirDates = [];
let selectedOnAirDates = [];
let selectedSites = [];
let currentTab = 'both';
let graphsPerSlide = 2;
let chartExportColor = '#2F80ED';
let chartExportTitleColor = '#333333';

const nrKpis = [
  "NSA Average User Number","SgNB Addition Success Rate (CU)(%)","SgNB TriSgNB Abnormal Release Rate(%)","SCG PSCell Change Success Rate(%)",
  "Intra-SgNB IntraFreq PSCell Change Success Rate(%)","Intra-SgNB Pscell Change Success Rate(%)","Inter-SgNB Pscell Change Success Rate(%)",
  "Inter-SgNB PSCell IntraFreq Change Success Rate(%)","DL Avg Latency (ms)"
];
const nsaKpis = [
  "RRC Re-establish Rate(%)","Avg NSA DC User Num","L.Thpt.bits.DL.McgSplit.MeNB","L.Thpt.bits.DL.McgSplit.SgNB",
  "L.Thpt.bits.UL.McgSplit.MeNB","L.Thpt.bits.UL.McgSplit.SgNB","SCG Failure Rate(%)","NSA E-RAB Drop Rate(%)",
  "e-RAB Mod Success Rate(%)","SCG Mod Success Rate(4G initiated)(%)","SCG Mod Success Rate(5G initiated)(%)",
  "DL RB Utilization (NSA DC)(%)","UL RB Utilization (NSA DC)(%)","User Downlink Split Average Throughput (NSA DC)",
  "User Uplink Split Average Throughput (NSA DC)"
];

let selectedKpis = { nr: [...nrKpis], nsa: [...nsaKpis] };

/* =========================
   HELPERS
   ========================= */
function switchTab(tab){
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  const btn = document.querySelector(`.tab[onclick="switchTab('${tab}')"]`);
  if(btn) btn.classList.add('active');
  currentTab = tab;
  renderCharts();
}

async function fetchAndParse(url){
  const res = await fetch(url);
  const txt = await res.text();
  // fallback: parse CSV simple where fields may contain commas - but assume simple CSV
  const rows = txt.trim().split('\n').map(r => r.split(','));
  const headers = rows.shift().map(h => h.trim());
  return rows.map(r => {
    const obj = {};
    headers.forEach((h,i)=> {
      const val = r[i] ? r[i].trim() : '';
      obj[h] = val === '' ? null : (isNaN(val) ? val : parseFloat(val));
    });
    return obj;
  });
}

function parseCSVwithPapa(text){
  // use PapaParse if available (safer), otherwise fallback (not likely needed)
  if(window.Papa) {
    return Papa.parse(text, { header:true, skipEmptyLines:true }).data;
  }
  const rows = text.trim().split('\n').map(r => r.split(','));
  const headers = rows.shift().map(h=>h.trim());
  return rows.map(r=>{
    const o={};
    headers.forEach((h,i)=> o[h] = r[i]? r[i].trim():null);
    return o;
  });
}

/* =========================
   DATA FETCH
   ========================= */
/* Replace these published CSV URLs with your actual ones if different */
const NR_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=1617739873&single=true&output=csv";
const NSA_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=670588387&single=true&output=csv";
const CUTOVER_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=19616562&single=true&output=csv";

async function fetchData(){
  try {
    const t = Date.now();
    const [cutoverRes, nrRes, nsaRes] = await Promise.all([
      fetch(CUTOVER_CSV_URL + "&_t=" + t),
      fetch(NR_CSV_URL + "&_t=" + t),
      fetch(NSA_CSV_URL + "&_t=" + t)
    ]);
    const [cutoverTxt, nrTxt, nsaTxt] = await Promise.all([cutoverRes.text(), nrRes.text(), nsaRes.text()]);

    const cutoverRows = parseCSVwithPapa(cutoverTxt);
    const nrRows = parseCSVwithPapa(nrTxt);
    const nsaRows = parseCSVwithPapa(nsaTxt);

    // Normalize: both NR and NSA use eNodeB field name (you said eNodeB only)
    // We expect a header called "eNodeB Name" in both NR & NSA sheets.
    nrData = nrRows.map(r => r);
    nsaData = nsaRows.map(r => r);

    // Build siteCutoverMap using eNodeB Name column
    siteCutoverMap = {};
    cutoverRows.forEach(r => {
      const enb = (r["eNodeB Name"] || r["eNodeB"] || r["Site Name"] || r["Site"]) && String(r["eNodeB Name"] || r["eNodeB"] || r["Site Name"] || r["Site"]).trim();
      const onAir = (r["On-Air Date"] || r["On Air Date"] || r["OnAirDate"]) && String(r["On-Air Date"] || r["On Air Date"] || r["OnAirDate"]).trim();
      if(enb && onAir) siteCutoverMap[enb] = onAir;
    });

    // Determine all sites that exist in either NR or NSA datasets
    const nrSites = nrData.map(d => d["eNodeB Name"] || d["eNodeB"] || d["Site Name"]).filter(s => s).map(String);
    const nsaSites = nsaData.map(d => d["eNodeB Name"] || d["eNodeB"] || d["Site Name"]).filter(s => s).map(String);
    allSites = Array.from(new Set([...nrSites, ...nsaSites])).sort();

    // Build allOnAirDates from siteCutoverMap (only dates for known sites)
    allOnAirDates = Array.from(new Set(Object.keys(siteCutoverMap).filter(s => allSites.includes(s)).map(s => siteCutoverMap[s]))).filter(d => d).sort();
    selectedOnAirDates = [...allOnAirDates];
    selectedSites = []; // reset

    setupOnAirDateDropdown();
    setupSiteDropdown();
    renderCharts();
  } catch(e){
    console.error('fetchData error', e);
    alert('Failed to fetch data. Check CSV URLs and network console.');
  }
}

/* =========================
   FILTER UI: On-Air Dates
   ========================= */
function setupOnAirDateDropdown(){
  const list = document.getElementById('onAirDateDropdownList');
  const btn = document.getElementById('onAirDateDropdownBtn');
  list.innerHTML = '';
  list.innerHTML += `<div style="font-weight:600;padding:8px 10px;">Actions</div>`;
  list.innerHTML += `<div onclick="dateSetAll()" style="padding:8px 10px;cursor:pointer;"><b>Select All</b></div>`;
  list.innerHTML += `<div onclick="dateClearAll()" style="padding:8px 10px;cursor:pointer;"><b>Clear All</b></div>`;

  allOnAirDates.forEach(d => {
    const row = document.createElement('div');
    row.innerHTML = `<input class="date-chk" type="checkbox" value="${d}" ${selectedOnAirDates.includes(d) ? 'checked' : ''}> ${d}`;
    row.onclick = (e) => {
      if(e.target.tagName !== 'INPUT'){
        const chk = row.querySelector('input');
        chk.checked = !chk.checked;
      }
      updateSelectedDates();
    };
    list.appendChild(row);
  });

  btn.onclick = () => list.style.display = list.style.display === 'block' ? 'none' : 'block';
  window.dateSetAll = () => { selectedOnAirDates = [...allOnAirDates]; updateDateFilterUI({close:false}); setupSiteDropdown(); };
  window.dateClearAll = () => { selectedOnAirDates = []; updateDateFilterUI({close:false}); selectedSites = []; setupSiteDropdown(); };
  updateDateFilterUI({close:true});
}

function updateSelectedDates(){
  const list = document.getElementById('onAirDateDropdownList');
  selectedOnAirDates = Array.from(list.querySelectorAll('.date-chk:checked')).map(c => c.value);
  // when dates selected, auto-select sites under those dates
  const activeSites = allSites.filter(site => selectedOnAirDates.includes(siteCutoverMap[site]));
  selectedSites = [...activeSites];
  updateDateFilterUI({close:false});
  setupSiteDropdown();
}

function updateDateFilterUI(options = {close:true}){
  const span = document.getElementById('onAirDateBtnLabel');
  if(selectedOnAirDates.length === 0) span.textContent = 'No Dates Selected';
  else if(selectedOnAirDates.length === allOnAirDates.length) span.textContent = 'All On-Air Dates';
  else span.textContent = `Selected (${selectedOnAirDates.length})`;
  const list = document.getElementById('onAirDateDropdownList');
  list.querySelectorAll('.date-chk').forEach(c => c.checked = selectedOnAirDates.includes(c.value));
  if(options.close) list.style.display = 'none'; else list.style.display = 'block';
}

/* =========================
   FILTER UI: Sites
   ========================= */
function setupSiteDropdown(){
  const list = document.getElementById('siteDropdownList');
  const btn = document.getElementById('siteDropdownBtn');
  list.innerHTML = '';

  // Sites active under selectedOnAirDates
  const activeSites = allSites.filter(s => !selectedOnAirDates.length || selectedOnAirDates.includes(siteCutoverMap[s]));
  // keep selectedSites that are active
  selectedSites = selectedSites.filter(s => activeSites.includes(s));

  list.innerHTML += `<div style="font-weight:600;padding:8px 10px;">Actions</div>`;
  list.innerHTML += `<div onclick="siteSetAll()" style="padding:8px 10px;cursor:pointer;"><b>Select All (${activeSites.length})</b></div>`;
  list.innerHTML += `<div onclick="siteClearAll()" style="padding:8px 10px;cursor:pointer;"><b>Clear All</b></div>`;

  activeSites.forEach(site => {
    const row = document.createElement('div');
    const checked = selectedSites.includes(site) ? 'checked' : '';
    row.innerHTML = `<input class="site-chk" type="checkbox" value="${site}" ${checked}> ${site}`;
    row.onclick = (e) => {
      if(e.target.tagName !== 'INPUT'){
        const chk = row.querySelector('input');
        chk.checked = !chk.checked;
      }
      updateSelectedSites();
    };
    list.appendChild(row);
  });

  btn.onclick = () => list.style.display = list.style.display === 'block' ? 'none' : 'block';
  window.siteSetAll = () => { selectedSites = [...activeSites]; updateSiteFilterUI({close:false}); renderCharts(); };
  window.siteClearAll = () => { selectedSites = []; updateSiteFilterUI({close:false}); renderCharts(); };

  updateSiteFilterUI({close:true});
  renderCharts();
}

function updateSelectedSites(){
  const list = document.getElementById('siteDropdownList');
  selectedSites = Array.from(list.querySelectorAll('.site-chk:checked')).map(c => c.value);
  updateSiteFilterUI({close:false});
  renderCharts();
}

function updateSiteFilterUI(options = {close:true}){
  const span = document.getElementById('siteBtnLabel');
  const activeSites = allSites.filter(s => !selectedOnAirDates.length || selectedOnAirDates.includes(siteCutoverMap[s]));
  if(selectedSites.length === 0) span.textContent = `All Active Sites`;
  else if(selectedSites.length === activeSites.length) span.textContent = `All Active Sites (${selectedSites.length})`;
  else if(selectedSites.length === 1) span.textContent = selectedSites[0];
  else span.textContent = `Selected (${selectedSites.length})`;

  const list = document.getElementById('siteDropdownList');
  list.querySelectorAll('.site-chk').forEach(c => c.checked = selectedSites.includes(c.value));
  if(options.close) list.style.display = 'none'; else list.style.display = 'block';
}

/* =========================
   CHART RENDERING
   ========================= */
function renderCharts(){
  const container = document.getElementById('mainChartContainer');
  container.innerHTML = '';

  // KPIs list based on tab
  let kpisToShow = [];
  if(currentTab === 'nr') kpisToShow = selectedKpis.nr.map(k => ({kpi:k, type:'nr'}));
  else if(currentTab === 'nsa') kpisToShow = selectedKpis.nsa.map(k => ({kpi:k, type:'nsa'}));
  else kpisToShow = [...selectedKpis.nr.map(k => ({kpi:k,type:'nr'})), ...selectedKpis.nsa.map(k => ({kpi:k,type:'nsa'}))];

  // 1) determine final site list (eNodeB names)
  const sitesFromDate = allSites.filter(site => !selectedOnAirDates.length || selectedOnAirDates.includes(siteCutoverMap[site]));
  const finalSiteList = selectedSites.length ? selectedSites : sitesFromDate;

  // 2) prefilter datasets by eNodeB Name
  // Both nrData and nsaData use "eNodeB Name" (or nearby header aliases).
  function siteMatches(row){
    const candidates = [row["eNodeB Name"], row["eNodeB"], row["Site Name"], row["Site"]].filter(Boolean).map(String);
    return candidates.some(c => finalSiteList.includes(c));
  }
  const filteredNR = nrData.filter(siteMatches);
  const filteredNSA = nsaData.filter(siteMatches);
  const combined = [...filteredNR, ...filteredNSA];

  // timeline derived from combined filtered data
  const timelineRaw = Array.from(new Set(combined.map(d => d["Date"]).filter(Boolean)));
  // parse dd/mm/yyyy -> sort by date
  const timeline = timelineRaw.sort((a,b) => {
    const toDate = s => { const p = String(s).split('/').map(Number); if(p.length<3) return new Date(s); return new Date(p[2], (p[1]||1)-1, p[0]||1); };
    return toDate(a) - toDate(b);
  });

  const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const timelineLabels = timeline.map(d => {
    const p = String(d).split('/').map(Number);
    const day = p[0] || 1; const month = p[1] || 1;
    return `${day} ${monthNames[month-1]}`;
  });

  // Create one chart per KPI
  kpisToShow.forEach((ki, idx) => {
    const kpi = ki.kpi;
    const type = ki.type;

    const card = document.createElement('div'); card.className='chart-card';
    const wrapper = document.createElement('div'); wrapper.className='chart-container';
    const canvas = document.createElement('canvas'); canvas.id = `chart_${idx}`;
    wrapper.appendChild(canvas); card.appendChild(wrapper); container.appendChild(card);

    // choose source: nr -> filteredNR, nsa -> filteredNSA (aggregation done per-kpi)
    const source = (type === 'nr') ? filteredNR : filteredNSA;

    const dataPoints = timeline.map(date => {
      const values = source.filter(r => r["Date"] === date).map(r => {
        const raw = r[kpi] !== undefined ? r[kpi] : (r[kpi] === 0 ? 0 : r[kpi]);
        const n = Number(raw);
        return Number.isFinite(n) ? n : NaN;
      }).filter(v => !Number.isNaN(v));
      if(values.length === 0) return null;
      const avg = values.reduce((a,b) => a + b, 0) / values.length;
      return avg;
    });

    const valid = dataPoints.filter(v => v !== null);
    let minVal = valid.length ? Math.min(...valid) : 0;
    let maxVal = valid.length ? Math.max(...valid) : 100;

    // Special percentage handling: if KPI name looks like percent/success and numbers in high range
    const looksLikePercent = /%|Success Rate|Rate/i.test(kpi);
    if(looksLikePercent && valid.length){
      if(minVal >= 95 && maxVal <= 100){
        minVal = 95; maxVal = 100;
      } else {
        minVal = Math.floor(minVal / 5) * 5;
        maxVal = Math.ceil(maxVal / 5) * 5;
      }
    } else if(valid.length){
      // add small buffer
      const buffer = (maxVal - minVal) * 0.05 || Math.max(1, Math.abs(minVal) * 0.05);
      minVal = Math.floor(minVal - buffer);
      maxVal = Math.ceil(maxVal + buffer);
    } else {
      minVal = 0; maxVal = 100;
    }

    // guard against equal min/max
    if(minVal === maxVal){
      minVal = Math.max(0, minVal - 1);
      maxVal = Math.min(100, maxVal + 1);
    }

    // Build chart options including special 95..100 ticks
    const yTicks = {};
    if(looksLikePercent && minVal >= 95 && maxVal <= 100){
      yTicks.stepSize = 1;
      yTicks.callback = function(value){ if(value >= 95 && value <= 100) return value; return null; };
    }

    new Chart(canvas.getContext('2d'), {
      type: 'line',
      data: {
        labels: timelineLabels,
        datasets: [{
          label: (finalSiteList.length > 0 && dataPoints.some(p => p !== null)) ? `${type.toUpperCase()} Aggregate` : 'No Data',
          data: dataPoints,
          borderColor: getRandomColor(),
          backgroundColor: 'transparent',
          borderWidth: 2,
          pointRadius: 3,
          tension: 0.1,
          spanGaps: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: { display: true, text: kpi, color: '#333', font: { size: 14, weight: 'bold' } }
        },
        scales: {
          x: { ticks: { font: { size: 10 } }, grid: { display: false } },
          y: {
            grid: { color: '#eee' },
            beginAtZero: false,
            min: (finalSiteList.length === 0 || dataPoints.every(p => p === null)) ? 0 : minVal,
            max: (finalSiteList.length === 0 || dataPoints.every(p => p === null)) ? 100 : maxVal,
            ticks: yTicks
          }
        },
        animation: {
          x: { duration: 500, easing: 'linear', from: NaN, delay: ctx => (ctx.index || 0) * 15 },
          y: { duration: 0 }
        }
      }
    });
  });
}

/* =========================
   KPI Drawer
   ========================= */
function toggleDrawer(){
  const d = document.getElementById('kpiDrawer');
  d.classList.toggle('open');
  if(d.classList.contains('open')) populateKpiOptions();
}

function populateKpiOptions(){
  const list = document.getElementById('kpiOptionsList'); list.innerHTML = '';
  const nrSection = currentTab === 'nr' || currentTab === 'both';
  const nsaSection = currentTab === 'nsa' || currentTab === 'both';

  function makeGroup(title, key, arr){
    const h = document.createElement('h4'); h.textContent = title; h.style.marginTop='8px'; list.appendChild(h);
    arr.forEach(k => {
      const div = document.createElement('div');
      const checked = selectedKpis[key].includes(k) ? 'checked' : '';
      div.innerHTML = `<input type="checkbox" class="kpi-chk" data-group="${key}" value="${k}" ${checked}> <span style="font-size:13px">${k}</span>`;
      div.onclick = (e) => { if(e.target.tagName !== 'INPUT'){ const chk = div.querySelector('input'); chk.checked = !chk.checked; } };
      list.appendChild(div);
    });
  }
  if(nrSection) makeGroup('NR KPIs','nr', nrKpis);
  if(nsaSection) makeGroup('NSA KPIs','nsa', nsaKpis);
}

function selectVisibleKpis(){
  document.querySelectorAll('.kpi-chk').forEach(c => c.checked = true);
  if(currentTab === 'nr' || currentTab === 'both') selectedKpis.nr = [...nrKpis];
  if(currentTab === 'nsa' || currentTab === 'both') selectedKpis.nsa = [...nsaKpis];
}
function clearVisibleKpis(){
  document.querySelectorAll('.kpi-chk').forEach(c => c.checked = false);
  if(currentTab === 'nr' || currentTab === 'both') selectedKpis.nr = [];
  if(currentTab === 'nsa' || currentTab === 'both') selectedKpis.nsa = [];
}
function applyKpis(){
  const chks = document.querySelectorAll('.kpi-chk');
  const tempnr = (currentTab === 'nr' || currentTab === 'both') ? [] : [...selectedKpis.nr];
  const tempnsa = (currentTab === 'nsa' || currentTab === 'both') ? [] : [...selectedKpis.nsa];
  chks.forEach(c => { if(c.checked){ if(c.dataset.group === 'nr') tempnr.push(c.value); if(c.dataset.group === 'nsa') tempnsa.push(c.value); }});
  selectedKpis.nr = tempnr; selectedKpis.nsa = tempnsa;
  toggleDrawer();
  renderCharts();
}

/* =========================
   Preview & PPT Export (kept simple & consistent)
   ========================= */
function updatePreviewSettings(newCount, newLineColor, newTitleColor){
  if(newCount) graphsPerSlide = parseInt(newCount);
  if(newLineColor) chartExportColor = newLineColor;
  if(newTitleColor) chartExportTitleColor = newTitleColor;
  highlightSettingButtons(graphsPerSlide, chartExportColor, chartExportTitleColor);

  const canvases = document.querySelectorAll('canvas');
  const body = document.getElementById('previewBody');
  body.innerHTML = '';
  const layout = getLayoutConfig(graphsPerSlide);
  const gridCols = `repeat(${layout.cols}, 1fr)`;

  for(let i=0;i<canvases.length;i+=graphsPerSlide){
    const slideDiv = document.createElement('div'); slideDiv.className = 'preview-slide';
    const slideTitle = document.createElement('div'); slideTitle.className = 'preview-slide-title';
    slideTitle.textContent = `Slide ${Math.floor(i/graphsPerSlide)+1}`; slideDiv.appendChild(slideTitle);
    const grid = document.createElement('div'); grid.className = 'preview-grid';
    grid.style.gridTemplateColumns = gridCols;
    grid.style.height = '100%';
    for(let j=0;j<graphsPerSlide;j++){
      if(i+j < canvases.length){
        const c = canvases[i+j];
        const box = createPreviewBox(c, chartExportColor, chartExportTitleColor);
        box.style.height = 'auto';
        grid.appendChild(box);
      }
    }
    slideDiv.appendChild(grid); body.appendChild(slideDiv);
  }
}

function highlightSettingButtons(count, lineColor, titleColor){
  document.querySelectorAll('.graph-options button').forEach(btn => {
    btn.classList.remove('active'); btn.style.backgroundColor = '#2F80ED'; btn.style.color = 'white';
    if(parseInt(btn.dataset.count) === count){ btn.classList.add('active'); btn.style.backgroundColor = '#27AE60'; }
  });
  document.querySelectorAll('#previewSettingsPanel .color-option').forEach(el => {
    el.classList.remove('selected');
    if(el.dataset.color === lineColor || el.dataset.color === titleColor) el.classList.add('selected');
  });
}

function createPreviewBox(canvas, lineColor, titleColor){
  const box = document.createElement('div'); box.className='preview-img-box';
  const tempCanvas = document.createElement('canvas'); tempCanvas.width = canvas.width; tempCanvas.height = canvas.height;
  const tempCtx = tempCanvas.getContext('2d');
  const chartInstance = Chart.getChart(canvas.id);
  let img = '';
  if(chartInstance){
    const originalColors = chartInstance.data.datasets.map(d=>d.borderColor);
    const originalPoint = chartInstance.data.datasets.map(d=>d.pointBorderColor);
    const origTitle = (chartInstance.options.plugins && chartInstance.options.plugins.title) ? chartInstance.options.plugins.title.color : '#333';
    chartInstance.data.datasets.forEach(d => {
      d.borderColor = lineColor; d.pointBorderColor = lineColor; d.pointBackgroundColor = lineColor; d.pointRadius = 3; d.spanGaps = true;
    });
    if(chartInstance.options.plugins && chartInstance.options.plugins.title) chartInstance.options.plugins.title.color = titleColor;
    chartInstance.update('none');
    tempCtx.drawImage(canvas, 0, 0);
    img = tempCanvas.toDataURL('image/png');
    // restore
    chartInstance.data.datasets.forEach((d,i) => { d.borderColor = originalColors[i]; d.pointBorderColor = originalPoint[i]; });
    if(chartInstance.options.plugins && chartInstance.options.plugins.title) chartInstance.options.plugins.title.color = origTitle;
    chartInstance.update('none');
  }
  const imgel = document.createElement('img'); imgel.src = img; imgel.style.maxWidth='100%'; imgel.style.maxHeight='100%'; imgel.style.objectFit='contain';
  box.appendChild(imgel);
  return box;
}

function openPreview(){
  const canvases = document.querySelectorAll('canvas');
  if(!canvases.length){ alert('No charts to export'); return; }
  if(!graphsPerSlide) graphsPerSlide = 2;
  updatePreviewSettings(graphsPerSlide, chartExportColor, chartExportTitleColor);
  document.getElementById('previewModal').style.display = 'flex';
}

function closePreview(){ document.getElementById('previewModal').style.display = 'none'; }

/* Basic PPT download (uses same layout calc as preview) */
function getLayoutConfig(count){
  const slideW = 10.0, slideH = 5.625, marginX = 0.2, marginTop = 0.9, marginBottom = 0.2, gap = 0.15;
  let rows=2, cols=2;
  switch(parseInt(count)){
    case 1: rows=1; cols=1; break;
    case 2: rows=1; cols=2; break;
    case 3: rows=2; cols=2; break;
    case 4: rows=2; cols=2; break;
    case 6: rows=2; cols=3; break;
    case 9: rows=3; cols=3; break;
    default: rows=2; cols=2;
  }
  const usableW = slideW - marginX*2;
  const usableH = slideH - marginTop - marginBottom;
  const chartW = (usableW - (cols-1)*gap)/cols;
  const chartH = (usableH - (rows-1)*gap)/rows;
  return { rows, cols, chartW, chartH, gap, marginX, marginTop, slideW, slideH };
}

async function downloadPPT(){
  const pptx = new PptxGenJS();
  pptx.layout = 'LAYOUT_16x9';
  let slide = pptx.addSlide();
  slide.addText('NR & NSA KPI Report', {x:0.5,y:1.6,fontSize:28,bold:true,color:'2F80ED'});
  slide.addText(`Generated: ${new Date().toLocaleDateString()}`, {x:0.5,y:2.3,fontSize:12});

  const canvases = document.querySelectorAll('canvas');
  const count = graphsPerSlide;
  const layout = getLayoutConfig(count);
  const effectiveTop = 0.2;

  for(let i=0;i<canvases.length;i+=count){
    const s = pptx.addSlide();
    for(let j=0;j<count;j++){
      if(i+j < canvases.length){
        const c = canvases[i+j];
        const col = j % layout.cols;
        const row = Math.floor(j / layout.cols);
        const x = layout.marginX + col * (layout.chartW + layout.gap);
        const y = effectiveTop + row * (layout.chartH + layout.gap);
        // style override for export
        const chartInstance = Chart.getChart(c.id);
        let originalColors, originalPointColors, originalTitleColor;
        if(chartInstance){
          originalColors = chartInstance.data.datasets.map(d=>d.borderColor);
          originalPointColors = chartInstance.data.datasets.map(d=>d.pointBorderColor);
          originalTitleColor = (chartInstance.options.plugins && chartInstance.options.plugins.title) ? chartInstance.options.plugins.title.color : '#333';
          chartInstance.data.datasets.forEach(d => { d.borderColor = chartExportColor; d.pointBorderColor = chartExportColor; d.pointBackgroundColor = chartExportColor; d.pointRadius = 3; d.spanGaps = true; });
          if(chartInstance.options.plugins && chartInstance.options.plugins.title) chartInstance.options.plugins.title.color = chartExportTitleColor;
          chartInstance.update('none');
        }
        const imgData = c.toDataURL('image/png');
        if(chartInstance){
          chartInstance.data.datasets.forEach((d,i)=> { d.borderColor = originalColors[i]; d.pointBorderColor = originalPointColors[i]; d.spanGaps = true; });
          if(chartInstance.options.plugins && chartInstance.options.plugins.title) chartInstance.options.plugins.title.color = originalTitleColor;
          chartInstance.update('none');
        }
        s.addImage({ data: imgData, x, y, w: layout.chartW, h: layout.chartH });
      }
    }
  }
  await pptx.writeFile({ fileName: `KPI_Report_${Date.now()}.pptx` });
  closePreview();
}

/* =========================
   UTIL
   ========================= */
function getRandomColor(){
  const colors = ['#2F80ED','#27AE60','#D24726','#8E44AD','#F39C12','#2980B9'];
  return colors[Math.floor(Math.random()*colors.length)];
}

/* =========================
   INIT
   ========================= */
fetchData();

</script>
</body>
</html>
