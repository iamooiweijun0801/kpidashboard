<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KPI Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<style>
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f0f2f5; overflow-x:hidden; }
header { text-align:center; padding:20px 0; font-size:32px; font-weight:bold; color:#2F80ED; background:white; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:16px; }
.tabs { display:flex; justify-content:center; margin-bottom:16px; flex-wrap:wrap; gap:8px; }
.tab { padding:10px 20px; cursor:pointer; border:1px solid #ccc; border-radius:8px; background:#eee; font-weight:bold; transition:0.3s; }
.tab.active { background:#2F80ED; color:white; }
.tab:hover:not(.active) { background:#d0e1ff; }
.controls { display:flex; justify-content:center; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
#siteFilter { padding:8px; width:250px; border-radius:6px; border:1px solid #ccc; }
#dropdown { position:absolute; background:white; border:1px solid #ccc; max-height:150px; overflow-y:auto; display:none; z-index:10; width:250px; top:38px; left:0; border-radius:6px; }
#dropdown div { padding:6px 10px; cursor:pointer; transition:0.2s; }
#dropdown div:hover { background:#2F80ED; color:white; }

#siteDropdownBtn { padding:8px 10px; cursor:pointer; border:1px solid #ccc; border-radius:6px; background:white; min-width:250px; text-align:left; position:relative; z-index:5; }
#siteDropdownList { position:absolute; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; display:none; z-index:10; width:250px; border-radius:6px; padding:6px; }

button { padding:10px 18px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:bold; transition:0.2s; }
button:hover { background:#1f5ab5; }

.chart-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:20px; padding:0 20px 20px 20px; }
canvas { background:white; border-radius:12px; padding:16px; width:100% !important; height:250px !important; }
.chart-card { padding:10px; border-radius:12px; background:white; box-shadow:0 2px 12px rgba(0,0,0,0.1); transition:0.3s; }
.chart-card:hover { transform:translateY(-4px); box-shadow:0 6px 20px rgba(0,0,0,0.15); }
.chart-title { text-align:center; font-weight:bold; margin-bottom:10px; color:#333; }

/* KPI Drawer */
.kpiDrawer { position:fixed; top:0; right:-320px; width:320px; height:100%; background:white; box-shadow:-4px 0 12px rgba(0,0,0,0.15); transition:0.3s; z-index:20; padding:20px; overflow-y:auto; }
.kpiDrawer.open { right:0; }
.kpiDrawer h3 { margin-top:0; margin-bottom:12px; color:#2F80ED; }
.kpiOption { margin-bottom:6px; }
#applyKpiBtn { margin-top:10px; width:100%; }

/* Minimal blue toggle button */
.kpiDrawerToggle { position:fixed; top:20px; right:0; width:30px; height:80px; background:#2F80ED; border-radius:6px 0 0 6px; cursor:pointer; z-index:25; }
.kpiDrawerToggle:hover { background:#1f5ab5; }
</style>
</head>
<body>

<header>KPI Dashboard</header>

<div class="tabs">
  <div class="tab active" data-tab="acceptance">Acceptance KPIs</div>
  <div class="tab" data-tab="monitoring">Monitoring KPIs</div>
</div>

<div class="controls">
  <div style="position:relative;">
    <input type="text" id="siteFilter" placeholder="Search eNodeB Name">
    <div id="dropdown"></div>
  </div>
  <div style="position:relative;">
    <button id="siteDropdownBtn">All Sites ▼</button>
    <div id="siteDropdownList"></div>
  </div>
  <button id="refreshBtn">Refresh Data</button>
</div>

<!-- Pages -->
<div id="acceptancePage">
  <div class="chart-grid" id="acceptanceChartContainer"></div>
</div>
<div id="monitoringPage" style="display:none;">
  <div class="chart-grid" id="monitoringChartContainer"></div>
</div>

<!-- KPI Drawers -->
<div id="acceptanceDrawer" class="kpiDrawer">
  <h3>KPIs</h3>
  <div><input type="checkbox" id="selectAllAcceptance"> <label for="selectAllAcceptance"><b>Select All</b></label></div>
  <div id="acceptanceKpiOptions"></div>
  <button id="applyAcceptanceBtn">Apply</button>
</div>
<div id="monitoringDrawer" class="kpiDrawer">
  <h3>KPIs</h3>
  <div><input type="checkbox" id="selectAllMonitoring"> <label for="selectAllMonitoring"><b>Select All</b></label></div>
  <div id="monitoringKpiOptions"></div>
  <button id="applyMonitoringBtn">Apply</button>
</div>

<div id="drawerToggle" class="kpiDrawerToggle"></div>

<script>
let allData=[], fuse=null, allSites=[];
let selectedSites=[]; // Persist across pages
let acceptanceKpisList=[], monitoringKpisList=[];
let selectedAcceptanceKpis=[], selectedMonitoringKpis=[];

// KPI lists
const acceptanceKpis = [
  "LTE RRC Setup Success Rate","ERAB Setup Success Rate","LTE Call Setup Success Rate","E-RAB Call Drop Rate",
  "CSFB Access Success Rate","LTE Intra Freq HO Success Rate","Intra-eNB HO Success Success Rate","Inter-eNBX2HO Success Rate",
  "Inter-eNBS1HO Success Rate","Max RRC Connected Ue","DL Data Total Volume (Gbyte)","UL Data Total Volume (Gbyte)",
  "E-RAB Setup Success Rate (VoIP)","Call Drop Rate (VoIP)","Intra-frequency Handover Out Success Rate(VoIP)",
  "Inter-frequency Handover Out Success Rate(VoIP)","SRVCC Success Rate (L2W)","SRVCC Success Rate (L2G)"
];
const monitoringKpis = [
  "Cell Availability Ratio","Average Latency Downlink (msecs)","DL PRB Utilization (%)","UL PRB Utilization (%)",
  "LTE DL - Cell Average Throughput (Mbit/s)","LTE UL - Cell Average Thoughput (Mbit/s)","LTE DL -USER Average Throughput (Mbit/s)",
  "LTE UL -USER Average Throughput (Mbit/s)","Downlink Packet Loss Rate (VoIP)","Uplink Packet Loss Rate (VoIP)",
  "VoLTE Traffic Erlang","VoLTE Traffic DL (MB)","VoLTE Traffic UL (MB)","DL BLER QCI1","UL BLER QCI1"
];

// Fetch CSV
async function fetchData(){
  const res=await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?output=csv");
  const text=await res.text();
  const rows=text.trim().split('\n').map(r=>r.split(','));
  const headers=rows.shift().map(h=>h.trim());
  allData=rows.map(r=>{
    const obj={};
    headers.forEach((h,i)=>{ const val=r[i]?r[i].trim():"0"; obj[h]=isNaN(val)?val:parseFloat(val); });
    return obj;
  });
  fuse=new Fuse(allData,{keys:['eNodeB Name'], threshold:0.4});
  allSites=[...new Set(allData.map(d=>d["eNodeB Name"]))].sort();
  populateSiteDropdown();
  populateKpiDrawers();
  drawAcceptanceCharts();
}

// Site dropdown with select all / clear filter
function populateSiteDropdown(){
  const list=document.getElementById("siteDropdownList");
  list.innerHTML="";
  const allDiv=document.createElement("div");
  allDiv.innerHTML='<input type="checkbox" id="siteAll" checked> <label for="siteAll"><b>All Sites</b></label>';
  list.appendChild(allDiv);

  allDiv.querySelector("#siteAll").addEventListener("change", function(){
    const checkboxes=list.querySelectorAll(".siteOption");
    checkboxes.forEach(c=>c.checked=this.checked);
    selectedSites=this.checked?allSites.slice():[];
    updateSiteButtonLabel();
    drawCurrentPageCharts();
  });

  allSites.forEach((site,i)=>{
    const div=document.createElement("div");
    div.innerHTML=`<input type="checkbox" class="siteOption" id="site_${i}" value="${site}" checked> <label for="site_${i}">${site}</label>`;
    list.appendChild(div);
    div.querySelector(".siteOption").addEventListener("change",()=>{
      const checked=list.querySelectorAll(".siteOption:checked");
      selectedSites=Array.from(checked).map(c=>c.value);
      list.querySelector("#siteAll").checked=selectedSites.length===allSites.length;
      updateSiteButtonLabel();
      drawCurrentPageCharts();
    });
  });

  document.getElementById("siteDropdownBtn").onclick=()=>{ list.style.display=list.style.display==="block"?"none":"block"; };
}

function updateSiteButtonLabel(){
  const btn=document.getElementById("siteDropdownBtn");
  if(selectedSites.length===0 || selectedSites.length===allSites.length){ btn.textContent="All Sites ▼"; }
  else if(selectedSites.length===1){ btn.textContent=selectedSites[0]+" ▼"; }
  else btn.textContent="Multiple Sites ▼";
}

// KPI drawer functions (remain same as previous code)
function populateKpiDrawers(){ /* similar as previous implementation */ }

// Drawer toggle
document.getElementById("drawerToggle").addEventListener("click", ()=>{
  const drawer=document.getElementById(currentTab+"Drawer");
  drawer.classList.toggle("open");
});

// Tab switching
let currentTab="acceptance";
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    currentTab=tab.dataset.tab;
    document.getElementById("acceptancePage").style.display=currentTab==="acceptance"?"block":"none";
    document.getElementById("monitoringPage").style.display=currentTab==="monitoring"?"block":"none";
    drawCurrentPageCharts();
  });
});

function drawCurrentPageCharts(){
  if(currentTab==="acceptance") drawAcceptanceCharts();
  else drawMonitoringCharts();
}

// Chart draw functions (remain same as previous implementation)
function drawAcceptanceCharts(){ /* as before */ }
function drawMonitoringCharts(){ /* as before */ }

document.getElementById("refreshBtn").addEventListener("click", fetchData);
fetchData();
</script>

</body>
</html>
