<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>KPI Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<style>
/* ---------- Layout ---------- */
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f0f2f5; overflow-x:hidden; }
header { text-align:center; padding:20px 0; font-size:32px; font-weight:700; color:#2F80ED; background:white; box-shadow:0 2px 6px rgba(0,0,0,0.08); margin-bottom:16px; }
.tabs { display:flex; justify-content:center; gap:8px; margin-bottom:16px; }
.tab { padding:10px 18px; cursor:pointer; border-radius:8px; background:#eee; border:1px solid #d7dbe0; font-weight:700; transition:0.18s; }
.tab.active { background:#2F80ED; color:#fff; box-shadow:0 2px 8px rgba(47,128,237,0.14); }
.controls { display:flex; justify-content:center; gap:12px; margin-bottom:16px; flex-wrap:wrap; align-items:center; }

/* filter inputs */
#siteFilter { padding:8px; width:250px; border-radius:6px; border:1px solid #ccc; }
#dropdown { position:absolute; background:white; border:1px solid #ccc; max-height:150px; overflow-y:auto; display:none; z-index:50; width:250px; top:38px; left:0; border-radius:6px; }
#dropdown div { padding:6px 10px; cursor:pointer; }
#dropdown div:hover { background:#2F80ED; color:#fff; }

/* site dropdown list */
#siteDropdownBtn { padding:8px 10px; cursor:pointer; border:1px solid #ccc; border-radius:6px; background:#fff; min-width:250px; text-align:left; position:relative; z-index:40; }
#siteDropdownList { position:absolute; background:white; border:1px solid #ccc; max-height:260px; overflow-y:auto; display:none; z-index:45; width:250px; border-radius:6px; padding:6px; }

/* buttons */
button { padding:10px 16px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:700; }
button:hover { background:#1f5ab5; }

/* charts */
.chart-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(420px,1fr)); gap:18px; padding:0 20px 28px; }
.canvas-wrap { background:white; border-radius:12px; padding:12px; box-shadow:0 2px 10px rgba(0,0,0,0.06); }
.chart-title { text-align:center; font-weight:700; margin-bottom:8px; color:#333; }

/* KPI Drawer (hidden by default) */
.kpiDrawer {
  position:fixed; top:0; right:0; width:320px; height:100%; background:#fff; box-shadow:-6px 0 18px rgba(0,0,0,0.12);
  padding:18px; overflow-y:auto; z-index:60; transform:translateX(100%); transition:transform .28s ease;
  display:none; /* hidden initially */
}
.kpiDrawer.open { display:block; transform:translateX(0); }
.kpiDrawer h3 { margin:0 0 10px 0; color:#2F80ED; }
.kpiOption { margin-bottom:8px; font-size:14px; }

/* small blue toggle (always visible) */
.kpiDrawerToggle { position:fixed; top:20px; right:0; width:30px; height:80px; background:#2F80ED; border-radius:6px 0 0 6px; cursor:pointer; z-index:70; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; }
.kpiDrawerToggle:hover { background:#1f5ab5; }

/* small helper styles in dropdown */
.drop-action { padding:8px 10px; cursor:pointer; border-bottom:1px solid #eee; font-weight:700; }
.drop-action:hover { background:#f0f6ff; }
</style>
</head>
<body>

<header>KPI Dashboard</header>

<!-- tabs -->
<div class="tabs">
  <div class="tab active" data-tab="acceptance">Acceptance KPIs</div>
  <div class="tab" data-tab="monitoring">Monitoring KPIs</div>
</div>

<!-- controls: search + site dropdown + refresh -->
<div class="controls">
  <div style="position:relative;">
    <input id="siteFilter" type="text" placeholder="Search eNodeB Name" />
    <div id="dropdown"></div>
  </div>

  <div style="position:relative;">
    <button id="siteDropdownBtn">All Sites ▼</button>
    <div id="siteDropdownList"></div>
  </div>

  <button id="refreshBtn">Refresh Data</button>
</div>

<!-- pages -->
<div id="acceptancePage">
  <div class="chart-grid" id="acceptanceChartContainer"></div>
</div>

<div id="monitoringPage" style="display:none;">
  <div class="chart-grid" id="monitoringChartContainer"></div>
</div>

<!-- KPI Drawers (one for each tab) - hidden until toggle clicked -->
<div id="acceptanceDrawer" class="kpiDrawer" aria-hidden="true">
  <h3>Acceptance KPIs</h3>
  <div><input id="selectAllAcceptance" type="checkbox"> <label for="selectAllAcceptance"><b>Select All</b></label></div>
  <div id="acceptanceKpiOptions" style="margin-top:8px;"></div>
  <button id="applyAcceptanceBtn">Apply</button>
</div>

<div id="monitoringDrawer" class="kpiDrawer" aria-hidden="true">
  <h3>Monitoring KPIs</h3>
  <div><input id="selectAllMonitoring" type="checkbox"> <label for="selectAllMonitoring"><b>Select All</b></label></div>
  <div id="monitoringKpiOptions" style="margin-top:8px;"></div>
  <button id="applyMonitoringBtn">Apply</button>
</div>

<!-- small blue toggle visible at all times -->
<div id="drawerToggle" class="kpiDrawerToggle">▶</div>

<script>
/* --------- Data & config --------- */
let allData = [];
let fuse = null;
let allSites = [];
let selectedSites = []; // persistent across pages
let selectedAcceptanceKpis = [];
let selectedMonitoringKpis = [];
const animationDuration = 150;

/* KPI lists */
const acceptanceKpis = [
  "LTE RRC Setup Success Rate","ERAB Setup Success Rate","LTE Call Setup Success Rate","E-RAB Call Drop Rate",
  "CSFB Access Success Rate","LTE Intra Freq HO Success Rate","Intra-eNB HO Success Rate","Inter-eNBX2HO Success Rate",
  "Inter-eNBS1HO Success Rate","Max RRC Connected Ue","DL Data Total Volume (Gbyte)","UL Data Total Volume (Gbyte)",
  "E-RAB Setup Success Rate (VoIP)","Call Drop Rate (VoIP)","Intra-frequency Handover Out Success Rate(VoIP)",
  "Inter-frequency Handover Out Success Rate(VoIP)","SRVCC Success Rate (L2W)","SRVCC Success Rate (L2G)"
];

const monitoringKpis = [
  "Cell Availability Ratio","Average Latency Downlink (msecs)","DL PRB Utilization (%)","UL PRB Utilization (%)",
  "LTE DL - Cell Average Throughput (Mbit/s)","LTE UL - Cell Average Thoughput (Mbit/s)","LTE DL -USER Average Throughput (Mbit/s)",
  "LTE UL -USER Average Throughput (Mbit/s)","Downlink Packet Loss Rate (VoIP)","Uplink Packet Loss Rate (VoIP)",
  "VoLTE Traffic Erlang","VoLTE Traffic DL (MB)","VoLTE Traffic UL (MB)","DL BLER QCI1","UL BLER QCI1"
];

/* --------- Fetch + parse CSV --------- */
async function fetchData(){
  try{
    const res = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?output=csv");
    const text = await res.text();
    parseCSV(text);
    populateSiteDropdown();       // builds site list + Select All / Clear
    populateKpiDrawers();         // builds KPI checkboxes inside each drawer
    // default: select all sites
    selectedSites = allSites.slice();
    checkAllSiteCheckboxes(true);
    drawCurrentPageCharts();
  }catch(e){
    console.error("fetchData error", e);
  }
}

function parseCSV(text){
  const rows = text.trim().split('\n').map(r => r.split(','));
  const headers = rows.shift().map(h => h.trim());
  allData = rows.map(r => {
    const obj = {};
    headers.forEach((h,i) => {
      const val = (r[i] !== undefined && r[i] !== null) ? r[i].trim() : "";
      // keep non-numeric as-is (like eNodeB Name, Date), convert numeric strings to Number
      obj[h] = val === "" ? "" : (isNaN(val) ? val : parseFloat(val));
    });
    return obj;
  });
  fuse = new Fuse(allData, { keys: ['eNodeB Name'], threshold: 0.35 });
  allSites = [...new Set(allData.map(d => d["eNodeB Name"]))].sort();
}

/* --------- Site Dropdown (with Select All & Clear) --------- */
function populateSiteDropdown(){
  const list = document.getElementById("siteDropdownList");
  list.innerHTML = "";

  // Select All control
  const selectAllDiv = document.createElement('div');
  selectAllDiv.className = 'drop-action';
  selectAllDiv.textContent = 'Select All Sites';
  selectAllDiv.onclick = () => {
    selectedSites = allSites.slice();
    checkAllSiteCheckboxes(true);
    updateSiteButtonLabel();
    drawCurrentPageCharts();
  };
  list.appendChild(selectAllDiv);

  // Clear filter control
  const clearDiv = document.createElement('div');
  clearDiv.className = 'drop-action';
  clearDiv.textContent = 'Clear Filter';
  clearDiv.onclick = () => {
    selectedSites = [];
    checkAllSiteCheckboxes(false);
    updateSiteButtonLabel();
    drawCurrentPageCharts();
  };
  list.appendChild(clearDiv);

  // site entries
  allSites.forEach((site, i) => {
    const div = document.createElement('div');
    div.style.padding = '6px 8px';
    div.innerHTML = `<input class="siteOption" type="checkbox" id="site_${i}" value="${site}"> <label for="site_${i}">${site}</label>`;
    list.appendChild(div);
  });

  // wire toggle
  document.getElementById("siteDropdownBtn").onclick = () => {
    const s = list.style.display === "block" ? "none" : "block";
    list.style.display = s;
  };

  // checkbox event
  list.querySelectorAll('.siteOption').forEach(chk => {
    chk.addEventListener('change', () => {
      selectedSites = Array.from(list.querySelectorAll('.siteOption:checked')).map(c => c.value);
      updateSiteButtonLabel();
      drawCurrentPageCharts();
    });
  });
}

function checkAllSiteCheckboxes(check){
  const list = document.getElementById("siteDropdownList");
  list.querySelectorAll('.siteOption').forEach(c => c.checked = !!check);
}

/* update the label text for the site button */
function updateSiteButtonLabel(){
  const btn = document.getElementById("siteDropdownBtn");
  if(selectedSites.length === 0 || selectedSites.length === allSites.length){
    btn.textContent = "All Sites ▼";
  } else if(selectedSites.length === 1){
    btn.textContent = selectedSites[0] + " ▼";
  } else {
    btn.textContent = "Multiple Sites ▼";
  }
}

/* --------- KPI drawers populate --------- */
function populateKpiDrawers(){
  // Acceptance drawer
  renderKpiList(acceptanceKpis, 'acceptanceKpiOptions', 'selectAllAcceptance');
  // Monitoring drawer
  renderKpiList(monitoringKpis, 'monitoringKpiOptions', 'selectAllMonitoring');
}

function renderKpiList(kpis, containerId, selectAllId){
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  // default all checked
  kpis.forEach((kpi, idx) => {
    const div = document.createElement('div');
    div.className = 'kpiOption';
    div.innerHTML = `<input type="checkbox" class="kpiCheckbox" id="${containerId}_k${idx}" value="${kpi}" checked> <label for="${containerId}_k${idx}">${kpi}</label>`;
    container.appendChild(div);
  });

  // wire selectAll
  const selectAll = document.getElementById(selectAllId);
  if(selectAll){
    selectAll.checked = true;
    selectAll.onchange = () => {
      container.querySelectorAll('.kpiCheckbox').forEach(c => c.checked = selectAll.checked);
    };
  }
}

/* --------- Drawer toggle logic (drawer hidden until toggled) --------- */
const drawerToggle = document.getElementById('drawerToggle');
drawerToggle.addEventListener('click', () => {
  const drawer = document.getElementById(currentTab + 'Drawer');
  if (!drawer) return;
  if (drawer.style.display === 'block') {
    // slide out then hide
    drawer.classList.remove('open');
    setTimeout(() => { drawer.style.display = 'none'; drawer.setAttribute('aria-hidden', 'true'); }, 300);
  } else {
    // show then slide in
    drawer.style.display = 'block';
    // ensure the right drawer's checkboxes reflect current tab state (no auto-apply)
    // (populateKpiDrawers already created checkboxes; we leave them checked by default)
    setTimeout(() => { drawer.classList.add('open'); drawer.setAttribute('aria-hidden', 'false'); }, 10);
  }
});

/* --------- Apply buttons (apply KPI selection for each page) --------- */
document.getElementById('applyAcceptanceBtn').addEventListener('click', () => {
  selectedAcceptanceKpis = Array.from(document.querySelectorAll('#acceptanceKpiOptions .kpiCheckbox:checked')).map(c => c.value);
  const drawer = document.getElementById('acceptanceDrawer');
  drawer.classList.remove('open');
  setTimeout(() => { drawer.style.display = 'none'; drawer.setAttribute('aria-hidden', 'true'); }, 300);
  drawAcceptanceCharts();
});
document.getElementById('applyMonitoringBtn').addEventListener('click', () => {
  selectedMonitoringKpis = Array.from(document.querySelectorAll('#monitoringKpiOptions .kpiCheckbox:checked')).map(c => c.value);
  const drawer = document.getElementById('monitoringDrawer');
  drawer.classList.remove('open');
  setTimeout(() => { drawer.style.display = 'none'; drawer.setAttribute('aria-hidden', 'true'); }, 300);
  drawMonitoringCharts();
});

/* --------- Tabs handling (two pages) --------- */
let currentTab = 'acceptance';
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentTab = tab.dataset.tab;
    document.getElementById('acceptancePage').style.display = currentTab === 'acceptance' ? 'block' : 'none';
    document.getElementById('monitoringPage').style.display = currentTab === 'monitoring' ? 'block' : 'none';
    // ensure drawer for the current tab is hidden (not visible) after switching
    // (drawer remains separate per tab; don't auto-open)
    drawCurrentPageCharts();
  });
});

/* --------- Draw functions --------- */
function drawCurrentPageCharts(){
  if(currentTab === 'acceptance') drawAcceptanceCharts();
  else drawMonitoringCharts();
}

function drawAcceptanceCharts(){
  const kpis = selectedAcceptanceKpis.length ? selectedAcceptanceKpis : acceptanceKpis;
  drawCharts(kpis, 'acceptanceChartContainer');
}
function drawMonitoringCharts(){
  const kpis = selectedMonitoringKpis.length ? selectedMonitoringKpis : monitoringKpis;
  drawCharts(kpis, 'monitoringChartContainer');
}

function drawCharts(kpis, containerId){
  const container = document.getElementById(containerId);
  container.innerHTML = '';

  // build timeline (unique Dates across allData), sort DD/MM/YYYY
  const timeline = [...new Set(allData.map(d => d["Date"]))];
  timeline.sort((a,b) => {
    const [da, ma, ya] = a.split('/').map(Number);
    const [db, mb, yb] = b.split('/').map(Number);
    return new Date(ya, ma - 1, da) - new Date(yb, mb - 1, db);
  });

  const timelineLabels = timeline.map(d => {
    const [day, month] = d.split('/').map(Number);
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return `${day} ${monthNames[month - 1]}`;
  });

  kpis.forEach(kpi => {
    // card + title + canvas
    const card = document.createElement('div'); card.className = 'canvas-wrap';
    const title = document.createElement('div'); title.className = 'chart-title';

    let labelText = 'All Sites';
    if(selectedSites.length === 1) labelText = selectedSites[0];
    else if(selectedSites.length > 1 && selectedSites.length < allSites.length) labelText = 'Multiple Sites';

    title.textContent = `${kpi} - ${labelText}`;
    const canvas = document.createElement('canvas');

    card.appendChild(title);
    card.appendChild(canvas);
    container.appendChild(card);

    // filter by selectedSites (aggregation)
    let filteredData = allData;
    if(selectedSites.length > 0) filteredData = allData.filter(d => selectedSites.includes(d["eNodeB Name"]));

    // build datapoints for each date
    const dataPoints = timeline.map(date => {
      const vals = filteredData.filter(d => d["Date"] === date).map(d => {
        const v = d[kpi];
        // treat empty or non-numeric as 0
        if (v === "" || v === null || isNaN(v)) return 0;
        return v;
      });
      if(vals.length === 0) return 0;
      if(kpi.toLowerCase().includes('%') || kpi.toLowerCase().includes('rate') || kpi.toLowerCase().includes('ratio')) {
        // average for rates/percentages
        return vals.reduce((a,b) => a + b, 0) / vals.length;
      } else {
        // sum for counters
        return vals.reduce((a,b) => a + b, 0);
      }
    });

    // draw chart
    new Chart(canvas.getContext('2d'), {
      type: 'line',
      data: {
        labels: timelineLabels,
        datasets: [{
          label: labelText,
          data: dataPoints,
          borderColor: '#' + Math.floor(Math.random() * 16777215).toString(16),
          fill: false,
          tension: 0.28,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          x: { type:'number', easing:'linear', duration: animationDuration, from: NaN, delay(ctx){ return ctx.index * 8; } },
          y: { duration: 0 }
        },
        scales: { x: { display: true }, y: { beginAtZero: true, ticks: { maxTicksLimit: 6 } } },
        plugins: { legend: { position: 'top' } }
      }
    });
  });
}

/* --------- Fuzzy search dropdown (keeps site filter where it is) --------- */
const siteInput = document.getElementById('siteFilter');
const dropdown = document.getElementById('dropdown');
siteInput.addEventListener('input', () => {
  const val = siteInput.value.trim();
  if(!val || !fuse){ dropdown.style.display = 'none'; return; }
  const results = fuse.search(val, {limit: 6}).slice(0,5).map(r => r.item["eNodeB Name"]);
  dropdown.innerHTML = '';
  results.forEach(r => {
    const div = document.createElement('div');
    div.textContent = r;
    div.onclick = () => {
      siteInput.value = r;
      dropdown.style.display = 'none';
      // set single-site filter
      selectedSites = [r];
      // mark checkboxes in the site dropdown accordingly
      document.querySelectorAll('#siteDropdownList .siteOption').forEach(c => c.checked = (c.value === r));
      updateSiteButtonLabel();
      drawCurrentPageCharts();
    };
    dropdown.appendChild(div);
  });
  dropdown.style.display = results.length ? 'block' : 'none';
});
document.addEventListener('click', e => { if(e.target !== siteInput) dropdown.style.display = 'none'; });

/* --------- Refresh button --------- */
document.getElementById('refreshBtn').addEventListener('click', fetchData);

/* --------- Init --------- */
fetchData();

</script>
</body>
</html>
