<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KPI Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<style>
body { font-family: Arial; margin:0; padding:0; background:#f5f5f5; }
header { text-align:center; padding:16px; font-size:28px; font-weight:bold; }
.controls { display:flex; justify-content:center; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
#siteFilter { padding:6px; width:250px; }
button { padding:8px 16px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:bold; }
button:hover { background:#1f5ab5; }
.tabs { display:flex; justify-content:center; margin-bottom:16px; }
.tab { padding:8px 16px; cursor:pointer; border:1px solid #ccc; border-bottom:none; margin-right:4px; border-radius:8px 8px 0 0; background:#eee; }
.tab.active { background:#2F80ED; color:white; }
.chart-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:16px; padding:0 16px; }
.chart-card { padding:8px; border-radius:12px; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.chart-title { text-align:center; font-weight:bold; margin-bottom:8px; }
canvas { border-radius:12px; background:white; width:100%; height:400px; }
</style>
</head>
<body>

<header>KPI Dashboard</header>

<div class="controls">
  <input type="text" id="siteFilter" placeholder="Search eNodeB Name">
  <button id="refreshBtn">Refresh Data</button>
</div>

<div class="tabs">
  <div class="tab active" data-tab="acceptance">Acceptance KPIs</div>
  <div class="tab" data-tab="monitoring">Monitoring KPIs</div>
</div>

<div class="chart-grid" id="chartContainer"></div>

<script>
let allData = [];
let charts = [];
let fuse = null;
let currentTab = "acceptance";

// KPI groups
const acceptanceKpis = [
  "LTE RRC Setup Success Rate","ERAB Setup Success Rate","LTE Call Setup Success Rate",
  "E-RAB Call Drop Rate","CSFB Access Success Rate","LTE Intra Freq HO Success Rate",
  "Intra-eNB HO Success Rate","Inter-eNBX2HO Success Rate","Inter-eNBS1HO Success Rate",
  "Max RRC Connected Ue","DL Data Total Volume (Gbyte)","UL Data Total Volume (Gbyte)",
  "E-RAB Setup Success Rate (VoIP)","Call Drop Rate (VoIP)",
  "Intra-frequency Handover Out Success Rate(VoIP)","Inter-frequency Handover Out Success Rate(VoIP)",
  "SRVCC Success Rate (L2W)","SRVCC Success Rate (L2G)"
];

const monitoringKpis = [
  "Cell Availability Ratio","Average Latency Downlink (msecs)","DL PRB Utilization (%)",
  "UL PRB Utilization (%)","LTE DL - Cell Average Throughput (Mbit/s)","LTE UL - Cell Average Thoughput (Mbit/s)",
  "LTE DL -USER Average Throughput (Mbit/s)","LTE UL -USER Average Throughput (Mbit/s)",
  "Downlink Packet Loss Rate (VoIP)","Uplink Packet Loss Rate (VoIP)",
  "VoLTE Traffic Erlang","VoLTE Traffic DL (MB)","VoLTE Traffic UL (MB)",
  "DL BLER QCI1","UL BLER QCI1"
];

// fetch CSV
async function fetchData(){
  try{
    const res = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?output=csv");
    const csvText = await res.text();
    parseCSV(csvText);
    fuse = new Fuse(allData, { keys:['eNodeB Name'], threshold:0.4 });
    drawCharts();
  }catch(err){ console.error(err); }
}

// parse CSV
function parseCSV(csv){
  const lines = csv.split("\n").filter(l=>l.trim());
  const headers = lines[0].split(",").map(h=>h.trim());
  allData = lines.slice(1).map(line=>{
    const vals = line.split(",").map(v=>v.trim());
    const obj = {};
    headers.forEach((h,i)=>{
      const v = vals[i];
      if(v && v.match(/^\d+(\.\d+)?$/)) obj[h] = parseFloat(v);
      else obj[h] = v;
    });
    return obj;
  });
}

// draw charts
function drawCharts(){
  const container = document.getElementById("chartContainer");
  container.innerHTML = "";
  charts = [];

  const input = document.getElementById("siteFilter").value.trim().toLowerCase();
  let filteredData = allData;

  if(input && fuse){
    const result = fuse.search(input);
    filteredData = result.slice(0,5).map(r=>r.item);
  }

  if(filteredData.length === 0) return;

  const kpis = currentTab === "acceptance" ? acceptanceKpis : monitoringKpis;

  kpis.forEach(kpi=>{
    const card = document.createElement("div");
    card.className = "chart-card";
    const title = document.createElement("div");
    title.className = "chart-title";
    title.textContent = `${kpi} (${filteredData.length===allData.length?"All Sites":filteredData[0]["eNodeB Name"]})`;
    const canvas = document.createElement("canvas");
    canvas.height = 400;
    card.appendChild(title);
    card.appendChild(canvas);
    container.appendChild(card);

    const labels = [...new Set(filteredData.map(d=>d.Date))].sort();

    const datasets = [{
      label: filteredData.length===allData.length?"All Sites":filteredData[0]["eNodeB Name"],
      data: labels.map(date=>{
        const vals = filteredData.filter(f=>f.Date===date).map(f=>f[kpi]).filter(v=>typeof v==="number");
        if(kpi.includes("%") || kpi.includes("Rate") || kpi.includes("Ratio") || kpi.includes("Success")) return vals.length? (vals.reduce((a,b)=>a+b,0)/vals.length) : 0;
        return vals.length? vals.reduce((a,b)=>a+b,0) : 0;
      }),
      borderColor:'#'+Math.floor(Math.random()*16777215).toString(16),
      fill:false
    }];

    const ctx = canvas.getContext("2d");
    charts.push(new Chart(ctx,{
      type:'line',
      data:{labels,datasets},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{position:'top'}},
        scales:{x:{title:{display:true,text:'Date'}},y:{beginAtZero:true}}
      }
    }));
  });
}

// tabs
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    currentTab = tab.dataset.tab;
    drawCharts();
  });
});

// search enter
document.getElementById("siteFilter").addEventListener("keypress", e=>{
  if(e.key==="Enter") drawCharts();
});

// refresh
document.getElementById("refreshBtn").addEventListener("click", fetchData);

// initial fetch
fetchData();
</script>
</body>
</html>
