<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LTE KPI Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<style>
/* --- BASE STYLES --- */
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f4f7f6; overflow-x:hidden; }
header { text-align:center; padding:15px 0; font-size:28px; font-weight:700; color:#333; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.05); margin-bottom:15px; }

/* --- NAVIGATION --- */
.navbar { display:flex; justify-content:center; gap:12px; margin-bottom:15px; }
.nav-btn { padding:8px 24px; cursor:pointer; border:1px solid #ccc; background:white; color:#555; border-radius:20px; font-weight:600; text-decoration:none; transition:0.2s; display:inline-block; }
.nav-btn:hover { background:#f0f0f0; color:#333; }
.nav-btn.active { background:#2F80ED; color:white; border-color:#2F80ED; }

/* --- TABS --- */
.tabs { display:flex; justify-content:center; margin-bottom:20px; gap:8px; }
.tab { padding:8px 20px; cursor:pointer; border-radius:6px; background:#e0e0e0; color:#555; font-weight:bold; border:none; transition:0.2s; }
.tab:hover { background:#d0d0d0; }
.tab.active { background:#2F80ED; color:white; }

/* --- CONTROLS --- */
.controls { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
.control-group { position:relative; }
input, select { padding:8px; border-radius:6px; border:1px solid #ccc; font-size:14px; outline:none; }
button.action-btn { padding:8px 16px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:600; transition:0.2s; }
button.action-btn:hover { background:#1f5ab5; }
button.ppt-btn { background:#D24726; } /* PowerPoint Orange */
button.ppt-btn:hover { background:#a8381e; }

/* --- CHART STYLE SELECTOR (Inside Style Drawer) --- */
.style-options { 
    display: flex; 
    flex-direction: column; 
    gap: 5px; 
    margin-top: 5px;
}
.style-options button {
    background: #f0f0f0;
    color: #333;
    padding: 6px 10px;
    border: 1px solid #ddd;
    text-align: left;
}
.style-options button.active {
    background: #2F80ED;
    color: white;
    border-color: #2F80ED;
}


/* --- GRID LAYOUT (3 Graphs per row) --- */
.chart-grid { 
  display:grid; 
  grid-template-columns: repeat(3, 1fr); 
  gap:20px; 
  padding:0 20px 40px 20px; 
  max-width: 1800px; 
  margin: 0 auto; 
}
@media (max-width: 1400px) { .chart-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) { .chart-grid { grid-template-columns: 1fr; } }

/* --- CARDS & CHARTS --- */
.chart-card { background:white; border-radius:8px; padding:15px; box-shadow:0 2px 8px rgba(0,0,0,0.08); display:flex; flex-direction:column; }
.chart-title { display:none; } 
.chart-container { position: relative; height: 280px; width: 100%; }

/* --- DROPDOWNS --- */
#dropdown, #siteDropdownList, #onAirDateDropdownList { 
  position:absolute; 
  background:white; 
  border:1px solid #ccc; 
  max-height:200px; 
  overflow-y:auto; 
  display:none; 
  z-index:100; 
  width:100%; 
  top:105%; 
  border-radius:6px; 
  box-shadow:0 4px 10px rgba(0,0,0,0.1); 
}
#dropdown div, #siteDropdownList div, #onAirDateDropdownList div { padding:6px 10px; cursor:pointer; font-size:13px; border-bottom:1px solid #eee; }
#dropdown div:hover, #siteDropdownList div:hover, #onAirDateDropdownList div:hover { background:#f0f7ff; color:#2F80ED; }

/* --- DRAWER STYLES (KPI and Style) --- */
/* Base Toggle Button Style */
.drawerToggle { 
    position:fixed; 
    width:36px; 
    height:36px; 
    background:#2F80ED; 
    color:white; 
    border-radius:6px 0 0 6px; 
    cursor:pointer; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    font-size:20px; 
    z-index:900; 
    transition: right 0.3s; 
}
/* Positioning for KPI button (bottom) */
.kpiDrawerToggle { right:0; top:145px; } /* Moved down */

/* Positioning for Style button (top, just above KPI) */
.styleDrawerToggle { right:0; top:100px; } /* Moved up */ 

/* Base Drawer Style */
.drawer { 
  position:fixed; top:0; right:0; 
  width:320px; 
  height:100%; background:white; 
  box-shadow:-2px 0 10px rgba(0,0,0,0.1); z-index:1000; 
  transform:translateX(100%); transition:0.3s; padding:20px; 
  display: flex; flex-direction: column; 
}
.drawer.open { transform:translateX(0); }

/* Adjustments when drawers are open (both buttons move out of the way) */
#kpiDrawer.open ~ .styleDrawerToggle { right: 320px; }
#kpiDrawer.open ~ .kpiDrawerToggle { right: 320px; } 

/* The style drawer opens on top and doesn't need to push the KPI toggle out since it is now below it. */
#styleDrawer { z-index: 1001; }
#styleDrawer.open ~ .kpiDrawerToggle { right: 320px; }
#styleDrawer.open ~ .styleDrawerToggle { right: 320px; }


.drawer-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 10px; 
    padding-bottom: 10px; 
    border-bottom: 1px solid #eee; 
    flex-shrink: 0;
}
.drawer-header h3 { margin: 0; }
.drawer-controls { 
    display: flex; 
    gap: 5px; 
    align-items: center; 
}
.drawer-controls .action-btn { 
    padding: 6px 10px; 
    font-size: 13px; 
}
.drawer-body { flex-grow: 1; overflow-y: auto; padding-right: 5px; padding-bottom: 40px; } 

/* --- PREVIEW MODAL --- */
.modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(3px); }
.modal-content { 
    background:white; 
    width:95%; 
    max-width: 1400px; 
    height:90vh; 
    border-radius:12px; 
    display:flex; 
    flex-direction:column; 
    box-shadow:0 10px 25px rgba(0,0,0,0.3); 
}
.modal-header { padding:15px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; font-weight:bold; font-size:18px; }
.modal-body { flex:1; display: flex; padding:0; overflow: hidden; } 

/* Preview Side */
#previewBody { 
    flex: 1; 
    overflow-y:auto; 
    padding:20px; 
    background:#f5f5f5; 
}
.preview-slide { background:white; border:1px solid #ddd; margin-bottom:20px; padding:20px; box-shadow:0 2px 5px rgba(0,0,0,0.05); aspect-ratio: 16/9; position:relative; }
.preview-slide-title { position:absolute; top:10px; left:20px; font-size:16px; font-weight:bold; color:#D24726; }
.preview-grid { display:grid; height:100%; align-items:center; padding-top:30px; }
.preview-img-box { text-align:center; padding:5px; height:100%; display:flex; flex-direction:column; justify-content:center; }
.preview-img-box img { max-width:100%; max-height:calc(100% - 20px); object-fit:contain; border:1px solid #eee; }
.preview-label { display: none; } 

/* Settings Side (Fixed, not scrollable) */
#previewSettingsPanel {
    width: 250px;
    background: #fff;
    border-left: 1px solid #eee;
    padding: 20px;
    display: flex;
    flex-direction: column;
    flex-shrink: 0; 
}
.settings-group { margin-bottom: 20px; }
.settings-group h4 { margin-top: 0; margin-bottom: 10px; font-size: 14px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.graph-options button { margin: 5px; width: 100px; padding: 6px; font-size: 13px; }

/* Color Selector */
.color-option { margin: 5px; display: inline-block; cursor: pointer; border: 2px solid transparent; border-radius: 50%; width: 25px; height: 25px; transition: border 0.1s; }
.color-option.selected { border-color: #333; }

.modal-footer { 
    padding:15px 20px; 
    border-top:1px solid #eee; 
    text-align:right;
    flex-shrink: 0; 
}
</style>
</head>
<body>

<header>LTE KPI Dashboard</header>

<div class="navbar">
  <a href="gsm.html" class="nav-btn">GSM</a>
  <a href="index.html" class="nav-btn active">LTE</a>
  <a href="nr.html" class="nav-btn">NR</a>
</div>

<div class="tabs">
  <button class="tab active" onclick="switchTab('both')">All KPIs (Both)</button> 
  <button class="tab" onclick="switchTab('acceptance')">Acceptance</button>
  <button class="tab" onclick="switchTab('monitoring')">Monitoring</button>
</div>

<div class="controls">
  <div class="control-group" style="width:200px;">
    <button id="onAirDateDropdownBtn" class="action-btn" style="background:white; color:#333; border:1px solid #ccc; width:100%; text-align:left; display:flex; justify-content:space-between;">
      <span id="onAirDateBtnLabel">All On-Air Dates</span> <span>â–¼</span>
    </button>
    <div id="onAirDateDropdownList"></div>
  </div>

  <div class="control-group" style="width:200px;">
    <button id="siteDropdownBtn" class="action-btn" style="background:white; color:#333; border:1px solid #ccc; width:100%; text-align:left; display:flex; justify-content:space-between;">
      <span id="siteBtnLabel">All Sites</span> <span>â–¼</span>
    </button>
    <div id="siteDropdownList"></div>
  </div>

  <button onclick="fetchData()" class="action-btn">Refresh</button>
  <button onclick="openPreview()" class="action-btn ppt-btn">Export PPT</button>
</div>

<div class="chart-grid" id="mainChartContainer"></div>

<div class="styleDrawerToggle drawerToggle" onclick="toggleStyleDrawer()">ðŸŽ¨</div>
<div id="styleDrawer" class="drawer">
  <div class="drawer-header">
    <h3>Chart Style Settings</h3>
    <button onclick="toggleStyleDrawer()" style="border:none; background:none; font-size:24px; cursor:pointer; color:#777;">âœ•</button>
  </div>
  <div class="drawer-body">
    <h4>Chart Display Style (Select one)</h4>
    <div id="chartStyleOptions" class="style-options">
      </div>
    <p style="margin-top:20px; font-size:12px; color:#555;">Styles like 'Area Fill' use the segment painting feature you requested.</p>
  </div>
</div>

<div class="kpiDrawerToggle drawerToggle" onclick="toggleKpiDrawer()">âš™</div>
<div id="kpiDrawer" class="drawer">
  <div class="drawer-header">
    <h3>KPI Visibility Settings</h3>
    <div class="drawer-controls">
        <button class="action-btn" onclick="selectVisibleKpis()" style="background:#5cb85c;">Select All</button>
        <button class="action-btn" onclick="clearVisibleKpis()" style="background:#f0ad4e;">Clear All</button>
        <button class="action-btn" onclick="applyKpis()">Apply</button>
        <button onclick="toggleKpiDrawer()" style="border:none; background:none; font-size:24px; cursor:pointer; color:#777;">âœ•</button>
    </div>
  </div>
  <div class="drawer-body" id="kpiOptionsList">
    </div>
</div>


<div id="previewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span id="previewTitle">PPT Export Preview</span>
      <button onclick="closePreview()" style="border:none; background:none; font-size:20px; cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body">
        
        <div id="previewBody">
          </div>

        <div id="previewSettingsPanel">
            <h3>Export Settings</h3>

            <div class="settings-group">
                <h4>Graphs per Slide (Rows)</h4>
                <div class="graph-options">
                    <button class="action-btn" data-count="1" onclick="updatePreviewSettings(1, chartExportColor, chartExportTitleColor)">1 Graph</button>
                    <button class="action-btn" data-count="2" onclick="updatePreviewSettings(2, chartExportColor, chartExportTitleColor)">2 Graphs</button>
                    <button class="action-btn" data-count="3" onclick="updatePreviewSettings(3, chartExportColor, chartExportTitleColor)">3 Graphs</button>
                    <button class="action-btn" data-count="4" onclick="updatePreviewSettings(4, chartExportColor, chartExportTitleColor)">4 Graphs</button>
                    <button class="action-btn" data-count="6" onclick="updatePreviewSettings(6, chartExportColor, chartExportTitleColor)">6 Graphs</button>
                    <button class="action-btn" data-count="9" onclick="updatePreviewSettings(9, chartExportColor, chartExportTitleColor)">9 Graphs</button>
                </div>
            </div>

            <div class="settings-group">
                <h4>Line & Dot Color for PPT</h4>
                <div id="lineColorOptions">
                    <span class="color-option" style="background-color:#2F80ED;" data-color="#2F80ED" onclick="updatePreviewSettings(graphsPerSlide, '#2F80ED', chartExportTitleColor)"></span>
                    <span class="color-option" style="background-color:#27AE60;" data-color="#27AE60" onclick="updatePreviewSettings(graphsPerSlide, '#27AE60', chartExportTitleColor)"></span>
                    <span class="color-option" style="background-color:#D24726;" data-color="#D24726" onclick="updatePreviewSettings(graphsPerSlide, '#D24726', chartExportTitleColor)"></span>
                    <span class="color-option" style="background-color:#8E44AD;" data-color="#8E44AD" onclick="updatePreviewSettings(graphsPerSlide, '#8E44AD', chartExportTitleColor)"></span>
                    <span class="color-option" style="background-color:#F39C12;" data-color="#F39C12" onclick="updatePreviewSettings(graphsPerSlide, '#F39C12', chartExportTitleColor)"></span>
                </div>
            </div>

            <div class="settings-group">
                <h4>Chart Title Color for PPT</h4>
                <div id="titleColorOptions">
                    <span class="color-option" style="background-color:#333333;" data-color="#333333" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#333333')"></span>
                    <span class="color-option" style="background-color:#000000;" data-color="#000000" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#000000')"></span>
                    <span class="color-option" style="background-color:#2F80ED;" data-color="#2F80ED" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#2F80ED')"></span>
                    <span class="color-option" style="background-color:#8E44AD;" data-color="#8E44AD" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#8E44AD')"></span>
                    <span class="color-option" style="background-color:#D24726;" data-color="#D24726" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#D24726')"></span>
                </div>
            </div>

            <div style="margin-top: auto; padding-top: 15px; border-top: 1px solid #eee;">
                <p style="font-size: 12px; color: #777;">Preview updates instantly.</p>
            </div>
        </div>

    </div>
    <div class="modal-footer">
      <button class="action-btn" style="background:#888;" onclick="closePreview()">Cancel</button>
      <button class="action-btn ppt-btn" onclick="downloadPPT()">Download .PPTX</button>
    </div>
  </div>
</div>

<script>
// --- CONFIG & STATE ---
let allData = [];
let fuse = null;
let allSites = [];
let siteCutoverMap = {};Â 
let allOnAirDates = [];
let selectedOnAirDates = [];

let selectedSites = [];
let currentTab = "both";Â 
let graphsPerSlide = 2;Â 

let chartExportColor = '#2F80ED';Â 
let chartExportTitleColor = '#333333';Â 

// NEW: Expanded Chart Styles Configuration (10 styles total)
const chartStyles = {
Â  'Default': { border: 2, pointRadius: 3, tension: 0.1, gridColor: '#eee', bgColor: 'white', titleColor: '#333', fill: false, stepped: false },
Â  'Minimalist': { border: 1, pointRadius: 2, tension: 0.3, gridColor: '#f5f5f5', bgColor: 'white', titleColor: '#555', fill: false, stepped: false },
Â  'Bright Dots': { border: 3, pointRadius: 4, tension: 0.2, gridColor: '#ddd', bgColor: 'white', titleColor: '#333', fill: false, stepped: false },
Â  'Smooth & Thin': { border: 1, pointRadius: 0, tension: 0.4, gridColor: '#f0f0f0', bgColor: 'white', titleColor: '#333', fill: false, stepped: false },
Â  'Bold Lines': { border: 4, pointRadius: 0, tension: 0.1, gridColor: '#eee', bgColor: 'white', titleColor: '#333', fill: false, stepped: false },
Â  'Area Fill (Light)': { border: 2, pointRadius: 3, tension: 0.3, gridColor: '#eee', bgColor: 'white', titleColor: '#333', fill: 'origin', alpha: 0.15, stepped: false },
Â  'Shadowed Line': { border: 3, pointRadius: 4, tension: 0.2, gridColor: '#f0f0f0', bgColor: 'white', titleColor: '#333', fill: 'origin', alpha: 0.25, stepped: false },
Â  'Stepped Line': { border: 2, pointRadius: 3, tension: 0.0, gridColor: '#eee', bgColor: 'white', titleColor: '#333', fill: false, stepped: true },
Â  'High Contrast': { border: 4, pointRadius: 5, tension: 0.0, gridColor: 'rgba(0,0,0,0.1)', bgColor: 'white', titleColor: '#000', fill: false, stepped: false },
Â  'Monochromatic': { border: 3, pointRadius: 3, tension: 0.2, gridColor: '#f5f5f5', bgColor: 'white', titleColor: '#333', fill: false, stepped: false }
};
let selectedStyle = 'Default'; // Initial style

const acceptanceKpis = [
Â  "LTE RRC Setup Success Rate","ERAB Setup Success Rate","LTE Call Setup Success Rate","E-RAB Call Drop Rate",
Â  "CSFB Access Success Rate","LTE Intra Freq HO Success Rate","Intra-eNB HO Success Rate","Inter-eNBX2HO Success Rate",
Â  "Inter-eNBS1HO Success Rate","Max RRC Connected Ue","DL Data Total Volume (Gbyte)","UL Data Total Volume (Gbyte)",
Â  "E-RAB Setup Success Rate (VoIP)","Call Drop Rate (VoIP)","Intra-frequency Handover Out Success Rate(VoIP)",
Â  "Inter-frequency Handover Out Success Rate(VoIP)","SRVCC Success Rate (L2W)","SRVCC Success Rate (L2G)"
];
const monitoringKpis = [
Â  "Cell Availability Ratio","Average Latency Downlink (msecs)","DL PRB Utilization (%)","UL PRB Utilization (%)",
Â  "LTE DL - Cell Average Throughput (Mbit/s)","LTE UL - Cell Average Thoughput (Mbit/s)","LTE DL -USER Average Throughput (Mbit/s)",
Â  "LTE UL -USER Average Throughput (Mbit/s)","Downlink Packet Loss Rate (VoIP)","Uplink Packet Loss Rate (VoIP)",
Â  "VoLTE Traffic Erlang","VoLTE Traffic DL (MB)","VoLTE Traffic UL (MB)","DL BLER QCI1","UL BLER QCI1"
];
let selectedKpis = {
Â  acceptance: [...acceptanceKpis],
Â  monitoring: [...monitoringKpis]
};

// --- GLOBAL UTILITY FUNCTIONS ---

/**
 * Toggles the KPI drawer visibility.
 */
function toggleKpiDrawer(){
Â  const d = document.getElementById("kpiDrawer");
Â  const s = document.getElementById("styleDrawer");
Â  d.classList.toggle("open");
Â  if(d.classList.contains("open")) {
Â  Â  Â populateKpiOptions();
Â  Â  Â s.classList.remove("open"); // Close style drawer if KPI opens
Â  }
}

/**
 * Toggles the Chart Style drawer visibility.
 */
function toggleStyleDrawer(){
Â  const d = document.getElementById("styleDrawer");
Â  const k = document.getElementById("kpiDrawer");
Â  d.classList.toggle("open");
Â  if(d.classList.contains("open")) {
Â  Â  populateStyleOptions();
Â  Â  k.classList.remove("open"); // Close KPI drawer if Style opens
Â  }
}

/**
 * Updates the selected chart style and re-renders all charts.
 * @param {string} styleName - The name of the style from chartStyles.
 */
function updateChartStyle(styleName) {
Â  Â  selectedStyle = styleName;
Â  Â  // Visually update the button state
Â  Â  document.querySelectorAll('.style-options button').forEach(btn => {
Â  Â  Â  Â  btn.classList.remove('active');
Â  Â  Â  Â  if (btn.dataset.style === styleName) {
Â  Â  Â  Â  Â  Â  btn.classList.add('active');
Â  Â  Â  Â  }
Â  Â  });
Â  Â  renderCharts();
}

/**
 * Switches the active tab (Acceptance, Monitoring, Both).
 * @param {string} tab - The tab identifier ('acceptance', 'monitoring', 'both').
 */
function switchTab(tab) {
Â  Â  document.querySelectorAll('.tab').forEach(btn => {
Â  Â  Â  Â  btn.classList.remove('active');
Â  Â  });
Â  Â  document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
Â  Â  currentTab = tab;
Â  Â  renderCharts();Â 
}

function getRandomColor() {
Â  const colors = ['#2F80ED', '#27AE60', '#D24726', '#8E44AD', '#F39C12', '#2980B9'];
Â  return colors[Math.floor(Math.random() * colors.length)];
}

function getNiceYAxisScale(minValue, maxValue, isRateMetric) {
    if (minValue === undefined || maxValue === undefined) minValue = 0, maxValue = 0;
    let range = maxValue - minValue;

    // Handle single value or no variation
    if (range <= 0) {
        const max = isRateMetric ? Math.max(100, minValue + 0.1) : minValue + (minValue === 0 ? 10 : minValue * 0.1);
        const step = isRateMetric ? 20 : (max - 0) / 5;
        return { yMin: 0, yMax: max, yStepSize: step };
    }

    let yMin = minValue;
    let yMax = maxValue;

    // Rate metric handling
    if (isRateMetric) {
        yMin = Math.max(0, yMin);
        yMax = yMax >= 80 ? 100 : yMax; // force 100 if >=80, else leave as is
    }

    range = yMax - yMin;

    // Define nice steps
    const niceSteps = [
        0.001,0.002,0.005,0.01,0.02,0.05,0.1,0.2,0.5,1,2,5,
        10,20,50,100,200,500,1000,2000,5000,10000,20000,50000,
        100000,200000,500000,1000000,2000000,5000000,10000000
    ];

    // Choose a step size ensuring at least 5â€“6 intervals
    let roughStep = range / 6;
    let step = niceSteps.find(s => s >= roughStep) || Math.pow(10, Math.floor(Math.log10(roughStep)));

    yMin = Math.floor(yMin / step) * step;
    yMax = Math.ceil(yMax / step) * step;

    // Ensure at least 6 intervals
    let intervals = Math.ceil((yMax - yMin) / step);
    if (intervals < 6) {
        step = niceSteps.find(s => s >= (yMax - yMin) / 6) || Math.pow(10, Math.floor(Math.log10((yMax - yMin) / 6)));
        yMin = Math.floor(minValue / step) * step;
        yMax = Math.ceil(maxValue / step) * step;
    }

    // Handle small ranges <1 for precision
    if (range < 1 && !isRateMetric) {
        const decimals = Math.max(0, Math.ceil(-Math.log10(step)));
        yMin = parseFloat(yMin.toFixed(decimals));
        yMax = parseFloat(yMax.toFixed(decimals));
        step = parseFloat(step.toFixed(decimals));
    } else {
        yMin = Math.round(yMin);
        yMax = Math.round(yMax);
        step = Math.round(step);
    }

    return { yMin, yMax, yStepSize: step };
}

// --- DATA FETCHING & MAPPING ---
async function fetchData(){
Â  try {
Â  Â  // 1. Fetch KPI Data
Â  Â  const kpiUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=0&single=true&output=csv&t=" + Date.now();
Â  Â  const kpiRes = await fetch(kpiUrl);
Â  Â  const kpiText = await kpiRes.text();
Â  Â Â 
Â  Â  const kpiRows = kpiText.trim().split('\n').map(r=>r.split(','));
Â  Â  const kpiHeaders = kpiRows.shift().map(h=>h.trim());
Â  Â  allData = kpiRows.map(r=>{Â 
Â  Â  Â  const obj={};Â 
Â  Â  Â  kpiHeaders.forEach((h,i)=>{Â 
Â  Â  Â  Â  const val=r[i]?r[i].trim():"";Â 
Â  Â  Â  Â  obj[h] = val==="" ? null : (isNaN(val) ? val : parseFloat(val));Â 
Â  Â  Â  });Â 
Â  Â  Â  return obj;Â 
Â  Â  });

Â  Â  // Determine all sites present in the KPI data
Â  Â  allSites = [...new Set(allData.map(d=>d["eNodeB Name"]))].filter(s=>s).sort();

Â  Â  // 2. Fetch Cutover Data
Â  Â  const cutoverUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=19616562&single=true&output=csv&t=" + Date.now();
Â  Â  const cutoverRes = await fetch(cutoverUrl);
Â  Â  const cutoverText = await cutoverRes.text();
Â  Â Â 
Â  Â  const cutoverRows = cutoverText.trim().split('\n').map(r=>r.split(','));
Â  Â  const cutoverHeaders = cutoverRows.shift().map(h=>h.trim());
Â  Â Â 
Â  Â  siteCutoverMap = {};
Â  Â  cutoverRows.forEach(r => {
Â  Â  Â  Â  const siteName = r[cutoverHeaders.indexOf("eNodeB Name")]?.trim();
Â  Â  Â  Â  const onAirDate = r[cutoverHeaders.indexOf("On-Air Date")]?.trim();
Â  Â  Â  Â  if (siteName && onAirDate) {
Â  Â  Â  Â  Â  Â  if (allSites.includes(siteName)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â siteCutoverMap[siteName] = onAirDate;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // 3. Initialize Date Filter Options and State
Â  Â  allOnAirDates = [...new Set(Object.values(siteCutoverMap))].filter(d => d).sort();
Â  Â  selectedOnAirDates = [...allOnAirDates];Â 
Â  Â  selectedSites = [];Â 

Â  Â  // 4. Update UI
Â  Â  setupOnAirDateDropdown();
Â  Â  setupSiteDropdown();
Â  Â  renderCharts();

Â  } catch(e) { console.error(e); alert("Failed to load data."); }
}

// --- FILTER UI LOGIC (ON-AIR DATE) ---

function setupOnAirDateDropdown(){
Â  const list = document.getElementById("onAirDateDropdownList");
Â  const btn = document.getElementById("onAirDateDropdownBtn");
Â  list.innerHTML = "";
Â Â 
Â  const setAll = () => {Â 
Â  Â  selectedOnAirDates = [...allOnAirDates];Â 
Â  Â  const allActiveSites = allSites.filter(site => siteCutoverMap[site] && allOnAirDates.includes(siteCutoverMap[site]));
Â  Â  selectedSites = [...allActiveSites];Â 

Â  Â  updateDateFilterUI({close: false});Â 
Â  Â  setupSiteDropdown();Â 
Â  };

Â  const clearAll = () => {Â 
Â  Â  selectedOnAirDates = [];Â 
Â  Â  selectedSites = [];Â 
Â  Â Â 
Â  Â  updateDateFilterUI({close: false});Â 
Â  Â  setupSiteDropdown();Â 
Â  };
Â Â 
Â  // Actions
Â  list.innerHTML += `<div onclick="window.dateSetAll()"><b>Select All</b></div>`;
Â  list.innerHTML += `<div onclick="window.dateClearAll()"><b>Clear All</b></div>`;

Â  // Options
Â  allOnAirDates.forEach(date => {
Â  Â  const d = document.createElement("div");
Â  Â  const checked = selectedOnAirDates.includes(date) ? "checked" : "";
Â  Â  d.innerHTML = `<input type='checkbox' value='${date}' class='date-chk' ${checked}> ${date}`;
Â  Â  d.onclick = (e) => {
Â  Â  Â  Â if(e.target.tagName !== "INPUT") {
Â  Â  Â  Â  Â  const chk = d.querySelector("input");
Â  Â  Â  Â  Â  chk.checked = !chk.checked;
Â  Â  Â  Â }
Â  Â  Â  Â updateSelectedDates();Â 
Â  Â  };
Â  Â  list.appendChild(d);
Â  });
Â Â 
Â  btn.onclick = () => list.style.display = list.style.display==="block" ? "none" : "block";
Â Â 
Â  window.dateSetAll = setAll;
Â  window.dateClearAll = clearAll;
Â  updateDateFilterUI({close: true});Â 
}

function updateSelectedDates() {
Â  Â  const list = document.getElementById("onAirDateDropdownList");
Â  Â  selectedOnAirDates = Array.from(list.querySelectorAll(".date-chk:checked")).map(c => c.value);
Â  Â Â 
Â  Â  let activeSites = allSites.filter(site => {
Â  Â  Â  Â  const date = siteCutoverMap[site];
Â  Â  Â  Â  return date && selectedOnAirDates.includes(date);
Â  Â  });
Â  Â  selectedSites = [...activeSites];Â 
Â  Â Â 
Â  Â  updateDateFilterUI({close: false});Â 
Â  Â  setupSiteDropdown();Â 
}

function updateDateFilterUI(options = {close: true}) {
Â  Â  const btn = document.getElementById("onAirDateDropdownBtn");
Â  Â  const span = document.getElementById("onAirDateBtnLabel");
Â  Â  const list = document.getElementById("onAirDateDropdownList");
Â  Â Â 
Â  Â  span.textContent = selectedOnAirDates.length === 0 ? "No Dates Selected" : (selectedOnAirDates.length === allOnAirDates.length ? "All On-Air Dates" : `Selected (${selectedOnAirDates.length})`);
Â  Â Â 
Â  Â  list.querySelectorAll(".date-chk").forEach(c => c.checked = selectedOnAirDates.includes(c.value));
Â  Â Â 
Â  Â  if (options.close) {
Â  Â  Â  Â  list.style.display = "none";
Â  Â  } else {
Â  Â  Â  Â  list.style.display = "block";
Â  Â  }
}

// --- FILTER UI LOGIC (eNodeB NAME) ---

function setupSiteDropdown(){
Â  const list = document.getElementById("siteDropdownList");
Â  const btn = document.getElementById("siteDropdownBtn");
Â  list.innerHTML = "";

Â  let activeSites = allSites.filter(site => {
Â  Â  Â  const date = siteCutoverMap[site];
Â  Â  Â  return date && selectedOnAirDates.includes(date);
Â  });
Â Â 
Â  selectedSites = selectedSites.filter(site => activeSites.includes(site));
Â Â 
Â  const setAll = () => {Â 
Â  Â  selectedSites = [...activeSites];Â 
Â  Â  updateSiteFilterUI({close: false});Â 
Â  Â  renderCharts();
Â  };Â 

Â  const clearAll = () => {Â 
Â  Â  selectedSites = [];Â 
Â  Â  updateSiteFilterUI({close: false});Â 
Â  Â  renderCharts();Â 
Â  };
Â Â 
Â  list.innerHTML += `<div onclick="window.siteSetAll()"><b>Select All (${activeSites.length})</b></div>`;
Â  list.innerHTML += `<div onclick="window.siteClearAll()"><b>Clear All</b></div>`;

Â  activeSites.forEach(site => {
Â  Â  const d = document.createElement("div");
Â  Â  const checked = selectedSites.includes(site) ? "checked" : "";Â 
Â  Â  d.innerHTML = `<input type='checkbox' value='${site}' class='site-chk' ${checked}> ${site}`;
Â  Â  d.onclick = (e) => {
Â  Â  Â  Â if(e.target.tagName !== "INPUT") {
Â  Â  Â  Â  Â  const chk = d.querySelector("input");
Â  Â  Â  Â  Â  chk.checked = !chk.checked;
Â  Â  Â  Â }
Â  Â  Â  Â updateSelectedSites();Â 
Â  Â  };
Â  Â  list.appendChild(d);
Â  });
Â Â 
Â  btn.onclick = () => list.style.display = list.style.display==="block" ? "none" : "block";

Â  window.siteSetAll = setAll;
Â  window.siteClearAll = clearAll;
Â Â 
Â  updateSiteFilterUI({close: true});
Â  renderCharts();
}

function updateSelectedSites() {
Â  Â  const list = document.getElementById("siteDropdownList");
Â  Â  selectedSites = Array.from(list.querySelectorAll(".site-chk:checked")).map(c => c.value);
Â  Â  updateSiteFilterUI({close: false});
Â  Â  renderCharts();
}

function updateSiteFilterUI(options = {close: true}) {
Â  Â  const btn = document.getElementById("siteDropdownBtn");
Â  Â  const span = document.getElementById("siteBtnLabel");
Â  Â  const list = document.getElementById("siteDropdownList");
Â  Â Â 
Â  Â  let activeSites = allSites.filter(site => {
Â  Â  Â  Â  const date = siteCutoverMap[site];
Â  Â  Â  Â  return selectedOnAirDates.includes(date);
Â  Â  });

Â  Â  if(selectedSites.length === 0) span.textContent = "All Active Sites";
Â  Â  else if(selectedSites.length === activeSites.length) span.textContent = `All Active Sites (${selectedSites.length})`;
Â  Â  else if(selectedSites.length === 1) span.textContent = selectedSites[0];
Â  Â  else span.textContent = `Selected (${selectedSites.length})`;

Â  Â  list.querySelectorAll(".site-chk").forEach(c => c.checked = selectedSites.includes(c.value));
Â  Â Â 
Â  Â  if (options.close) {
Â  Â  Â  Â  list.style.display = "none";
Â  Â  } else {
Â  Â  Â  Â  list.style.display = "block";
Â  Â  }
}

// --- CHART RENDERING ---

function renderCharts(){
Â  const container = document.getElementById("mainChartContainer");
Â  container.innerHTML = "";
Â Â 
Â  let kpisToShow = [];
Â  if(currentTab === "acceptance") kpisToShow = selectedKpis.acceptance;
Â  else if(currentTab === "monitoring") kpisToShow = selectedKpis.monitoring;
Â  else if(currentTab === "both") kpisToShow = [...selectedKpis.acceptance, ...selectedKpis.monitoring];

Â  let sitesFromDate = allSites.filter(site => {
Â  Â  Â  const date = siteCutoverMap[site];
Â  Â  Â  return selectedOnAirDates.includes(date);
Â  });

Â  let finalSiteList;
Â  if (selectedSites.length > 0) {
Â  Â  Â  finalSiteList = selectedSites;
Â  } else {
Â  Â  Â  finalSiteList = sitesFromDate;
Â  }
Â Â 
Â  let filteredData = allData.filter(d => finalSiteList.includes(d["eNodeB Name"]));


Â  const timeline = [...new Set(filteredData.map(d=>d["Date"]))].sort((a,b)=>{
Â  Â  const [da,ma,ya]=a.split('/').map(Number);
Â  Â  const [db,mb,yb]=b.split('/').map(Number);
Â  Â  return new Date(ya,ma-1,da)-new Date(yb,mb-1,db);
Â  });

Â  const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
Â  const timelineLabels = timeline.map(d => {
Â  Â  Â  const [day, month] = d.split('/').map(Number);
Â  Â  Â  return `${day} ${monthNames[month - 1]}`;Â 
Â  });

Â  const style = chartStyles[selectedStyle];Â 
Â  document.querySelectorAll('.chart-card').forEach(card => card.style.backgroundColor = style.bgColor);

Â  kpisToShow.forEach((kpi, idx) => {
Â  Â  const card = document.createElement("div");
Â  Â  card.className = "chart-card";
Â  Â Â 
Â  Â  const wrapper = document.createElement("div");
Â  Â  wrapper.className = "chart-container";
Â  Â Â 
Â  Â  const canvas = document.createElement("canvas");
Â  Â  canvas.id = `chart_${idx}`;
Â  Â Â 
Â  Â  wrapper.appendChild(canvas);
Â  Â  card.appendChild(wrapper);
Â  Â  container.appendChild(card);

Â  Â  const dataPoints = timeline.map(date => {
Â  Â  Â  Â const vals = filteredData.filter(d => d["Date"] === date && d[kpi] !== null).map(d => d[kpi]);
Â  Â  Â  Â if(vals.length === 0) return null;
Â  Â  Â  Â const isAvg = kpi.match(/(rate|%|ratio|average)/i);
Â  Â  Â  Â const sum = vals.reduce((a,b)=>a+b,0);
Â  Â  Â  Â return isAvg ? sum/vals.length : sum;
Â  Â  });

Â  Â  // Dynamic Y-Axis Start Calculation (Applying Custom Logic)
Â  Â  const dataOnly = dataPoints.filter(v => v !== null);
Â  Â  const minValue = dataOnly.length > 0 ? Math.min(...dataOnly) : 0;
Â  Â  const maxValue = dataOnly.length > 0 ? Math.max(...dataOnly) : 100;
Â  Â  const isRateMetric = kpi.match(/(rate|success|%|ratio)/i) !== null;

Â  Â  let yMin, yMax, yStepSize;
Â  Â Â 
Â  Â  if (dataOnly.length === 0) {
Â  Â  Â  Â  // Default scale for no data
Â  Â  Â  Â  yMin = 0;
Â  Â  Â  Â  yMax = isRateMetric ? 100 : 10;
Â  Â  Â  Â  yStepSize = isRateMetric ? 20 : 2;
Â  Â  } else {
Â  Â  Â  Â  const scale = getNiceYAxisScale(minValue, maxValue, isRateMetric);
Â  Â  Â  Â  yMin = scale.yMin;
Â  Â  Â  Â  yMax = scale.yMax;
Â  Â  Â  Â  yStepSize = scale.yStepSize;
Â  Â  }
Â  Â  // End of Dynamic Y-Axis Start Calculation (Applying Custom Logic)
Â  Â Â 
Â  Â  // Determine background color for fill if neededÂ 
Â  Â  let bColor = 'transparent';
Â  Â  let lineC = getRandomColor();
Â  Â  if (style.fill) {
Â  Â  Â  Â  const hex = lineC.substring(1);
Â  Â  Â  Â  const r = parseInt(hex.substring(0, 2), 16);
Â  Â  Â  Â  const g = parseInt(hex.substring(2, 4), 16);
Â  Â  Â  Â  const b = parseInt(hex.substring(4, 6), 16);
Â  Â  Â  Â  bColor = `rgba(${r}, ${g}, ${b}, ${style.alpha || 0.15})`;
Â  Â  }


Â  Â  // Draw Chart with Animation
Â  Â  new Chart(canvas.getContext("2d"), {
Â  Â  Â  type: 'line',
Â  Â  Â  data: {
Â  Â  Â  Â  labels: timelineLabels,
Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  label: (finalSiteList.length > 0 && dataPoints.some(p => p !== null)) ? "Aggregate" : "No Data",
Â  Â  Â  Â  Â  data: dataPoints,
Â  Â  Â  Â  Â  borderColor: lineC,
Â  Â  Â  Â  Â  backgroundColor: bColor,Â 
Â  Â  Â  Â  Â  fill: style.fill,
Â  Â  Â  Â  Â  borderWidth: style.border,
Â  Â  Â  Â  Â  pointRadius: style.pointRadius,
Â  Â  Â  Â  Â  tension: style.tension,
Â  Â  Â  Â  Â  stepped: style.stepped,
Â  Â  Â  Â  Â  spanGaps: trueÂ 
Â  Â  Â  Â  }]
Â  Â  Â  },
Â  Â  Â  options: {
Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  animation: {
Â  Â  Â  Â  Â  Â  x: {
Â  Â  Â  Â  Â  Â  Â  Â  type: 'number',
Â  Â  Â  Â  Â  Â  Â  Â  easing: 'linear',
Â  Â  Â  Â  Â  Â  Â  Â  duration: 500,
Â  Â  Â  Â  Â  Â  Â  Â  from: NaN,
Â  Â  Â  Â  Â  Â  Â  Â  delay: (ctx) => ctx.index * 30Â 
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  y: { duration: 0 }
Â  Â  Â  Â  },
Â  Â  Â  Â  plugins: {Â 
Â  Â  Â  Â  Â  Â  legend: { display: false },
Â  Â  Â  Â  Â  Â  title: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  display: true,
Â  Â  Â  Â  Â  Â  Â  Â  text: kpi,
Â  Â  Â  Â  Â  Â  Â  Â  font: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: 14,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weight: 'bold'
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  color: style.titleColor
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },
Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â x: {Â 
Â  Â  Â  Â  Â  Â  Â  Â ticks: { font: {size:8} },Â 
Â  Â  Â  Â  Â  Â  Â  Â grid: {display:false}Â 
Â  Â  Â  Â  Â  Â },
Â  Â  Â  Â  Â  Â y: {Â 
Â  Â  Â  Â  Â  Â  Â  Â beginAtZero: yMin === 0,Â 
Â  Â  Â  Â  Â  Â  Â  Â min: yMin,
Â  Â  Â  Â  Â  Â  Â  Â max: yMax,
Â  Â  Â  Â  Â  Â  Â  Â ticks: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â stepSize: yStepSize // Apply the calculated step size
Â  Â  Â  Â  Â  Â  Â  Â },
Â  Â  Â  Â  Â  Â  Â  Â grid: {color: style.gridColor}
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });
Â  });
}


// --- KPI DRAWER & UTILITY LOGIC ---

function populateKpiOptions(){
Â  const kpiSection = document.getElementById("kpiOptionsList");
Â  kpiSection.innerHTML = ''; // Clear content for redraw

Â  const acceptanceSection = currentTab === 'acceptance' || currentTab === 'both';
Â  const monitoringSection = currentTab === 'monitoring' || currentTab === 'both';
Â Â 
Â  const createGroup = (title, key, sourceArr) => {
Â  Â  const h4 = document.createElement("h4");
Â  Â  h4.textContent = title;
Â  Â  h4.style.marginTop = "15px";
Â  Â  kpiSection.appendChild(h4);
Â  Â Â 
Â  Â  sourceArr.forEach(kpi => {
Â  Â  Â  const div = document.createElement("div");
Â  Â  Â  const checked = selectedKpis[key].includes(kpi) ? "checked" : "";
Â  Â  Â  div.innerHTML = `<input type='checkbox' class='kpi-chk' data-group='${key}' value='${kpi}' ${checked}> <span style='font-size:13px'>${kpi}</span>`;
Â  Â  Â  div.onclick = (e) => {
Â  Â  Â  Â  if(e.target.tagName !== "INPUT") {
Â  Â  Â  Â  Â  Â  const chk = div.querySelector("input");
Â  Â  Â  Â  Â  Â  chk.checked = !chk.checked;
Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  Â  kpiSection.appendChild(div);
Â  Â  });
Â  };

Â  if (acceptanceSection) createGroup("Acceptance KPIs", "acceptance", acceptanceKpis);
Â  if (monitoringSection) createGroup("Monitoring KPIs", "monitoring", monitoringKpis);
}

function populateStyleOptions(){
Â  const styleContainer = document.getElementById("chartStyleOptions");
Â  styleContainer.innerHTML = '';
Â  Object.keys(chartStyles).forEach(styleName => {
Â  Â  const button = document.createElement('button');
Â  Â  button.textContent = styleName;
Â  Â  button.className = 'action-btn';
Â  Â  button.setAttribute('data-style', styleName);
Â  Â  button.onclick = () => updateChartStyle(styleName);
Â  Â  if (selectedStyle === styleName) {
Â  Â  Â  Â  button.classList.add('active');
Â  Â  }
Â  Â  styleContainer.appendChild(button);
Â  });
}

function selectVisibleKpis() {
Â  Â  const chks = document.querySelectorAll(".kpi-chk");
Â  Â  chks.forEach(c => { c.checked = true; });

Â  Â  if (currentTab === 'acceptance' || currentTab === 'both') {
Â  Â  Â  Â  selectedKpis.acceptance = [...acceptanceKpis];
Â  Â  }
Â  Â  if (currentTab === 'monitoring' || currentTab === 'both') {
Â  Â  Â  Â  selectedKpis.monitoring = [...monitoringKpis];
Â  Â  }
}

function clearVisibleKpis() {
Â  Â  const chks = document.querySelectorAll(".kpi-chk");
Â  Â  chks.forEach(c => { c.checked = false; });

Â  Â  if (currentTab === 'acceptance' || currentTab === 'both') {
Â  Â  Â  Â  selectedKpis.acceptance = [];
Â  Â  }
Â  Â  if (currentTab === 'monitoring' || currentTab === 'both') {
Â  Â  Â  Â  selectedKpis.monitoring = [];
Â  Â  }
}


function applyKpis(){
Â  const chks = document.querySelectorAll(".kpi-chk");
Â Â 
Â  const tempAcceptance = currentTab === 'acceptance' || currentTab === 'both' ? [] : [...selectedKpis.acceptance];
Â  const tempMonitoring = currentTab === 'monitoring' || currentTab === 'both' ? [] : [...selectedKpis.monitoring];

Â  chks.forEach(c => {
Â  Â  if(c.checked) {
Â  Â  Â  Â  if(c.dataset.group === 'acceptance') tempAcceptance.push(c.value);
Â  Â  Â  Â  if(c.dataset.group === 'monitoring') tempMonitoring.push(c.value);
Â  Â  }
Â  });

Â  selectedKpis.acceptance = tempAcceptance;
Â  selectedKpis.monitoring = tempMonitoring;
Â Â 
Â  toggleKpiDrawer();
Â  renderCharts();
}

// --- PPT EXPORT CUSTOMIZATION & PREVIEW ---

function openPreview() {
Â  Â  const canvases = document.querySelectorAll("canvas");
Â  Â  if(canvases.length === 0) { alert("No charts to export."); return; }
Â  Â Â 
Â  Â  graphsPerSlide = 2;Â 
Â  Â  chartExportColor = '#2F80ED';Â 
Â  Â  chartExportTitleColor = '#333333';

Â  Â  updatePreviewSettings(graphsPerSlide, chartExportColor, chartExportTitleColor);
Â  Â Â 
Â  Â  document.getElementById("previewModal").style.display = "flex";
}

function highlightSettingButtons(count, lineColor, titleColor) {
Â  Â  document.querySelectorAll('.graph-options button').forEach(btn => {
Â  Â  Â  Â  btn.classList.remove('active');
Â  Â  Â  Â  btn.style.backgroundColor = '#2F80ED';
Â  Â  Â  Â  if (parseInt(btn.dataset.count) === count) {
Â  Â  Â  Â  Â  Â  btn.classList.add('active');
Â  Â  Â  Â  Â  Â  btn.style.backgroundColor = '#27AE60';Â 
Â  Â  Â  Â  }
Â  Â  });

Â  Â  document.querySelectorAll('#lineColorOptions .color-option').forEach(el => {
Â  Â  Â  Â  el.classList.remove('selected');
Â  Â  Â  Â  if (el.dataset.color === lineColor) {
Â  Â  Â  Â  Â  Â  el.classList.add('selected');
Â  Â  Â  Â  }
Â  Â  });

Â  Â  document.querySelectorAll('#titleColorOptions .color-option').forEach(el => {
Â  Â  Â  Â  el.classList.remove('selected');
Â  Â  Â  Â  if (el.dataset.color === titleColor) {
Â  Â  Â  Â  Â  Â  el.classList.add('selected');
Â  Â  Â  Â  }
Â  Â  });
}

function updatePreviewSettings(newCount, newLineColor, newTitleColor) {
Â  Â  if (newCount) graphsPerSlide = newCount;
Â  Â  if (newLineColor) chartExportColor = newLineColor;
Â  Â  if (newTitleColor) chartExportTitleColor = newTitleColor;

Â  Â  highlightSettingButtons(graphsPerSlide, chartExportColor, chartExportTitleColor);
Â  Â Â 
Â  Â  const count = graphsPerSlide;
Â  Â  const body = document.getElementById("previewBody");
Â  Â  const canvases = document.querySelectorAll("canvas");
Â  Â Â 
Â  Â  document.getElementById("previewTitle").textContent = `PPT Export Preview (${count} Graphs per Slide) - Line: ${chartExportColor}, Title: ${chartExportTitleColor}`;
Â  Â  body.innerHTML = "";

Â  Â  let gridCols = '1fr';
Â  Â  let rows = 1;
Â  Â  if (count === 2) { gridCols = '1fr 1fr'; rows = 1; }
Â  Â  else if (count === 3 || count === 6 || count === 9) { gridCols = '1fr 1fr 1fr'; }
Â  Â  else if (count === 4) { gridCols = '1fr 1fr'; rows = 2; }
Â  Â Â 
Â  Â  if (count === 6) rows = 2;
Â  Â  if (count === 9) rows = 3;


Â  Â  for(let i=0; i<canvases.length; i+=count){
Â  Â  Â  Â  const slideDiv = document.createElement("div");
Â  Â  Â  Â  slideDiv.className = "preview-slide";
Â  Â  Â  Â Â 
Â  Â  Â  Â  const slideTitle = document.createElement("div");
Â  Â  Â  Â  slideTitle.className = "preview-slide-title";
Â  Â  Â  Â  slideTitle.textContent = `Slide ${Math.floor(i/count) + 1}`;
Â  Â  Â  Â  slideDiv.appendChild(slideTitle);

Â  Â  Â  Â  const grid = document.createElement("div");
Â  Â  Â  Â  grid.className = "preview-grid";
Â  Â  Â  Â  grid.style.gridTemplateColumns = gridCols;
Â  Â  Â  Â  grid.style.gridTemplateRows = rows === 1 ? '1fr' : (rows === 2 ? '1fr 1fr' : (rows === 3 ? '1fr 1fr 1fr' : 'repeat(auto-fit, 1fr)'));


Â  Â  Â  Â  for(let j=0; j<count; j++){
Â  Â  Â  Â  Â  Â  if(i+j < canvases.length){
Â  Â  Â  Â  Â  Â  Â  Â  const c = canvases[i+j];
Â  Â  Â  Â  Â  Â  Â  Â  const box = createPreviewBox(c, chartExportColor, chartExportTitleColor);Â 
Â  Â  Â  Â  Â  Â  Â  Â  grid.appendChild(box);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  slideDiv.appendChild(grid);
Â  Â  Â  Â  body.appendChild(slideDiv);
Â  Â  }
}

function createPreviewBox(canvas, lineColor, titleColor) {
Â  const box = document.createElement("div");
Â  box.className = "preview-img-box";
Â Â 
Â  const tempCanvas = document.createElement('canvas');
Â  tempCanvas.width = canvas.width;
Â  tempCanvas.height = canvas.height;
Â  const tempCtx = tempCanvas.getContext('2d');
Â Â 
Â  const chartInstance = Chart.getChart(canvas.id);
Â  let imgData = '';
Â Â 
Â  if (chartInstance) {
Â  Â  Â  // 1. Store original chart properties
Â  Â  Â  const originalDatasetProps = chartInstance.data.datasets.map(d => ({
Â  Â  Â  Â  Â  borderColor: d.borderColor,
Â  Â  Â  Â  Â  pointBorderColor: d.pointBorderColor,
Â  Â  Â  Â  Â  pointBackgroundColor: d.pointBackgroundColor,
Â  Â  Â  Â  Â  fill: d.fill,
Â  Â  Â  Â  Â  backgroundColor: d.backgroundColor,
Â  Â  Â  Â  Â  stepped: d.stepped
Â  Â  Â  }));
Â  Â  Â  const originalTitleColor = chartInstance.options.plugins.title.color;
Â  Â  Â  const originalYMin = chartInstance.options.scales.y.min;
Â  Â  Â  const originalYMax = chartInstance.options.scales.y.max;
Â  Â  Â  const originalYStep = chartInstance.options.scales.y.ticks.stepSize;
Â  Â  Â Â 
Â  Â  Â  const style = chartStyles[selectedStyle];
Â  Â  Â Â 
Â  Â  Â  // 2. Apply PPT visual overrides (Color and Style)
Â  Â  Â  chartInstance.data.datasets.forEach(d => {Â 
Â  Â  Â  Â  d.borderColor = lineColor;Â 
Â  Â  Â  Â  d.pointBorderColor = lineColor;Â 
Â  Â  Â  Â  d.pointBackgroundColor = lineColor;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  let bColor = 'transparent';
Â  Â  Â  Â  if (style.fill) {
Â  Â  Â  Â  Â  Â  const hex = lineColor.substring(1);
Â  Â  Â  Â  Â  Â  const r = parseInt(hex.substring(0, 2), 16);
Â  Â  Â  Â  Â  Â  const g = parseInt(hex.substring(2, 4), 16);
Â  Â  Â  Â  Â  Â  const b = parseInt(hex.substring(4, 6), 16);
Â  Â  Â  Â  Â  Â  bColor = `rgba(${r}, ${g}, ${b}, ${style.alpha || 0.15})`;
Â  Â  Â  Â  }
Â  Â  Â  Â  d.backgroundColor = bColor;
Â  Â  Â  Â  d.fill = style.fill;
Â  Â  Â  Â  d.stepped = style.stepped;
Â  Â  Â  Â Â 
Â  Â  Â  Â  d.pointRadius = 3;Â 
Â  Â  Â  Â  d.pointStyle = 'circle';Â 
Â  Â  Â  Â  d.spanGaps = true;Â 
Â  Â  Â  });

Â  Â  Â  chartInstance.options.plugins.title.color = titleColor;Â 
Â  Â  Â Â 
Â  Â  Â  // 3. Apply CUSTOM Dynamic Y-Axis Scaling for Preview/PPT
Â  Â  Â  const kpi = chartInstance.options.plugins.title.text;
Â  Â  Â  const dataPoints = chartInstance.data.datasets[0].data;
Â  Â  Â  const dataOnly = dataPoints.filter(v => v !== null);
Â  Â  Â  const minValue = dataOnly.length > 0 ? Math.min(...dataOnly) : 0;
Â  Â  Â  const maxValue = dataOnly.length > 0 ? Math.max(...dataOnly) : 100;
Â  Â  Â  const isRateMetric = kpi.match(/(rate|success|%|ratio)/i) !== null;
Â  Â  Â Â 
Â  Â  Â  let pptYMin, pptYMax, pptYStep;
Â  Â  Â Â 
Â  Â  Â  if (dataOnly.length === 0) {
Â  Â  Â  Â  Â  // Use default scale for no data
Â  Â  Â  Â  Â  pptYMin = 0;
Â  Â  Â  Â  Â  pptYMax = isRateMetric ? 100 : 10;
Â  Â  Â  Â  Â  pptYStep = isRateMetric ? 20 : 2;
Â  Â  Â  } else {
Â  Â  Â  Â  Â  const scale = getNiceYAxisScale(minValue, maxValue, isRateMetric);
Â  Â  Â  Â  Â  pptYMin = scale.yMin;
Â  Â  Â  Â  Â  pptYMax = scale.yMax;
Â  Â  Â  Â  Â  pptYStep = scale.yStepSize;
Â  Â  Â  }

Â  Â  Â  chartInstance.options.scales.y.min = pptYMin;
Â  Â  Â  chartInstance.options.scales.y.max = pptYMax;
Â  Â  Â  chartInstance.options.scales.y.ticks.stepSize = pptYStep;

Â  Â  Â  chartInstance.update('none');Â 
Â  Â  Â Â 
Â  Â  Â  // 4. Draw image and restore properties
Â  Â  Â  tempCtx.drawImage(canvas, 0, 0);
Â  Â  Â  imgData = tempCanvas.toDataURL("image/png");
Â  Â  Â Â 
Â  Â  Â  // Restore original properties
Â  Â  Â  chartInstance.data.datasets.forEach((d, index) => {Â 
Â  Â  Â  Â  Object.assign(d, originalDatasetProps[index]);
Â  Â  Â  });
Â  Â  Â  chartInstance.options.plugins.title.color = originalTitleColor;
Â  Â  Â  chartInstance.options.scales.y.min = originalYMin;
Â  Â  Â  chartInstance.options.scales.y.max = originalYMax;
Â  Â  Â  chartInstance.options.scales.y.ticks.stepSize = originalYStep;
Â  Â  Â  chartInstance.update('none');
Â  }

Â  const img = document.createElement("img");
Â  img.src = imgData;
Â Â 
Â  box.appendChild(img);
Â  return box;
}

function closePreview(){ document.getElementById("previewModal").style.display = "none"; }

async function downloadPPT() {
    const pptx = new PptxGenJS();
    pptx.layout = 'LAYOUT_16x9';

    const canvases = document.querySelectorAll("canvas");
    const count = graphsPerSlide;
    const lineColor = chartExportColor;
    const titleColor = chartExportTitleColor;

    const layoutDef = {
        1: { cols: 1, rows: 1, chartW: 9.0, chartH: 5.5, padding: 0.5 },
        2: { cols: 2, rows: 1, chartW: 4.5, chartH: 3.5, padding: 0.4 },
        3: { cols: 3, rows: 1, chartW: 3.0, chartH: 3.0, padding: 0.4 },
        4: { cols: 2, rows: 2, chartW: 4.5, chartH: 2.5, padding: 0.3 },
        6: { cols: 3, rows: 2, chartW: 3.0, chartH: 2.5, padding: 0.2 },
        9: { cols: 3, rows: 3, chartW: 3.0, chartH: 1.7, padding: 0.1 } 
    }[count] || { cols: 2, rows: 1, chartW: 4.5, chartH: 3.5, padding: 0.4 };

    const numCols = layoutDef.cols;
    const numRows = layoutDef.rows;
    const chartW = layoutDef.chartW;
    const chartH = layoutDef.chartH;
    const padding = layoutDef.padding;
    const startX = 0.5;
    const startY = 1.0;
    const maxW = 9.5;

    for (let i = 0; i < canvases.length; i += count) {
        const slide = pptx.addSlide();

        const chartsThisSlide = Math.min(count, canvases.length - i);
        const layoutPositions = [];

        const totalChartWidth = numCols * chartW;
        const totalPaddingWidth = (numCols - 1) * padding;
        const remainingXSpace = maxW - totalChartWidth - totalPaddingWidth;
        const marginX = (remainingXSpace / 2) + startX;

        for (let r = 0; r < numRows; r++) {
            for (let c = 0; c < numCols; c++) {
                if (layoutPositions.length >= chartsThisSlide) break;
                const x = marginX + c * (chartW + padding);
                const y = startY + r * (chartH + padding);
                layoutPositions.push({ x, y, w: chartW, h: chartH });
            }
            if (layoutPositions.length >= chartsThisSlide) break;
        }

        for (let j = 0; j < chartsThisSlide; j++) {
            const c = canvases[i + j];
            const chartInstance = Chart.getChart(c.id);
            if (!chartInstance) continue;

            // === Store original dataset and style properties ===
            const originalDatasetProps = chartInstance.data.datasets.map(d => ({
                borderColor: d.borderColor,
                fill: d.fill,
                backgroundColor: d.backgroundColor,
                stepped: d.stepped
            }));
            const originalTitleColor = chartInstance.options.plugins.title.color;

            // Apply PPT overrides
            const style = chartStyles[selectedStyle];
            chartInstance.data.datasets.forEach(d => {
                d.borderColor = lineColor;
                let bColor = 'transparent';
                if (style.fill) {
                    const hex = lineColor.substring(1);
                    const r = parseInt(hex.substring(0,2),16);
                    const g = parseInt(hex.substring(2,4),16);
                    const b = parseInt(hex.substring(4,6),16);
                    bColor = `rgba(${r},${g},${b},${style.alpha||0.15})`;
                }
                d.backgroundColor = bColor;
                d.fill = style.fill;
                d.stepped = style.stepped;
            });
            chartInstance.options.plugins.title.color = titleColor;

            // === Use chartâ€™s existing Y-axis scale (do not recalc) ===
            chartInstance.update('none');

            const imgData = c.toDataURL("image/png");
            const { x, y, w, h } = layoutPositions[j];
            slide.addImage({ data: imgData, x, y, w, h, sizing: { type:'contain', w, h } });

            // === Restore original chart properties ===
            chartInstance.data.datasets.forEach((d, idx) => {
                Object.assign(d, originalDatasetProps[idx]);
            });
            chartInstance.options.plugins.title.color = originalTitleColor;
            chartInstance.update('none');
        }
    }

    renderCharts(); // restore dashboard charts
    pptx.writeFile({ fileName: "LTE_KPI_Report.pptx" });
    closePreview();
}


document.addEventListener('DOMContentLoaded', fetchData);
</script>
</body>
</html>
