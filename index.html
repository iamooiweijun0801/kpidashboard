<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LTE KPI Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<style>
/* --- BASE STYLES --- */
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f4f7f6; overflow-x:hidden; }
header { text-align:center; padding:15px 0; font-size:28px; font-weight:700; color:#333; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.05); margin-bottom:15px; }

/* --- NAVIGATION --- */
.navbar { display:flex; justify-content:center; gap:12px; margin-bottom:15px; }
.nav-btn { padding:8px 24px; cursor:pointer; border:1px solid #ccc; background:white; color:#555; border-radius:20px; font-weight:600; text-decoration:none; transition:0.2s; display:inline-block; }
.nav-btn:hover { background:#f0f0f0; color:#333; }
.nav-btn.active { background:#2F80ED; color:white; border-color:#2F80ED; }

/* --- TABS --- */
.tabs { display:flex; justify-content:center; margin-bottom:20px; gap:8px; }
.tab { padding:8px 20px; cursor:pointer; border-radius:6px; background:#e0e0e0; color:#555; font-weight:bold; border:none; transition:0.2s; }
.tab:hover { background:#d0d0d0; }
.tab.active { background:#2F80ED; color:white; }

/* --- CONTROLS --- */
.controls { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
.control-group { position:relative; }
input, select { padding:8px; border-radius:6px; border:1px solid #ccc; font-size:14px; outline:none; }
button.action-btn { padding:8px 16px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:600; transition:0.2s; }
button.action-btn:hover { background:#1f5ab5; }
button.ppt-btn { background:#D24726; } /* PowerPoint Orange */
button.ppt-btn:hover { background:#a8381e; }

/* --- CHART STYLE SELECTOR (Inside Style Drawer) --- */
.style-options {Â 
Â  Â  display: flex;Â 
Â  Â  flex-direction: column;Â 
Â  Â  gap: 5px;Â 
Â  Â  margin-top: 5px;
}
.style-options button {
Â  Â  background: #f0f0f0;
Â  Â  color: #333;
Â  Â  padding: 6px 10px;
Â  Â  border: 1px solid #ddd;
Â  Â  text-align: left;
}
.style-options button.active {
Â  Â  background: #2F80ED;
Â  Â  color: white;
Â  Â  border-color: #2F80ED;
}


/* --- GRID LAYOUT (3 Graphs per row) --- */
.chart-grid {Â 
Â  display:grid;Â 
Â  grid-template-columns: repeat(3, 1fr);Â 
Â  gap:20px;Â 
Â  padding:0 20px 40px 20px;Â 
Â  max-width: 1800px;Â 
Â  margin: 0 auto;Â 
}
@media (max-width: 1400px) { .chart-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) { .chart-grid { grid-template-columns: 1fr; } }

/* --- CARDS & CHARTS --- */
.chart-card { background:white; border-radius:8px; padding:15px; box-shadow:0 2px 8px rgba(0,0,0,0.08); display:flex; flex-direction:column; }
.chart-title { display:none; }Â 
.chart-container { position: relative; height: 280px; width: 100%; }

/* --- DROPDOWNS --- */
#dropdown, #siteDropdownList, #onAirDateDropdownList {Â 
Â  position:absolute;Â 
Â  background:white;Â 
Â  border:1px solid #ccc;Â 
Â  max-height:200px;Â 
Â  overflow-y:auto;Â 
Â  display:none;Â 
Â  z-index:100;Â 
Â  width:100%;Â 
Â  top:105%;Â 
Â  border-radius:6px;Â 
Â  box-shadow:0 4px 10px rgba(0,0,0,0.1);Â 
}
#dropdown div, #siteDropdownList div, #onAirDateDropdownList div { padding:6px 10px; cursor:pointer; font-size:13px; border-bottom:1px solid #eee; }
#dropdown div:hover, #siteDropdownList div:hover, #onAirDateDropdownList div:hover { background:#f0f7ff; color:#2F80ED; }

/* --- DRAWER STYLES (KPI and Style) --- */
/* Base Toggle Button Style */
.drawerToggle {Â 
Â  Â  position:fixed;Â 
Â  Â  width:36px;Â 
Â  Â  height:36px;Â 
Â  Â  background:#2F80ED;Â 
Â  Â  color:white;Â 
Â  Â  border-radius:6px 0 0 6px;Â 
Â  Â  cursor:pointer;Â 
Â  Â  display:flex;Â 
Â  Â  align-items:center;Â 
Â  Â  justify-content:center;Â 
Â  Â  font-size:20px;Â 
Â  Â  z-index:900;Â 
Â  Â  transition: right 0.3s;Â 
}
/* Positioning for Style button (top) */
.styleDrawerToggle { right:0; top:100px; }Â 

/* Positioning for KPI button (bottom) */
.kpiDrawerToggle { right:0; top:145px; }Â 

/* Base Drawer Style */
.drawer {Â 
Â  position:fixed; top:0; right:0;Â 
Â  width:320px;Â 
Â  height:100%; background:white;Â 
Â  box-shadow:-2px 0 10px rgba(0,0,0,0.1); z-index:1000;Â 
Â  transform:translateX(100%); transition:0.3s; padding:20px;Â 
Â  display: flex; flex-direction: column;Â 
}
.drawer.open { transform:translateX(0); }

/* Adjustments when drawers are open (both buttons move out of the way) */
#kpiDrawer.open ~ .styleDrawerToggle { right: 320px; }
#kpiDrawer.open ~ .kpiDrawerToggle { right: 320px; }Â 

/* The style drawer opens on top and pushes both buttons */
#styleDrawer { z-index: 1001; }
#styleDrawer.open ~ .kpiDrawerToggle { right: 320px; }
#styleDrawer.open ~ .styleDrawerToggle { right: 320px; }


.drawer-header {Â 
Â  Â  display: flex;Â 
Â  Â  justify-content: space-between;Â 
Â  Â  align-items: center;Â 
Â  Â  margin-bottom: 10px;Â 
Â  Â  padding-bottom: 10px;Â 
Â  Â  border-bottom: 1px solid #eee;Â 
Â  Â  flex-shrink: 0;
}
.drawer-header h3 { margin: 0; }
.drawer-controls {Â 
Â  Â  display: flex;Â 
Â  Â  gap: 5px;Â 
Â  Â  align-items: center;Â 
}
.drawer-controls .action-btn {Â 
Â  Â  padding: 6px 10px;Â 
Â  Â  font-size: 13px;Â 
}
.drawer-body { flex-grow: 1; overflow-y: auto; padding-right: 5px; padding-bottom: 40px; }Â 

/* --- PREVIEW MODAL --- */
.modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(3px); }
.modal-content {Â 
Â  Â  background:white;Â 
Â  Â  width:95%;Â 
Â  Â  max-width: 1400px;Â 
Â  Â  height:90vh;Â 
Â  Â  border-radius:12px;Â 
Â  Â  display:flex;Â 
Â  Â  flex-direction:column;Â 
Â  Â  box-shadow:0 10px 25px rgba(0,0,0,0.3);Â 
}
.modal-header { padding:15px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; font-weight:bold; font-size:18px; }
.modal-body { flex:1; display: flex; padding:0; overflow: hidden; }Â 

/* Preview Side */
#previewBody {Â 
Â  Â  flex: 1;Â 
Â  Â  overflow-y:auto;Â 
Â  Â  padding:20px;Â 
Â  Â  background:#f5f5f5;Â 
}
.preview-slide { 
    background:white; 
    border:1px solid #ddd; 
    margin-bottom:20px; 
    padding:20px; 
    box-shadow:0 2px 5px rgba(0,0,0,0.05); 
    aspect-ratio: 16/9; 
    position:relative; 
    display: flex;
    flex-direction: column;
}
.preview-slide-title { position:absolute; top:10px; left:20px; font-size:16px; font-weight:bold; color:var(--title-color, #D24726); z-index: 10; }
.preview-grid { 
    display:grid; 
    height:100%; 
    align-items:center; 
    padding-top:30px; 
    align-content: stretch;
    justify-content: stretch;
    grid-template-columns: repeat(var(--cols), 1fr);
    grid-template-rows: repeat(var(--rows), 1fr);
    gap: 10px;
}
.preview-img-box { 
    text-align:center; 
    padding:5px; 
    height:100%; 
    display:flex; 
    flex-direction:column; 
    justify-content:center;
}
.preview-img-box img { 
    max-width:100%; 
    max-height:100%; 
    object-fit:contain; 
    border:1px solid #eee; 
}
.preview-label { display: none; }Â 

/* Settings Side (Fixed, not scrollable) */
#previewSettingsPanel {
Â  Â  width: 250px;
Â  Â  background: #fff;
Â  Â  border-left: 1px solid #eee;
Â  Â  padding: 20px;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  flex-shrink: 0;Â 
}
.settings-group { margin-bottom: 20px; }
.settings-group h4 { margin-top: 0; margin-bottom: 10px; font-size: 14px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.graph-options button { margin: 5px; width: 100px; padding: 6px; font-size: 13px; }
.graph-options button.selected { background:#1f5ab5; }

/* Color Selector */
.color-option { margin: 5px; display: inline-block; cursor: pointer; border: 2px solid transparent; border-radius: 50%; width: 25px; height: 25px; transition: border 0.1s; }
.color-option.selected { border-color: #333; }

/* Invisible canvas container for exporting */
#exportCanvasContainer {
    position: absolute;
    top: -9999px;
    left: -9999px;
    width: 1000px; /* High resolution for export */
    height: 562.5px; /* 16:9 ratio */
    overflow: hidden;
}

.modal-footer {Â 
Â  Â  padding:15px 20px;Â 
Â  Â  border-top:1px solid #eee;Â 
Â  Â  text-align:right;
Â  Â  flex-shrink: 0;Â 
}
</style>
</head>
<body>

<header>LTE KPI Dashboard</header>

<div class="navbar">
Â  <a href="gsm.html" class="nav-btn">GSM</a>
Â  <a href="index.html" class="nav-btn active">LTE</a>
Â  <a href="nr.html" class="nav-btn">NR</a>
</div>

<div class="tabs">
Â  <button class="tab active" onclick="switchTab('both')">All KPIs (Both)</button>Â 
Â  <button class="tab" onclick="switchTab('acceptance')">Acceptance</button>
Â  <button class="tab" onclick="switchTab('monitoring')">Monitoring</button>
</div>

<div class="controls">
Â  <div class="control-group" style="width:200px;">
Â  Â  <button id="onAirDateDropdownBtn" class="action-btn" style="background:white; color:#333; border:1px solid #ccc; width:100%; text-align:left; display:flex; justify-content:space-between;">
Â  Â  Â  <span id="onAirDateBtnLabel">All On-Air Dates</span> <span>â–¼</span>
Â  Â  </button>
Â  Â  <div id="onAirDateDropdownList"></div>
Â  </div>

Â  <div class="control-group" style="width:200px;">
Â  Â  <button id="siteDropdownBtn" class="action-btn" style="background:white; color:#333; border:1px solid #ccc; width:100%; text-align:left; display:flex; justify-content:space-between;">
Â  Â  Â  <span id="siteBtnLabel">All Sites</span> <span>â–¼</span>
Â  Â  </button>
Â  Â  <div id="siteDropdownList"></div>
Â  </div>

Â  <button onclick="fetchData()" class="action-btn">Refresh</button>
Â  <button onclick="openPreview()" class="action-btn ppt-btn">Export PPT</button>
</div>

<div class="chart-grid" id="mainChartContainer"></div>

<div class="styleDrawerToggle drawerToggle" onclick="toggleStyleDrawer()">ðŸŽ¨</div>
<div id="styleDrawer" class="drawer">
Â  <div class="drawer-header">
Â  Â  <h3>Chart Style Settings</h3>
Â  Â  <button onclick="toggleStyleDrawer()" style="border:none; background:none; font-size:24px; cursor:pointer; color:#777;">âœ•</button>
Â  </div>
Â  <div class="drawer-body">
Â  Â  <h4>Chart Display Style (Select one)</h4>
Â  Â  <div id="chartStyleOptions" class="style-options">
Â  Â  Â  </div>
Â  Â  <p style="margin-top:20px; font-size:12px; color:#555;">Choose a style to adjust the line width, point size, smoothness, and background fill of the charts.</p>
Â  </div>
</div>

<div class="kpiDrawerToggle drawerToggle" onclick="toggleKpiDrawer()">âš™</div>
<div id="kpiDrawer" class="drawer">
Â  <div class="drawer-header">
Â  Â  <h3>KPI Visibility Settings</h3>
Â  Â  <div class="drawer-controls">
Â  Â  Â  Â  <button class="action-btn" onclick="selectVisibleKpis()" style="background:#5cb85c;">Select All</button>
Â  Â  Â  Â  <button class="action-btn" onclick="clearVisibleKpis()" style="background:#f0ad4e;">Clear All</button>
Â  Â  Â  Â  <button class="action-btn" onclick="applyKpis()">Apply</button>
Â  Â  Â  Â  <button onclick="toggleKpiDrawer()" style="border:none; background:none; font-size:24px; cursor:pointer; color:#777;">âœ•</button>
Â  Â  </div>
Â  </div>
Â  <div class="drawer-body" id="kpiOptionsList">
Â  Â  </div>
</div>


<div id="previewModal" class="modal">
Â  <div class="modal-content">
Â  Â  <div class="modal-header">
Â  Â  Â  <span id="previewTitle">PPT Export Preview</span>
Â  Â  Â  <button onclick="closePreview()" style="border:none; background:none; font-size:20px; cursor:pointer;">âœ•</button>
Â  Â  </div>
Â  Â  <div class="modal-body">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="previewBody">
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="previewSettingsPanel">
Â  Â  Â  Â  Â  Â  <h3>Export Settings</h3>

Â  Â  Â  Â  Â  Â  <div class="settings-group">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>Graphs per Slide (Max)</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="graph-options">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn" data-count="1" onclick="updatePreviewSettings(1, chartExportColor, chartExportTitleColor)">1 Graph</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn selected" data-count="2" onclick="updatePreviewSettings(2, chartExportColor, chartExportTitleColor)">2 Graphs</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn" data-count="3" onclick="updatePreviewSettings(3, chartExportColor, chartExportTitleColor)">3 Graphs</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn" data-count="4" onclick="updatePreviewSettings(4, chartExportColor, chartExportTitleColor)">4 Graphs</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn" data-count="6" onclick="updatePreviewSettings(6, chartExportColor, chartExportTitleColor)">6 Graphs</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn" data-count="9" onclick="updatePreviewSettings(9, chartExportColor, chartExportTitleColor)">9 Graphs</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="settings-group">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>Line & Dot Color for PPT</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="lineColorOptions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="color-option selected" style="background-color:#2F80ED;" data-color="#2F80ED" onclick="updatePreviewSettings(graphsPerSlide, '#2F80ED', chartExportTitleColor)"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="color-option" style="background-color:#27AE60;" data-color="#27AE60" onclick="updatePreviewSettings(graphsPerSlide, '#27AE60', chartExportTitleColor)"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="color-option" style="background-color:#D24726;" data-color="#D24726" onclick="updatePreviewSettings(graphsPerSlide, '#D24726', chartExportTitleColor)"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="color-option" style="background-color:#8E44AD;" data-color="#8E44AD" onclick="updatePreviewSettings(graphsPerSlide, '#8E44AD', chartExportTitleColor)"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="color-option" style="background-color:#F39C12;" data-color="#F39C12" onclick="updatePreviewSettings(graphsPerSlide, '#F39C12', chartExportTitleColor)"></span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="settings-group">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>Chart Title Color for PPT</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="titleColorOptions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="color-option selected" style="background-color:#333333;" data-color="#333333" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#333333')"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="color-option" style="background-color:#000000;" data-color="#000000" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#000000')"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="color-option" style="background-color:#2F80ED;" data-color="#2F80ED" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#2F80ED')"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="color-option" style="background-color:#8E44AD;" data-color="#8E44AD" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#8E44AD')"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="color-option" style="background-color:#D24726;" data-color="#D24726" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#D24726')"></span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="margin-top: auto; padding-top: 15px; border-top: 1px solid #eee;">
Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 12px; color: #777;">Preview updates instantly.</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  </div>
Â  Â  <div class="modal-footer">
Â  Â  Â  <button class="action-btn" style="background:#888;" onclick="closePreview()">Cancel</button>
Â  Â  Â  <button class="action-btn ppt-btn" onclick="downloadPPT()">Download .PPTX</button>
Â  Â  </div>
Â  </div>
</div>
<div id="exportCanvasContainer"></div>

<script>
// --- CONFIG & STATE ---
let allData = [];
let fuse = null;
let allSites = [];
let siteCutoverMap = {};Â 
let allOnAirDates = [];
let selectedOnAirDates = [];

let selectedSites = [];
let currentTab = "both";Â 
let graphsPerSlide = 2; // Default graphs per slideÂ 

let chartExportColor = '#2F80ED';Â 
let chartExportTitleColor = '#333333';Â 
let base64Images = []; // Array to store Base64 images for PPT

// NEW: Expanded Chart Styles Configuration (10 styles total)
const chartStyles = {
Â  'Default': { border: 2, pointRadius: 3, tension: 0.1, gridColor: '#eee', bgColor: 'white', titleColor: '#333', fill: false, stepped: false },
Â  'Minimalist': { border: 1, pointRadius: 2, tension: 0.3, gridColor: '#f5f5f5', bgColor: 'white', titleColor: '#555', fill: false, stepped: false },
Â  'Bright Dots': { border: 3, pointRadius: 4, tension: 0.2, gridColor: '#ddd', bgColor: 'white', titleColor: '#333', fill: false, stepped: false },
Â  'Smooth & Thin': { border: 1, pointRadius: 0, tension: 0.4, gridColor: '#f0f0f0', bgColor: 'white', titleColor: '#333', fill: false, stepped: false },
Â  'Bold Lines': { border: 4, pointRadius: 0, tension: 0.1, gridColor: '#eee', bgColor: 'white', titleColor: '#333', fill: false, stepped: false },
Â  'Area Fill (Light)': { border: 2, pointRadius: 3, tension: 0.3, gridColor: '#eee', bgColor: 'white', titleColor: '#333', fill: 'origin', alpha: 0.15, stepped: false },
Â  'Shadowed Line': { border: 3, pointRadius: 4, tension: 0.2, gridColor: '#f0f0f0', bgColor: 'white', titleColor: '#333', fill: 'origin', alpha: 0.25, stepped: false },
Â  'Stepped Line': { border: 2, pointRadius: 3, tension: 0.0, gridColor: '#eee', bgColor: 'white', titleColor: '#333', fill: false, stepped: true },
Â  'High Contrast': { border: 4, pointRadius: 5, tension: 0.0, gridColor: 'rgba(0,0,0,0.1)', bgColor: 'white', titleColor: '#000', fill: false, stepped: false },
Â  'Monochromatic': { border: 3, pointRadius: 3, tension: 0.2, gridColor: '#f5f5f5', bgColor: 'white', titleColor: '#333', fill: false, stepped: false }
};
let selectedStyle = 'Default'; // Initial style

const acceptanceKpis = [
Â  "LTE RRC Setup Success Rate","ERAB Setup Success Rate","LTE Call Setup Success Rate","E-RAB Call Drop Rate",
Â  "CSFB Access Success Rate","LTE Intra Freq HO Success Rate","Intra-eNB HO Success Rate","Inter-eNBX2HO Success Rate",
Â  "Inter-eNBS1HO Success Rate","Max RRC Connected Ue","DL Data Total Volume (Gbyte)","UL Data Total Volume (Gbyte)",
Â  "E-RAB Setup Success Rate (VoIP)","Call Drop Rate (VoIP)","Intra-frequency Handover Out Success Rate(VoIP)",
Â  "Inter-frequency Handover Out Success Rate(VoIP)","SRVCC Success Rate (L2W)","SRVCC Success Rate (L2G)"
];
const monitoringKpis = [
Â  "Cell Availability Ratio","Average Latency Downlink (msecs)","DL PRB Utilization (%)","UL PRB Utilization (%)",
Â  "LTE DL - Cell Average Throughput (Mbit/s)","LTE UL - Cell Average Thoughput (Mbit/s)","LTE DL -USER Average Throughput (Mbit/s)",
Â  "LTE UL -USER Average Throughput (Mbit/s)","Downlink Packet Loss Rate (VoIP)","Uplink Packet Loss Rate (VoIP)",
Â  "VoLTE Traffic Erlang","VoLTE Traffic DL (MB)","VoLTE Traffic UL (MB)","DL BLER QCI1","UL BLER QCI1"
];
let selectedKpis = {
Â  acceptance: [...acceptanceKpis],
Â  monitoring: [...monitoringKpis]
};

// --- GLOBAL UTILITY FUNCTIONS ---

/**
Â * Rounds a number up to the nearest clean scale (e.g., 3630 -> 4000, 1580 -> 1600).
Â * @param {number} value - The dynamic Ymax value calculated.
Â * @returns {number} The cleanly rounded Ymax.
Â */
function roundUpToCleanScale(value) {
Â  Â  if (value <= 20) return Math.ceil(value / 5) * 5;Â  Â  Â  // e.g., 18 -> 20
Â  Â  if (value <= 100) return Math.ceil(value / 10) * 10;Â  Â // e.g., 85 -> 90
Â  Â  if (value <= 200) return Math.ceil(value / 20) * 20;Â  Â // e.g., 165 -> 180
Â  Â  if (value <= 500) return Math.ceil(value / 50) * 50;Â  Â // e.g., 360 -> 400
Â  Â  if (value <= 1000) return Math.ceil(value / 100) * 100; // e.g., 750 -> 800
Â  Â  if (value <= 2000) return Math.ceil(value / 200) * 200; // e.g., 1580 -> 1600Â 
Â  Â  if (value <= 5000) return Math.ceil(value / 500) * 500; // e.g., 3630 -> 4000
Â  Â  if (value <= 10000) return Math.ceil(value / 1000) * 1000;
Â  Â  if (value <= 20000) return Math.ceil(value / 2000) * 2000;
Â  Â  if (value <= 50000) return Math.ceil(value / 5000) * 5000;
Â  Â  return Math.ceil(value / 10000) * 10000;
}

/**
Â * Calculates the largest clean step size that guarantees at least 'minTicks' (e.g., 5) across a range.
Â * @param {number} range - The total range (yMax - yMin).
Â * @param {number} minTicks - The minimum number of ticks desired.
Â * @returns {number} The calculated clean step size.
Â */
function getIdealTickStep(range, minTicks = 5) {
Â  Â  if (range <= 0) return 0.2;Â 

Â  Â  const targetSteps = minTicks - 1; 
Â  Â  let idealStep = range / targetSteps;

Â  Â  let power = Math.pow(10, Math.floor(Math.log10(idealStep)));
Â  Â  const cleanSteps = [5 * power, 2 * power, 1 * power];
Â  Â Â 
Â  Â  for (let step of cleanSteps) {
Â  Â  Â  Â  if (step <= idealStep + 1e-9 && step > 0) {
Â  Â  Â  Â  Â  Â  return step;
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  let smallerPower = power / 10;
Â  Â  if (5 * smallerPower > 0) {
Â  Â  Â  Â  return 5 * smallerPower;
Â  Â  }
Â  Â Â 
Â  Â  return 0.1;Â 
}

/**
 * Helper to get the list of KPIs currently selected for display based on the tab.
 * @returns {Array<string>} List of KPIs.
 */
function getVisibleKpis() {
    let kpisToShow = [];
    if(currentTab === "acceptance") kpisToShow = selectedKpis.acceptance;
    else if(currentTab === "monitoring") kpisToShow = selectedKpis.monitoring;
    else if(currentTab === "both") kpisToShow = [...selectedKpis.acceptance, ...selectedKpis.monitoring];
    return kpisToShow;
}

// --- DRAWER & UI LOGIC ---

function toggleKpiDrawer(){
Â  const d = document.getElementById("kpiDrawer");
Â  const s = document.getElementById("styleDrawer");
Â  d.classList.toggle("open");
Â  if(d.classList.contains("open")) {
Â  Â  Â // populateKpiOptions(); // Assuming this is defined elsewhere
Â  Â  Â s.classList.remove("open"); 
Â  }
}

function toggleStyleDrawer(){
Â  const d = document.getElementById("styleDrawer");
Â  const k = document.getElementById("kpiDrawer");
Â  d.classList.toggle("open");
Â  if(d.classList.contains("open")) {
Â  Â  populateStyleOptions();
Â  Â  k.classList.remove("open"); 
Â  }
}

/**
 * Populates the buttons in the style drawer.
 */
function populateStyleOptions() {
    const container = document.getElementById('chartStyleOptions');
    if (!container) return;
    container.innerHTML = '';
    Object.keys(chartStyles).forEach(styleName => {
        const btn = document.createElement('button');
        btn.textContent = styleName;
        btn.dataset.style = styleName;
        btn.onclick = () => updateChartStyle(styleName);
        if (styleName === selectedStyle) {
            btn.classList.add('active');
        }
        container.appendChild(btn);
    });
}

function updateChartStyle(styleName) {
Â  Â  selectedStyle = styleName;
Â  Â  document.querySelectorAll('.style-options button').forEach(btn => {
Â  Â  Â  Â  btn.classList.remove('active');
Â  Â  Â  Â  if (btn.dataset.style === styleName) {
Â  Â  Â  Â  Â  Â  btn.classList.add('active');
Â  Â  Â  Â  }
Â  Â  });
Â  Â  renderCharts();
}

function switchTab(tab) {
Â  Â  document.querySelectorAll('.tab').forEach(btn => {
Â  Â  Â  Â  btn.classList.remove('active');
Â  Â  });
Â  Â  document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
Â  Â  currentTab = tab;
Â  Â  renderCharts();Â 
}

// Placeholder functions for the KPI drawer (as they were in the original code)
function populateKpiOptions() { console.log("KPI options populated (placeholder)"); }
function selectVisibleKpis() { console.log("Select All KPIs (placeholder)"); }
function clearVisibleKpis() { console.log("Clear All KPIs (placeholder)"); }
function applyKpis() { console.log("Apply KPIs (placeholder)"); renderCharts(); }

// --- FILTER & DATA LOGIC (UNCHANGED) ---
async function fetchData(){
Â  try {
Â  Â  // 1. Fetch KPI Data
Â  Â  const kpiUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=0&single=true&output=csv&t=" + Date.now();
Â  Â  const kpiRes = await fetch(kpiUrl);
Â  Â  const kpiText = await kpiRes.text();
Â  Â Â 
Â  Â  const kpiRows = kpiText.trim().split('\n').map(r=>r.split(','));
Â  Â  const kpiHeaders = kpiRows.shift().map(h=>h.trim());
Â  Â  allData = kpiRows.map(r=>{Â 
Â  Â  Â  const obj={};Â 
Â  Â  Â  kpiHeaders.forEach((h,i)=>{Â 
Â  Â  Â  Â  const val=r[i]?r[i].trim():"";Â 
Â  Â  Â  Â  obj[h] = val==="" ? null : (isNaN(val) ? val : parseFloat(val));Â 
Â  Â  Â  });Â 
Â  Â  Â  return obj;Â 
Â  Â  });

Â  Â  // Determine all sites present in the KPI data
Â  Â  allSites = [...new Set(allData.map(d=>d["eNodeB Name"]))].filter(s=>s).sort();

Â  Â  // 2. Fetch Cutover Data
Â  Â  const cutoverUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=19616562&single=true&output=csv&t=" + Date.now();
Â  Â  const cutoverRes = await fetch(cutoverUrl);
Â  Â  const cutoverText = await cutoverRes.text();
Â  Â Â 
Â  Â  const cutoverRows = cutoverText.trim().split('\n').map(r=>r.split(','));
Â  Â  const cutoverHeaders = cutoverRows.shift().map(h=>h.trim());
Â  Â Â 
Â  Â  siteCutoverMap = {};
Â  Â  cutoverRows.forEach(r => {
Â  Â  Â  Â  const siteName = r[cutoverHeaders.indexOf("eNodeB Name")]?.trim();
Â  Â  Â  Â  const onAirDate = r[cutoverHeaders.indexOf("On-Air Date")]?.trim();
Â  Â  Â  Â  if (siteName && onAirDate) {
Â  Â  Â  Â  Â  Â  if (allSites.includes(siteName)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â siteCutoverMap[siteName] = onAirDate;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // 3. Initialize Date Filter Options and State
Â  Â  allOnAirDates = [...new Set(Object.values(siteCutoverMap))].filter(d => d).sort();
Â  Â  selectedOnAirDates = [...allOnAirDates];Â 
Â  Â  selectedSites = [];Â 

Â  Â  // 4. Update UI
Â  Â  setupOnAirDateDropdown();
Â  Â  setupSiteDropdown();
Â  Â  renderCharts();

Â  } catch(e) { console.error(e); alert("Failed to load data."); }
}

function setupOnAirDateDropdown(){
Â  const list = document.getElementById("onAirDateDropdownList");
Â  const btn = document.getElementById("onAirDateDropdownBtn");
Â  list.innerHTML = "";
Â Â 
Â  const setAll = () => {Â 
Â  Â  selectedOnAirDates = [...allOnAirDates];Â 
Â  Â  const allActiveSites = allSites.filter(site => siteCutoverMap[site] && allOnAirDates.includes(siteCutoverMap[site]));
Â  Â  selectedSites = [...allActiveSites];Â 

Â  Â  updateDateFilterUI({close: false});Â 
Â  Â  setupSiteDropdown();Â 
Â  };

Â  const clearAll = () => {Â 
Â  Â  selectedOnAirDates = [];Â 
Â  Â  selectedSites = [];Â 
Â  Â Â 
Â  Â  updateDateFilterUI({close: false});Â 
Â  Â  setupSiteDropdown();Â 
Â  };
Â Â 
Â  // Actions
Â  list.innerHTML += `<div onclick="window.dateSetAll()"><b>Select All</b></div>`;
Â  list.innerHTML += `<div onclick="window.dateClearAll()"><b>Clear All</b></div>`;

Â  // Options
Â  allOnAirDates.forEach(date => {
Â  Â  const d = document.createElement("div");
Â  Â  const checked = selectedOnAirDates.includes(date) ? "checked" : "";
Â  Â  d.innerHTML = `<input type='checkbox' value='${date}' class='date-chk' ${checked}> ${date}`;
Â  Â  d.onclick = (e) => {
Â  Â  Â  Â if(e.target.tagName !== "INPUT") {
Â  Â  Â  Â  Â  const chk = d.querySelector("input");
Â  Â  Â  Â  Â  chk.checked = !chk.checked;
Â  Â  Â  Â }
Â  Â  Â  Â updateSelectedDates();Â 
Â  Â  };
Â  Â  list.appendChild(d);
Â  });
Â Â 
Â  btn.onclick = () => list.style.display = list.style.display==="block" ? "none" : "block";
Â Â 
Â  window.dateSetAll = setAll;
Â  window.dateClearAll = clearAll;
Â  updateDateFilterUI({close: true});Â 
}

function updateSelectedDates() {
Â  Â  const list = document.getElementById("onAirDateDropdownList");
Â  Â  selectedOnAirDates = Array.from(list.querySelectorAll(".date-chk:checked")).map(c => c.value);
Â  Â Â 
Â  Â  let activeSites = allSites.filter(site => {
Â  Â  Â  Â  const date = siteCutoverMap[site];
Â  Â  Â  Â  return date && selectedOnAirDates.includes(date);
Â  Â  });
Â  Â  selectedSites = [...activeSites];Â 
Â  Â Â 
Â  Â  updateDateFilterUI({close: false});Â 
Â  Â  setupSiteDropdown();Â 
}

function updateDateFilterUI(options = {close: true}) {
Â  Â  const btn = document.getElementById("onAirDateDropdownBtn");
Â  Â  const span = document.getElementById("onAirDateBtnLabel");
Â  Â  const list = document.getElementById("onAirDateDropdownList");
Â  Â Â 
Â  Â  span.textContent = selectedOnAirDates.length === 0 ? "No Dates Selected" : (selectedOnAirDates.length === allOnAirDates.length ? "All On-Air Dates" : `Selected (${selectedOnAirDates.length})`);
Â  Â Â 
Â  Â  list.querySelectorAll(".date-chk").forEach(c => c.checked = selectedOnAirDates.includes(c.value));
Â  Â Â 
Â  Â  if (options.close) {
Â  Â  Â  Â  list.style.display = "none";
Â  Â  } else {
Â  Â  Â  Â  list.style.display = "block";
Â  Â  }
}

function setupSiteDropdown(){
Â  const list = document.getElementById("siteDropdownList");
Â  const btn = document.getElementById("siteDropdownBtn");
Â  list.innerHTML = "";

Â  let activeSites = allSites.filter(site => {
Â  Â  Â  const date = siteCutoverMap[site];
Â  Â  Â  return date && selectedOnAirDates.includes(date);
Â  });
Â Â 
Â  selectedSites = selectedSites.filter(site => activeSites.includes(site));
Â Â 
Â  const setAll = () => {Â 
Â  Â  selectedSites = [...activeSites];Â 
Â  Â  updateSiteFilterUI({close: false});Â 
Â  Â  renderCharts();
Â  };Â 

Â  const clearAll = () => {Â 
Â  Â  selectedSites = [];Â 
Â  Â  updateSiteFilterUI({close: false});Â 
Â  Â  renderCharts();Â 
Â  };
Â Â 
Â  list.innerHTML += `<div onclick="window.siteSetAll()"><b>Select All (${activeSites.length})</b></div>`;
Â  list.innerHTML += `<div onclick="window.siteClearAll()"><b>Clear All</b></div>`;

Â  activeSites.forEach(site => {
Â  Â  const d = document.createElement("div");
Â  Â  const checked = selectedSites.includes(site) ? "checked" : "";Â 
Â  Â  d.innerHTML = `<input type='checkbox' value='${site}' class='site-chk' ${checked}> ${site}`;
Â  Â  d.onclick = (e) => {
Â  Â  Â  Â if(e.target.tagName !== "INPUT") {
Â  Â  Â  Â  Â  const chk = d.querySelector("input");
Â  Â  Â  Â  Â  chk.checked = !chk.checked;
Â  Â  Â  Â }
Â  Â  Â  Â updateSelectedSites();Â 
Â  Â  };
Â  Â  list.appendChild(d);
Â  });
Â Â 
Â  btn.onclick = () => list.style.display = list.style.display==="block" ? "none" : "block";

Â  window.siteSetAll = setAll;
Â  window.siteClearAll = clearAll;
Â Â 
Â  updateSiteFilterUI({close: true});
Â  renderCharts();
}

function updateSelectedSites() {
Â  Â  const list = document.getElementById("siteDropdownList");
Â  Â  selectedSites = Array.from(list.querySelectorAll(".site-chk:checked")).map(c => c.value);
Â  Â  updateSiteFilterUI({close: false});
Â  Â  renderCharts();
}

function updateSiteFilterUI(options = {close: true}) {
Â  Â  const btn = document.getElementById("siteDropdownBtn");
Â  Â  const span = document.getElementById("siteBtnLabel");
Â  Â  const list = document.getElementById("siteDropdownList");
Â  Â Â 
Â  Â  let activeSites = allSites.filter(site => {
Â  Â  Â  Â  const date = siteCutoverMap[site];
Â  Â  Â  Â  return selectedOnAirDates.includes(date);
Â  Â  });

Â  Â  if(selectedSites.length === 0) span.textContent = "All Active Sites";
Â  Â  else if(selectedSites.length === activeSites.length) span.textContent = `All Active Sites (${selectedSites.length})`;
Â  Â  else if(selectedSites.length === 1) span.textContent = selectedSites[0];
Â  Â  else span.textContent = `Selected (${selectedSites.length})`;

Â  Â  list.querySelectorAll(".site-chk").forEach(c => c.checked = selectedSites.includes(c.value));
Â  Â Â 
Â  Â  if (options.close) {
Â  Â  Â  Â  list.style.display = "none";
Â  Â  } else {
Â  Â  Â  Â  list.style.display = "block";
Â  Â  }
}

// --- CHART RENDERING (SHARED LOGIC) ---
function getChartConfig(kpi, isExport, lineColor, titleColor) {
    let kpisToShow = getVisibleKpis();
    
    let sitesFromDate = allSites.filter(site => {
        const date = siteCutoverMap[site];
        return selectedOnAirDates.includes(date);
    });

    let finalSiteList;
    if (selectedSites.length > 0) {
        finalSiteList = selectedSites;
    } else {
        finalSiteList = sitesFromDate;
    }
    
    let filteredData = allData.filter(d => finalSiteList.includes(d["eNodeB Name"]));

    const timeline = [...new Set(filteredData.map(d=>d["Date"]))].sort((a,b)=>{
        const [da,ma,ya]=a.split('/').map(Number);
        const [db,mb,yb]=b.split('/').map(Number);
        return new Date(ya,ma-1,da)-new Date(yb,mb-1,db);
    });

    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const timelineLabels = timeline.map(d => {
        const [day, month] = d.split('/').map(Number);
        return `${day} ${monthNames[month - 1]}`;Â 
    });

    const dataPoints = timeline.map(date => {
        const vals = filteredData.filter(d => d["Date"] === date && d[kpi] !== null).map(d => d[kpi]);
        if(vals.length === 0) return null;
        const isAvg = kpi.match(/(rate|%|ratio|average|latency)/i);
        
        const sum = vals.reduce((a, b) => a + b, 0);
        return isAvg ? sum / vals.length : sum; 
    });

    const chartValues = dataPoints.filter(v => v !== null);
    const maxVal = chartValues.length > 0 ? Math.max(...chartValues) : 0;
    const minVal = chartValues.length > 0 ? Math.min(...chartValues) : 0;
    
    let yMax, yMin, yStep;
    
    if (kpi.match(/(rate|%|ratio|bler)/i)) { 
        yMin = Math.max(0, minVal > 0 ? Math.floor(minVal / 5) * 5 - 5 : 0); 
        yMax = kpi.includes('%') || kpi.includes('Rate') || kpi.includes('Ratio') ? 
               Math.min(100, roundUpToCleanScale(maxVal * 1.05)) : 
               roundUpToCleanScale(maxVal * 1.05);
        if (yMax < 10) yMax = 10; 
    } else { 
        yMin = 0;
        yMax = roundUpToCleanScale(maxVal * 1.05); 
    }
    
    if (yMax <= yMin) yMax = yMin + 1; 

    yStep = getIdealTickStep(yMax - yMin);
    
    // Determine style based on context
    const style = isExport ? { border: 3, pointRadius: 4, tension: 0.1, gridColor: '#ddd', titleColor: titleColor, fill: false, stepped: false } : chartStyles[selectedStyle];
    
    const config = {
        type: 'line',
        data: {
            labels: timelineLabels,
            datasets: [{
                label: kpi,
                data: dataPoints,
                borderColor: lineColor || '#2F80ED', 
                backgroundColor: `rgba(${lineColor ? parseInt(lineColor.slice(1,3), 16) : 47}, ${lineColor ? parseInt(lineColor.slice(3,5), 16) : 128}, ${lineColor ? parseInt(lineColor.slice(5,7), 16) : 237}, ${style.alpha || 0.0})`,
                borderWidth: style.border,
                pointRadius: style.pointRadius,
                tension: style.tension,
                fill: style.fill,
                stepped: style.stepped,
                spanGaps: true 
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: isExport ? false : true, // Disable animation for faster export generation
            plugins: {
                title: {
                    display: true,
                    text: kpi,
                    color: titleColor || style.titleColor,
                    font: { 
                        size: isExport ? 20 : 14, // Larger title for PPT
                        weight: 'bold' 
                    }
                },
                legend: { display: false }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Date', font: { size: isExport ? 14 : 12 } },
                    grid: { display: false },
                    ticks: { font: { size: isExport ? 12 : 10 } }
                },
                y: {
                    min: yMin,
                    max: yMax,
                    ticks: { stepSize: yStep, font: { size: isExport ? 12 : 10 } },
                    title: { 
                       display: true, 
                       text: kpi.match(/\((.*?)\)/)?.[1] || '', 
                       font: { size: isExport ? 14 : 12 } 
                    },
                    grid: { color: style.gridColor }
                }
            }
        }
    };
    return config;
}

function renderCharts(){
Â  const container = document.getElementById("mainChartContainer");
Â  container.innerHTML = "";
Â Â 
Â  const kpisToShow = getVisibleKpis();
Â  
Â  kpisToShow.forEach((kpi, idx) => {
Â  Â  const card = document.createElement("div");
Â  Â  card.className = "chart-card";
Â  Â  card.style.backgroundColor = chartStyles[selectedStyle].bgColor; 
Â  Â Â 
Â  Â  const wrapper = document.createElement("div");
Â  Â  wrapper.className = "chart-container";
Â  Â Â 
Â  Â  const canvas = document.createElement("canvas");
Â  Â  canvas.id = `chart_${idx}`;
Â  Â Â 
Â  Â  wrapper.appendChild(canvas);
Â  Â  card.appendChild(wrapper);
Â  Â  container.appendChild(card);

    // Render the chart using the config generator
    const config = getChartConfig(kpi, false, null, null);
    new Chart(canvas, config);
Â  }); 
}

// --- PPT EXPORT FUNCTIONS (COMPLETED) ---

function closePreview() { 
    document.getElementById('previewModal').style.display = 'none'; 
    // Clear the hidden canvas container to release Chart.js instances
    document.getElementById('exportCanvasContainer').innerHTML = ''; 
}

function openPreview() { 
    document.getElementById('previewModal').style.display = 'flex'; 
    updatePreviewSettings(graphsPerSlide, chartExportColor, chartExportTitleColor);
}

function getGridSize(count) {
    if (count <= 1) return { rows: 1, cols: 1 };
    if (count <= 2) return { rows: 1, cols: 2 };
    if (count <= 3) return { rows: 1, cols: 3 };
    if (count <= 4) return { rows: 2, cols: 2 };
    if (count <= 6) return { rows: 2, cols: 3 };
    return { rows: 3, cols: 3 }; // Max 9
}

async function renderExportCharts(kpis, lineColor, titleColor) {
    base64Images = [];
    const container = document.getElementById('exportCanvasContainer');
    container.innerHTML = '';
    
    // Create and render all charts invisibly
    const charts = kpis.map((kpi, index) => {
        const canvas = document.createElement('canvas');
        canvas.id = `export_chart_${index}`;
        container.appendChild(canvas);
        
        const config = getChartConfig(kpi, true, lineColor, titleColor);
        return new Chart(canvas, config);
    });

    // Wait for Chart.js to finish drawing (100ms is usually enough)
    await new Promise(resolve => setTimeout(resolve, 100));

    // Convert all canvases to Base64 image data
    charts.forEach(chart => {
        const canvas = chart.canvas;
        // Use a higher DPI for better print quality (e.g., toDataURL('image/jpeg', 0.9))
        base64Images.push({
            kpi: chart.config.data.datasets[0].label,
            dataUrl: canvas.toDataURL('image/png', 1.0) 
        });
        chart.destroy(); // Clean up Chart.js instance
    });
    
    return base64Images;
}

async function updatePreviewSettings(newGraphsPerSlide, lineColor, titleColor) {
    graphsPerSlide = newGraphsPerSlide;
    chartExportColor = lineColor;
    chartExportTitleColor = titleColor;

    const previewBody = document.getElementById('previewBody');
    const kpis = getVisibleKpis();
    
    if (kpis.length === 0) {
        previewBody.innerHTML = '<p style="text-align:center; color:#555;">No KPIs selected to preview.</p>';
        return;
    }
    
    // 1. Render all charts invisibly and get Base64 images
    const images = await renderExportCharts(kpis, lineColor, titleColor);

    // 2. Update UI (color selectors and graph count button)
    document.querySelectorAll('.graph-options button').forEach(btn => {
        btn.classList.remove('selected');
        if (parseInt(btn.dataset.count) === graphsPerSlide) {
            btn.classList.add('selected');
        }
    });
    document.querySelectorAll('#lineColorOptions .color-option').forEach(span => {
        span.classList.remove('selected');
        if (span.dataset.color === lineColor) {
            span.classList.add('selected');
        }
    });
    document.querySelectorAll('#titleColorOptions .color-option').forEach(span => {
        span.classList.remove('selected');
        if (span.dataset.color === titleColor) {
            span.classList.add('selected');
        }
    });

    // 3. Render visible preview slides
    previewBody.innerHTML = '';
    let slideIndex = 0;

    for (let i = 0; i < images.length; i += graphsPerSlide) {
        const slideKpis = images.slice(i, i + graphsPerSlide);
        const slide = document.createElement('div');
        slide.className = 'preview-slide';
        
        // Use CSS variables for dynamic grid layout based on graphsPerSlide
        const { rows, cols } = getGridSize(slideKpis.length);
        slide.style.setProperty('--rows', rows);
        slide.style.setProperty('--cols', cols);
        slide.style.setProperty('--title-color', titleColor);

        slide.innerHTML = `<div class="preview-slide-title">Slide ${++slideIndex}</div><div class="preview-grid"></div>`;
        const grid = slide.querySelector('.preview-grid');
        
        slideKpis.forEach(img => {
            const imgBox = document.createElement('div');
            imgBox.className = 'preview-img-box';
            imgBox.innerHTML = `<img src="${img.dataUrl}" alt="${img.kpi}" />`;
            grid.appendChild(imgBox);
        });
        
        previewBody.appendChild(slide);
    }
}


async function downloadPPT() {
    if (base64Images.length === 0) {
        alert("Please wait for the charts to render in the preview before exporting.");
        return;
    }

    const pptx = new pptxgen();
    pptx.layout = 'LAYOUT_WIDE'; // 16:9 layout
    const kpis = getVisibleKpis();
    const siteString = selectedSites.length === 0 ? "All Sites" : (selectedSites.length === 1 ? selectedSites[0] : `${selectedSites.length} Sites`);
    const dateRange = kpis.length > 0 && kpis[0] ? `Data from ${kpis[0].timelineLabels[0]} to ${kpis[0].timelineLabels[kpis[0].timelineLabels.length - 1]}` : 'KPI Data';

    // Title Slide
    const titleSlide = pptx.addSlide();
    titleSlide.addText(
        'LTE KPI Dashboard Report', 
        { x: 0.5, y: 1.5, w: '90%', h: 1, fontSize: 36, color: 'D24726', align: 'center' }
    );
    titleSlide.addText(
        `${kpis.length} KPIs for ${siteString} (${currentTab.toUpperCase()})`,
        { x: 0.5, y: 3, w: '90%', h: 0.5, fontSize: 24, color: '333333', align: 'center' }
    );
    titleSlide.addText(
        `Generated: ${new Date().toLocaleDateString()}`,
        { x: 0.5, y: 5, w: '90%', h: 0.5, fontSize: 14, color: '777777', align: 'center' }
    );

    // Content Slides
    const totalSlides = Math.ceil(base64Images.length / graphsPerSlide);
    const { rows, cols } = getGridSize(graphsPerSlide);

    for (let i = 0; i < totalSlides; i++) {
        const slide = pptx.addSlide();
        const start = i * graphsPerSlide;
        const end = Math.min(start + graphsPerSlide, base64Images.length);
        const slideImages = base64Images.slice(start, end);
        
        slide.addText(
            `LTE KPI Trends (${i + 1}/${totalSlides}) - ${siteString}`,
            { x: 0.5, y: 0.25, w: '90%', h: 0.5, fontSize: 18, color: 'D24726', bold: true }
        );

        // Calculate positions based on rows/cols for 16:9 slide (10in x 5.625in)
        const slideW = 9.3; 
        const slideH = 4.8; 
        const chartW = slideW / cols;
        const chartH = slideH / rows;
        const xOffset = 0.35; 
        const yOffset = 0.8; 

        slideImages.forEach((img, j) => {
            const col = j % cols;
            const row = Math.floor(j / cols);

            // Add the image (chart)
            slide.addImage({
                data: img.dataUrl,
                x: xOffset + col * chartW,
                y: yOffset + row * chartH,
                w: chartW - 0.1, // Small margin
                h: chartH - 0.1, 
            });
        });
    }

    pptx.writeFile({ fileName: `LTE_KPI_Dashboard_Export_${new Date().toISOString().slice(0, 10)}.pptx` });
    
    // Optional: Close modal after download begins
    closePreview(); 
}

// --- INITIALIZATION ---
window.onload = () => {
    fetchData();
    populateStyleOptions();
};
</script>
</body>
</html>
