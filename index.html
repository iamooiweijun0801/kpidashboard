<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KPI Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<style>
body { font-family: Arial; margin:0; padding:0; background:#f5f5f5; }
header { text-align:center; padding:16px; font-size:28px; font-weight:bold; }
.controls { display:flex; justify-content:center; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
#siteFilter { padding:6px; width:250px; }
button { padding:8px 16px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:bold; }
button:hover { background:#1f5ab5; }
.chart-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(450px,1fr)); gap:16px; padding:0 16px; }
.chart-card { padding:8px; border-radius:12px; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.1); display:flex; flex-direction:column; align-items:center; }
.chart-title { font-weight:bold; margin-bottom:4px; text-align:center; }
.site-name { font-size:14px; color:#555; margin-bottom:8px; text-align:center; }
canvas { background:white; border-radius:12px; }
</style>
</head>
<body>

<header>KPI Dashboard</header>

<div class="controls">
  <input type="text" id="siteFilter" placeholder="Search eNodeB Name">
  <button id="refreshBtn">Refresh Data</button>
</div>

<div class="chart-grid" id="chartContainer"></div>

<script>
let allData = [];
let charts = [];
let fuse = null;

// KPI groups
const acceptanceKpis = [
  "LTE RRC Setup Success Rate",
  "ERAB Setup Success Rate",
  "LTE Call Setup Success Rate",
  "E-RAB Call Drop Rate",
  "CSFB Access Success Rate",
  "LTE Intra Freq HO Success Rate",
  "Intra-eNB HO Success Rate",
  "Inter-eNBX2HO Success Rate",
  "Inter-eNBS1HO Success Rate",
  "Max RRC Connected Ue",
  "DL Data Total Volume (Gbyte)",
  "UL Data Total Volume (Gbyte)",
  "E-RAB Setup Success Rate (VoIP)",
  "Call Drop Rate (VoIP)",
  "Intra-frequency Handover Out Success Rate(VoIP)",
  "Inter-frequency Handover Out Success Rate(VoIP)",
  "SRVCC Success Rate (L2W)",
  "SRVCC Success Rate (L2G)"
];

const monitoringKpis = [
  "Cell Availability Ratio",
  "Average Latency Downlink (msecs)",
  "DL PRB Utilization (%)",
  "UL PRB Utilization (%)",
  "LTE DL - Cell Average Throughput (Mbit/s)",
  "LTE UL - Cell Average Thoughput (Mbit/s)",
  "LTE DL -USER Average Throughput (Mbit/s)",
  "LTE UL -USER Average Throughput (Mbit/s)",
  "Downlink Packet Loss Rate (VoIP)",
  "Uplink Packet Loss Rate (VoIP)",
  "VoLTE Traffic Erlang",
  "VoLTE Traffic DL (MB)",
  "VoLTE Traffic UL (MB)",
  "DL BLER QCI1",
  "UL BLER QCI1"
];

// Fetch KPI CSV from Google Sheets
async function fetchData() {
  try {
    const res = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?output=csv");
    const text = await res.text();
    allData = parseCSV(text);
    fuse = new Fuse(allData, { keys:['eNodeB Name'], threshold:0.4 });
    drawCharts();
  } catch (err) { console.error(err); }
}

// CSV parser to array of objects
function parseCSV(csvText) {
  const [headerLine, ...lines] = csvText.split('\n').filter(l => l.trim());
  const headers = headerLine.split(',');
  return lines.map(line => {
    const values = line.split(',');
    const obj = {};
    headers.forEach((h,i) => obj[h.trim()] = isNaN(values[i]) ? values[i].trim() : parseFloat(values[i]));
    return obj;
  });
}

// Draw charts
function drawCharts() {
  const container = document.getElementById("chartContainer");
  container.innerHTML = "";
  charts = [];

  const siteName = document.getElementById("siteFilter").value.trim().toLowerCase();
  let filteredData = allData;

  if(siteName && fuse){
    const result = fuse.search(siteName);
    filteredData = result.length ? [result[0].item] : [];
  }

  if(filteredData.length === 0) return;

  const kpiGroups = [
    {title:'Acceptance KPIs', list:acceptanceKpis},
    {title:'Monitoring KPIs', list:monitoringKpis}
  ];

  kpiGroups.forEach(group=>{
    group.list.forEach(kpi=>{
      const card = document.createElement("div");
      card.className = "chart-card";

      const kpiTitle = document.createElement("div");
      kpiTitle.className = "chart-title";
      kpiTitle.textContent = kpi;

      const siteTitle = document.createElement("div");
      siteTitle.className = "site-name";
      siteTitle.textContent = filteredData.length === allData.length ? "All Sites" :
                              filteredData.length === 1 ? filteredData[0]["eNodeB Name"] : "Multiple Sites";

      const canvas = document.createElement("canvas");
      canvas.width = 400; canvas.height = 250;

      card.appendChild(kpiTitle);
      card.appendChild(siteTitle);
      card.appendChild(canvas);
      container.appendChild(card);

      // Aggregate data if multiple sites: average for percentages/ratios
      const datasets = [{
        label: siteTitle.textContent,
        data: group.list.includes(kpi) ? filteredData.map(r => r[kpi]||0) : [],
        borderColor:'#'+Math.floor(Math.random()*16777215).toString(16),
        fill:false
      }];

      const ctx = canvas.getContext("2d");
      charts.push(new Chart(ctx, {
        type:'line',
        data:{ labels: filteredData.map(r => r["Date"]), datasets },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{legend:{position:'top'}},
          scales:{y:{beginAtZero:true}}
        }
      }));
    });
  });
}

// Fuzzy search input
document.getElementById("siteFilter").addEventListener("input", drawCharts);

// Refresh button
document.getElementById("refreshBtn").addEventListener("click", fetchData);

// Initial load
fetchData();
</script>
</body>
</html>
