<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LTE KPI Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<style>
/* --- BASE STYLES --- */
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f4f7f6; overflow-x:hidden; }
header { text-align:center; padding:15px 0; font-size:28px; font-weight:700; color:#333; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.05); margin-bottom:15px; }

/* --- NAVIGATION --- */
.navbar { display:flex; justify-content:center; gap:12px; margin-bottom:15px; }
.nav-btn { padding:8px 24px; cursor:pointer; border:1px solid #ccc; background:white; color:#555; border-radius:20px; font-weight:600; text-decoration:none; transition:0.2s; display:inline-block; }
.nav-btn:hover { background:#f0f0f0; color:#333; }
.nav-btn.active { background:#2F80ED; color:white; border-color:#2F80ED; }

/* --- TABS --- */
.tabs { display:flex; justify-content:center; margin-bottom:20px; gap:8px; }
.tab { padding:8px 20px; cursor:pointer; border-radius:6px; background:#e0e0e0; color:#555; font-weight:bold; border:none; transition:0.2s; }
.tab:hover { background:#d0d0d0; }
.tab.active { background:#2F80ED; color:white; }

/* --- CONTROLS --- */
.controls { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
.control-group { position:relative; }
input, select { padding:8px; border-radius:6px; border:1px solid #ccc; font-size:14px; outline:none; }
button.action-btn { padding:8px 16px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:600; transition:0.2s; }
button.action-btn:hover { background:#1f5ab5; }
button.ppt-btn { background:#D24726; } /* PowerPoint Orange */
button.ppt-btn:hover { background:#a8381e; }

/* --- GRID LAYOUT (3 Graphs per row) --- */
.chart-grid { 
  display:grid; 
  grid-template-columns: repeat(3, 1fr); 
  gap:20px; 
  padding:0 20px 40px 20px; 
  max-width: 1800px; 
  margin: 0 auto; 
}
@media (max-width: 1400px) { .chart-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) { .chart-grid { grid-template-columns: 1fr; } }

/* --- CARDS & CHARTS --- */
.chart-card { background:white; border-radius:8px; padding:15px; box-shadow:0 2px 8px rgba(0,0,0,0.08); display:flex; flex-direction:column; }
.chart-title { text-align:center; font-weight:bold; margin-bottom:10px; color:#333; font-size:14px; min-height:35px; display:flex; align-items:center; justify-content:center; }
.chart-container { position: relative; height: 280px; width: 100%; }

/* --- DROPDOWNS --- */
#dropdown, #siteDropdownList { position:absolute; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; display:none; z-index:100; width:100%; top:105%; border-radius:6px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
#dropdown div, #siteDropdownList div { padding:6px 10px; cursor:pointer; font-size:13px; border-bottom:1px solid #eee; }
#dropdown div:hover, #siteDropdownList div:hover { background:#f0f7ff; color:#2F80ED; }

/* --- KPI Drawer Fixes --- */
.kpiDrawerToggle { position:fixed; top:100px; right:0; width:36px; height:36px; background:#2F80ED; color:white; border-radius:6px 0 0 6px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:20px; z-index:900; }
.kpiDrawer { 
  position:fixed; top:0; right:0; 
  width:320px; 
  height:100%; background:white; 
  box-shadow:-2px 0 10px rgba(0,0,0,0.1); z-index:1000; 
  transform:translateX(100%); transition:0.3s; padding:20px; 
  display: flex; flex-direction: column; 
}
.kpiDrawer.open { transform:translateX(0); }
.drawer-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 10px; 
    padding-bottom: 10px; 
    border-bottom: 1px solid #eee; 
}
.drawer-header h3 { margin: 0; }
.drawer-controls { display: flex; gap: 10px; align-items: center; }
.kpi-options-body { flex-grow: 1; overflow-y: auto; padding-right: 5px; padding-bottom: 40px; } /* Added padding-bottom here */

/* --- MODALS --- */
.modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(3px); }
.modal-content { background:white; width:900px; height:85vh; border-radius:12px; display:flex; flex-direction:column; box-shadow:0 10px 25px rgba(0,0,0,0.3); }
.modal-header { padding:15px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; font-weight:bold; font-size:18px; }
.modal-body { flex:1; overflow-y:auto; padding:20px; background:#f5f5f5; }
.preview-slide { background:white; border:1px solid #ddd; margin-bottom:20px; padding:20px; box-shadow:0 2px 5px rgba(0,0,0,0.05); aspect-ratio: 16/9; position:relative; }
.preview-slide-title { position:absolute; top:10px; left:20px; font-size:16px; font-weight:bold; color:#D24726; }
.preview-grid { display:grid; height:100%; align-items:center; padding-top:30px; }
.preview-img-box { text-align:center; padding:5px; height:100%; display:flex; flex-direction:column; justify-content:center; }
.preview-img-box img { max-width:100%; max-height:calc(100% - 20px); object-fit:contain; border:1px solid #eee; }
.preview-label { font-size:12px; margin-top:5px; font-weight:bold; }
.modal-footer { padding:15px; border-top:1px solid #eee; text-align:right; }

/* Modal for Graph Count and Color Selection */
.selection-modal-content { width: 450px; height: auto; text-align: center; }
.graph-options button { margin: 8px; width: 120px; }
.color-select-group { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
.color-option { margin: 5px; display: inline-block; cursor: pointer; border: 2px solid transparent; border-radius: 50%; width: 25px; height: 25px; }
.color-option.selected { border-color: #333; }
</style>
</head>
<body>

<header>LTE KPI Dashboard</header>

<div class="navbar">
  <a href="gsm.html" class="nav-btn">GSM</a>
  <a href="index.html" class="nav-btn active">LTE</a>
  <a href="nr.html" class="nav-btn">NR</a>
  <a href="nsa.html" class="nav-btn">NSA</a>
</div>

<div class="tabs">
  <button class="tab active" onclick="switchTab('acceptance')">Acceptance</button>
  <button class="tab" onclick="switchTab('monitoring')">Monitoring</button>
  <button class="tab" onclick="switchTab('both')">All KPIs (Both)</button>
</div>

<div class="controls">
  <div class="control-group">
    <input type="text" id="siteFilter" placeholder="Search Site..." style="width:180px;">
    <div id="dropdown"></div>
  </div>

  <div class="control-group" style="width:200px;">
    <button id="siteDropdownBtn" class="action-btn" style="background:white; color:#333; border:1px solid #ccc; width:100%; text-align:left; display:flex; justify-content:space-between;">
      <span id="siteBtnLabel">All Sites</span> <span>▼</span>
    </button>
    <div id="siteDropdownList"></div>
  </div>

  <button onclick="fetchData()" class="action-btn">Refresh</button>
  <button onclick="openExportOptions()" class="action-btn ppt-btn">Export PPT</button>
</div>

<div class="chart-grid" id="mainChartContainer"></div>

<div class="kpiDrawerToggle" onclick="toggleDrawer()">⚙</div>
<div id="kpiDrawer" class="kpiDrawer">
  <div class="drawer-header">
    <h3 id="drawerHeaderTitle">KPI Settings</h3>
    <div class="drawer-controls">
        <button class="action-btn" onclick="applyKpis()">Apply</button>
        <button onclick="toggleDrawer()" style="border:none; background:none; font-size:24px; cursor:pointer; color:#777;">✕</button>
    </div>
  </div>
  <div class="kpi-options-body" id="kpiOptionsList"></div>
</div>

<div id="exportSelectionModal" class="modal">
  <div class="modal-content selection-modal-content">
    <div class="modal-header" style="justify-content: center;">
      <span>PPT Export Settings</span>
    </div>
    <div class="modal-body" style="background:white; padding: 20px;">
        
      <p style="margin-bottom: 15px; font-weight: bold;">1. Graphs per Slide (Default: 2)</p>
      <div class="graph-options">
        <button class="action-btn" onclick="startPreview(1)">1 Graph</button>
        <button class="action-btn" onclick="startPreview(2)" style="background:#27AE60;">2 Graphs (Default)</button>
        <button class="action-btn" onclick="startPreview(3)">3 Graphs</button>
        <button class="action-btn" onclick="startPreview(4)">4 Graphs</button>
      </div>
      
      <div class="color-select-group">
        <p style="margin-bottom: 15px; font-weight: bold;">2. Export Line Color</p>
        <div id="colorOptions">
            <span class="color-option selected" style="background-color:#2F80ED;" data-color="#2F80ED" onclick="selectColor(this)"></span>
            <span class="color-option" style="background-color:#27AE60;" data-color="#27AE60" onclick="selectColor(this)"></span>
            <span class="color-option" style="background-color:#D24726;" data-color="#D24726" onclick="selectColor(this)"></span>
            <span class="color-option" style="background-color:#8E44AD;" data-color="#8E44AD" onclick="selectColor(this)"></span>
            <span class="color-option" style="background-color:#F39C12;" data-color="#F39C12" onclick="selectColor(this)"></span>
        </div>
        <p style="margin-top: 10px; font-size: 12px; color: #777;">Click a number above to start the preview.</p>
      </div>
    </div>
  </div>
</div>

<div id="previewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span id="previewTitle">PPT Export Preview</span>
      <button onclick="closePreview()" style="border:none; background:none; font-size:20px; cursor:pointer;">✕</button>
    </div>
    <div class="modal-body" id="previewBody">
      </div>
    <div class="modal-footer">
      <button class="action-btn" style="background:#888;" onclick="closePreview()">Cancel</button>
      <button class="action-btn ppt-btn" onclick="downloadPPT()">Download .PPTX</button>
    </div>
  </div>
</div>

<script>
// --- CONFIG & STATE ---
let allData = [];
let fuse = null;
let allSites = [];
let selectedSites = [];
let currentTab = "acceptance";
let graphsPerSlide = 2; 

let chartExportColor = '#2F80ED'; // Default Dark Blue

const acceptanceKpis = [
  "LTE RRC Setup Success Rate","ERAB Setup Success Rate","LTE Call Setup Success Rate","E-RAB Call Drop Rate",
  "CSFB Access Success Rate","LTE Intra Freq HO Success Rate","Intra-eNB HO Success Rate","Inter-eNBX2HO Success Rate",
  "Inter-eNBS1HO Success Rate","Max RRC Connected Ue","DL Data Total Volume (Gbyte)","UL Data Total Volume (Gbyte)",
  "E-RAB Setup Success Rate (VoIP)","Call Drop Rate (VoIP)","Intra-frequency Handover Out Success Rate(VoIP)",
  "Inter-frequency Handover Out Success Rate(VoIP)","SRVCC Success Rate (L2W)","SRVCC Success Rate (L2G)"
];
const monitoringKpis = [
  "Cell Availability Ratio","Average Latency Downlink (msecs)","DL PRB Utilization (%)","UL PRB Utilization (%)",
  "LTE DL - Cell Average Throughput (Mbit/s)","LTE UL - Cell Average Thoughput (Mbit/s)","LTE DL -USER Average Throughput (Mbit/s)",
  "LTE UL -USER Average Throughput (Mbit/s)","Downlink Packet Loss Rate (VoIP)","Uplink Packet Loss Rate (VoIP)",
  "VoLTE Traffic Erlang","VoLTE Traffic DL (MB)","VoLTE Traffic UL (MB)","DL BLER QCI1","UL BLER QCI1"
];
let selectedKpis = {
  acceptance: [...acceptanceKpis],
  monitoring: [...monitoringKpis]
};

// --- FETCH DATA ---
async function fetchData(){
  try {
    // NOTE: Replace this with your actual data fetching logic if it changes
    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=0&single=true&output=csv&t=" + Date.now();
    const res = await fetch(url);
    const text = await res.text();
    
    const rows = text.trim().split('\n').map(r=>r.split(','));
    const headers = rows.shift().map(h=>h.trim());
    allData = rows.map(r=>{ 
      const obj={}; 
      headers.forEach((h,i)=>{ 
        const val=r[i]?r[i].trim():""; 
        obj[h] = val==="" ? null : (isNaN(val) ? val : parseFloat(val)); 
      }); 
      return obj; 
    });

    fuse = new Fuse(allData,{ keys:['eNodeB Name'], threshold:0.4 });
    allSites = [...new Set(allData.map(d=>d["eNodeB Name"]))].filter(s=>s).sort();
    
    setupSiteDropdown();
    renderCharts();
  } catch(e) { console.error(e); alert("Failed to load data."); }
}

// --- TAB SWITCHING ---
function switchTab(tab){
  currentTab = tab;
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".tab").forEach(t => {
     if(t.textContent.toLowerCase().includes(tab === 'both' ? 'all' : tab)) t.classList.add("active");
  });
  renderCharts();
}

// --- RENDER CHARTS ---
function renderCharts(){
  const container = document.getElementById("mainChartContainer");
  container.innerHTML = "";
  
  let kpisToShow = [];
  if(currentTab === "acceptance") kpisToShow = selectedKpis.acceptance;
  else if(currentTab === "monitoring") kpisToShow = selectedKpis.monitoring;
  else if(currentTab === "both") kpisToShow = [...selectedKpis.acceptance, ...selectedKpis.monitoring];

  // 1. Process Timeline
  const timeline = [...new Set(allData.map(d=>d["Date"]))].sort((a,b)=>{
    const [da,ma,ya]=a.split('/').map(Number);
    const [db,mb,yb]=b.split('/').map(Number);
    return new Date(ya,ma-1,da)-new Date(yb,mb-1,db);
  });

  const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
  const timelineLabels = timeline.map(d => {
      const [day, month] = d.split('/').map(Number);
      return `${day} ${monthNames[month - 1]}`; // e.g., "5 Jan"
  });

  const filteredData = selectedSites.length > 0 
    ? allData.filter(d => selectedSites.includes(d["eNodeB Name"])) 
    : allData;

  // 2. Generate Charts
  kpisToShow.forEach((kpi, idx) => {
    const card = document.createElement("div");
    card.className = "chart-card";
    
    const title = document.createElement("div");
    title.className = "chart-title";
    title.textContent = kpi;
    
    const wrapper = document.createElement("div");
    wrapper.className = "chart-container";
    
    const canvas = document.createElement("canvas");
    canvas.id = `chart_${idx}`;
    
    wrapper.appendChild(canvas);
    card.appendChild(title);
    card.appendChild(wrapper);
    container.appendChild(card);

    // Calculate Data
    const dataPoints = timeline.map(date => {
       const vals = filteredData.filter(d => d["Date"] === date && d[kpi] !== null).map(d => d[kpi]);
       if(vals.length === 0) return null;
       const isAvg = kpi.match(/(rate|%|ratio|average)/i);
       const sum = vals.reduce((a,b)=>a+b,0);
       return isAvg ? sum/vals.length : sum;
    });

    // Draw Chart with Animation
    new Chart(canvas.getContext("2d"), {
      type: 'line',
      data: {
        labels: timelineLabels,
        datasets: [{
          label: selectedSites.length===1 ? selectedSites[0] : "Aggregate",
          data: dataPoints,
          borderColor: getRandomColor(),
          backgroundColor: 'transparent',
          borderWidth: 2,
          pointRadius: 3,
          tension: 0.1 
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
            x: {
                type: 'number',
                easing: 'linear',
                duration: 500,
                from: NaN,
                delay: (ctx) => ctx.index * 30 
            },
            y: { duration: 0 }
        },
        plugins: { legend: { display: false } },
        scales: {
           x: { ticks: { maxTicksLimit: 6, font: {size:10} }, grid: {display:false} },
           y: { beginAtZero: true, grid: {color:'#eee'} }
        }
      }
    });
  });
}

function getRandomColor() {
  const colors = ['#2F80ED', '#27AE60', '#D24726', '#8E44AD', '#F39C12', '#2980B9'];
  return colors[Math.floor(Math.random() * colors.length)];
}

// --- KPI DRAWER & SETTINGS ---
function toggleDrawer(){
  const d = document.getElementById("kpiDrawer");
  d.classList.toggle("open");
  if(d.classList.contains("open")) populateKpiOptions();
}

function populateKpiOptions(){
  const list = document.getElementById("kpiOptionsList");
  list.innerHTML = "";
  
  // Title remains fixed
  document.getElementById('drawerHeaderTitle').textContent = 'KPI Settings';

  const acceptanceSection = currentTab === 'acceptance' || currentTab === 'both';
  const monitoringSection = currentTab === 'monitoring' || currentTab === 'both';
  
  const createGroup = (title, key, sourceArr) => {
    const h4 = document.createElement("h4");
    h4.textContent = title;
    h4.style.marginTop = "15px";
    list.appendChild(h4);
    
    sourceArr.forEach(kpi => {
      const div = document.createElement("div");
      const checked = selectedKpis[key].includes(kpi) ? "checked" : "";
      div.innerHTML = `<input type='checkbox' class='kpi-chk' data-group='${key}' value='${kpi}' ${checked}> <span style='font-size:13px'>${kpi}</span>`;
      list.appendChild(div);
    });
  };

  if (acceptanceSection) createGroup("Acceptance KPIs", "acceptance", acceptanceKpis);
  if (monitoringSection) createGroup("Monitoring KPIs", "monitoring", monitoringKpis);
}

function applyKpis(){
  const chks = document.querySelectorAll(".kpi-chk");
  
  // Keep existing selections for tabs not currently displayed
  const tempAcceptance = currentTab === 'acceptance' || currentTab === 'both' ? [] : [...selectedKpis.acceptance];
  const tempMonitoring = currentTab === 'monitoring' || currentTab === 'both' ? [] : [...selectedKpis.monitoring];

  chks.forEach(c => {
    if(c.checked) {
        if(c.dataset.group === 'acceptance') tempAcceptance.push(c.value);
        if(c.dataset.group === 'monitoring') tempMonitoring.push(c.value);
    }
  });

  selectedKpis.acceptance = tempAcceptance;
  selectedKpis.monitoring = tempMonitoring;
  
  toggleDrawer();
  renderCharts();
}

// --- PPT EXPORT CUSTOMIZATION & PREVIEW ---

function selectColor(element) {
    document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    chartExportColor = element.dataset.color;
    
    // Update the button appearance for the default 2 graphs button
    document.querySelectorAll('.graph-options button').forEach(btn => {
        btn.style.backgroundColor = btn.textContent.includes('2 Graphs') ? '#27AE60' : '#2F80ED';
    });
}

function openExportOptions() {
    const canvases = document.querySelectorAll("canvas");
    if(canvases.length === 0) { alert("No charts to export."); return; }
    
    // Default to 2 Graphs selected if not already set
    const defaultBtn = document.querySelector('.graph-options button:nth-child(2)');
    document.querySelectorAll('.graph-options button').forEach(btn => {
        btn.style.backgroundColor = btn === defaultBtn ? '#27AE60' : '#2F80ED';
    });

    // Ensure default color is selected
    document.querySelector(`.color-option[data-color="${chartExportColor}"]`)?.classList.add('selected');

    document.getElementById("exportSelectionModal").style.display = "flex";
}

function startPreview(count) {
    graphsPerSlide = count;
    document.getElementById("exportSelectionModal").style.display = "none";

    const modal = document.getElementById("previewModal");
    const body = document.getElementById("previewBody");
    const canvases = document.querySelectorAll("canvas");
    
    modal.style.display = "flex";
    body.innerHTML = "";
    document.getElementById("previewTitle").textContent = `PPT Export Preview (${count} Graphs per Slide)`;
    
    for(let i=0; i<canvases.length; i+=count){
        const slideDiv = document.createElement("div");
        slideDiv.className = "preview-slide";
        
        const slideTitle = document.createElement("div");
        slideTitle.className = "preview-slide-title";
        slideTitle.textContent = `Slide ${Math.floor(i/count) + 1}`;
        slideDiv.appendChild(slideTitle);

        const grid = document.createElement("div");
        grid.className = "preview-grid";
        grid.style.gridTemplateColumns = count === 1 ? '1fr' : (count === 2 ? '1fr 1fr' : (count === 3 ? '1fr 1fr 1fr' : 'repeat(2, 1fr)'));
        grid.style.gridTemplateRows = count > 2 ? '1fr 1fr' : '1fr';

        for(let j=0; j<count; j++){
            if(i+j < canvases.length){
                const c = canvases[i+j];
                const box = createPreviewBox(c);
                grid.appendChild(box);
            }
        }
        slideDiv.appendChild(grid);
        body.appendChild(slideDiv);
    }
}

function createPreviewBox(canvas){
  const box = document.createElement("div");
  box.className = "preview-img-box";
  
  // Temporarily clone the canvas and force the selected color for the preview image
  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = canvas.width;
  tempCanvas.height = canvas.height;
  const tempCtx = tempCanvas.getContext('2d');
  
  const chartInstance = Chart.getChart(canvas.id);
  let imgData = '';
  
  if (chartInstance) {
      const originalColors = chartInstance.data.datasets.map(d => d.borderColor);
      
      // Override color for screenshot using the selected chartExportColor
      chartInstance.data.datasets.forEach(d => { d.borderColor = chartExportColor; });
      chartInstance.update('none'); 
      
      tempCtx.drawImage(canvas, 0, 0);
      imgData = tempCanvas.toDataURL("image/png");
      
      // Restore original colors
      chartInstance.data.datasets.forEach((d, index) => { d.borderColor = originalColors[index]; });
      chartInstance.update('none');
  }

  const img = document.createElement("img");
  img.src = imgData;
  
  const titleText = canvas.closest(".chart-card").querySelector(".chart-title").textContent;
  const label = document.createElement("div");
  label.className = "preview-label";
  label.textContent = titleText;
  
  box.appendChild(label); 
  box.appendChild(img);
  return box;
}

function closePreview(){ document.getElementById("previewModal").style.display = "none"; }

async function downloadPPT(){
  const pptx = new PptxGenJS();
  pptx.layout = 'LAYOUT_16x9';
  
  // Title Slide
  let slide = pptx.addSlide();
  slide.addText("LTE KPI Report", { x:0.5, y:2, fontSize:32, bold:true, color:'2F80ED' });
  slide.addText(`Generated: ${new Date().toLocaleDateString()}`, { x:0.5, y:3, fontSize:14 });

  const canvases = document.querySelectorAll("canvas");
  const count = graphsPerSlide;
  
  for(let i=0; i<canvases.length; i+=count){
    let slide = pptx.addSlide();
    
    // Define layout parameters based on the count
    let layout;
    if (count === 1) layout = [{ x:0.5, y:1.5, w:9, h:5 }];
    else if (count === 2) layout = [{ x:0.5, y:1.5, w:4.5, h:3.5 }, { x:5.2, y:1.5, w:4.5, h:3.5 }];
    else if (count === 3) layout = [{ x:0.5, y:1.5, w:3, h:2.5 }, { x:3.8, y:1.5, w:3, h:2.5 }, { x:7.1, y:1.5, w:3, h:2.5 }];
    else if (count === 4) layout = [{ x:0.5, y:1.5, w:4.5, h:2.5 }, { x:5.2, y:1.5, w:4.5, h:2.5 }, { x:0.5, y:4.5, w:4.5, h:2.5 }, { x:5.2, y:4.5, w:4.5, h:2.5 }];
    else layout = [];

    // Slide Title Header
    slide.addText(`KPI Analysis - Slide ${Math.floor(i/count)+1}`, { x:0.5, y:0.2, fontSize:16, color:'D24726', bold:true });

    // Add Charts
    for(let j=0; j<count; j++){
      if(i+j < canvases.length){
        const c = canvases[i+j];
        const params = layout[j];
        const titleText = c.closest(".chart-card").querySelector(".chart-title").textContent;
        
        // --- PPT COLOR FIX LOGIC ---
        const chartInstance = Chart.getChart(c.id);
        const originalColors = chartInstance.data.datasets.map(d => d.borderColor);
        
        // Override color for PPT export using the selected chartExportColor
        chartInstance.data.datasets.forEach(d => { d.borderColor = chartExportColor; });
        chartInstance.update('none'); 
        
        const imgData = c.toDataURL("image/png");
        
        // Restore original colors
        chartInstance.data.datasets.forEach((d, index) => { d.borderColor = originalColors[index]; });
        chartInstance.update('none');
        // --- END PPT COLOR FIX LOGIC ---

        // Title Text (Above the graph)
        slide.addText(titleText, { 
          x: params.x, y: params.y - 0.4, w: params.w, 
          fontSize: count <= 2 ? 12 : 10, bold:true 
        });

        // Chart Image
        slide.addImage({ 
          data: imgData, 
          x: params.x, y: params.y, 
          w: params.w, h: params.h 
        });
      }
    }
  }

  pptx.writeFile({ fileName: `KPI_Report_${new Date().getTime()}.pptx` });
  closePreview();
}

// --- SITE DROPDOWN LOGIC (Reused) ---
function setupSiteDropdown(){
  const btn = document.getElementById("siteDropdownBtn");
  const list = document.getElementById("siteDropdownList");
  const search = document.getElementById("siteFilter");
  const dropdown = document.getElementById("dropdown");

  list.innerHTML = `<div onclick="setSites([])"><b>Select All (Aggregate)</b></div>`;
  allSites.forEach(s => {
    const d = document.createElement("div");
    d.innerHTML = `<input type='checkbox' value='${s}' class='site-chk' onclick='event.stopPropagation()'> ${s}`;
    d.onclick = (e) => {
       if(e.target.tagName !== "INPUT") d.querySelector("input").click();
       updateSelectedSites();
    };
    list.appendChild(d);
  });

  btn.onclick = () => list.style.display = list.style.display==="block" ? "none" : "block";
  search.addEventListener("input", ()=>{
    const val = search.value;
    if(!val) { dropdown.style.display = "none"; return; }
    const res = fuse.search(val).slice(0,5);
    dropdown.innerHTML = "";
    res.forEach(r => {
      const d = document.createElement("div");
      d.textContent = r.item["eNodeB Name"];
      d.onclick = () => { setSites([r.item["eNodeB Name"]]); dropdown.style.display="none"; };
      dropdown.appendChild(d);
    });
    dropdown.style.display = "block";
  });
}

function updateSelectedSites(){
  const chks = document.querySelectorAll(".site-chk:checked");
  selectedSites = Array.from(chks).map(c=>c.value);
  updateSiteLabel();
  renderCharts();
}

function setSites(arr){
  selectedSites = arr;
  document.querySelectorAll(".site-chk").forEach(c => c.checked = arr.includes(c.value));
  document.getElementById("siteDropdownList").style.display = "none";
  updateSiteLabel();
  renderCharts();
}

function updateSiteLabel(){
  const span = document.getElementById("siteBtnLabel");
  if(selectedSites.length===0) span.textContent = "All Sites";
  else if(selectedSites.length===1) span.textContent = selectedSites[0];
  else span.textContent = `${selectedSites.length} Sites Selected`;
}

// Init
fetchData();
</script>
</body>
</html>
