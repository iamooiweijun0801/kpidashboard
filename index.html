<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KPI Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<style>
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f0f2f5; overflow-x:hidden; }
header { text-align:center; padding:20px 0; font-size:32px; font-weight:bold; color:#2F80ED; background:white; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:16px; }
.tabs { display:flex; justify-content:center; margin-bottom:16px; flex-wrap:wrap; gap:8px; }
.tab { padding:10px 20px; cursor:pointer; border:1px solid #ccc; border-radius:8px; background:#eee; font-weight:bold; transition:0.3s; }
.tab.active { background:#2F80ED; color:white; }
.tab:hover:not(.active) { background:#d0e1ff; }
.controls { display:flex; justify-content:center; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
#siteFilter { padding:8px; width:250px; border-radius:6px; border:1px solid #ccc; }
#dropdown { position:absolute; background:white; border:1px solid #ccc; max-height:150px; overflow-y:auto; display:none; z-index:10; width:250px; top:38px; left:0; border-radius:6px; }
#dropdown div { padding:6px 10px; cursor:pointer; transition:0.2s; }
#dropdown div:hover { background:#2F80ED; color:white; }
button { padding:10px 18px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:bold; transition:0.2s; }
button:hover { background:#1f5ab5; }
.chart-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:20px; padding:0 20px 20px 20px; }
canvas { background:white; border-radius:12px; padding:16px; width:100% !important; height:250px !important; }
.chart-card { padding:10px; border-radius:12px; background:white; box-shadow:0 2px 12px rgba(0,0,0,0.1); transition:0.3s; }
.chart-card:hover { transform:translateY(-4px); box-shadow:0 6px 20px rgba(0,0,0,0.15); }
.chart-title { text-align:center; font-weight:bold; margin-bottom:10px; color:#333; }

/* Unified Drawer */
.kpiDrawer { position:fixed; top:0; right:-320px; width:320px; height:100%; background:white; box-shadow:-4px 0 12px rgba(0,0,0,0.15); transition:0.3s; z-index:20; padding:20px; overflow-y:auto; }
.kpiDrawer.open { right:0; }
.kpiDrawerToggle { position:absolute; left:-30px; top:20px; width:30px; height:80px; background:#2F80ED; border-radius:6px 0 0 6px; cursor:pointer; z-index:25; }
.kpiDrawerToggle:hover { background:#1f5ab5; }

/* KPI options */
.kpiOption { margin-bottom:6px; }
#applyKpiBtn { margin-top:10px; width:100%; }
</style>
</head>
<body>

<header>KPI Dashboard</header>

<div class="tabs">
  <div class="tab active" data-tab="acceptance">Acceptance KPIs</div>
  <div class="tab" data-tab="monitoring">Monitoring KPIs</div>
</div>

<div class="controls">
  <div style="position:relative;">
    <input type="text" id="siteFilter" placeholder="Search eNodeB Name">
    <div id="dropdown"></div>
  </div>
  <button id="refreshBtn">Refresh Data</button>
</div>

<!-- Pages -->
<div id="acceptancePage">
  <div class="chart-grid" id="acceptanceChartContainer"></div>
</div>
<div id="monitoringPage" style="display:none;">
  <div class="chart-grid" id="monitoringChartContainer"></div>
</div>

<!-- Unified Drawer -->
<div id="kpiDrawer" class="kpiDrawer">
  <div class="kpiDrawerToggle"></div>
  <h3>eNodeB Sites</h3>
  <div>
    <button id="selectAllSitesBtn">Select All</button>
    <button id="clearSitesBtn">Clear</button>
  </div>
  <div id="siteCheckboxContainer" style="max-height:200px; overflow-y:auto; margin-bottom:20px;"></div>
  <h3>KPIs</h3>
  <div><input type="checkbox" id="selectAllKpis"> <label for="selectAllKpis"><b>Select All</b></label></div>
  <div id="kpiCheckboxContainer" style="max-height:400px; overflow-y:auto;"></div>
  <button id="applyKpiBtn">Apply</button>
</div>

<script>
let allData=[], fuse=null, allSites=[];
let selectedSites=[], currentTab="acceptance";
let selectedKpis=[]; // current page
const acceptanceKpis=[/* same as before */];
const monitoringKpis=[/* same as before */];
const animationDuration=200;

// Fetch CSV
async function fetchData(){
  const res=await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?output=csv");
  const text=await res.text();
  const rows=text.trim().split('\n').map(r=>r.split(','));
  const headers=rows.shift().map(h=>h.trim());
  allData=rows.map(r=>{
    const obj={};
    headers.forEach((h,i)=>{ const val=r[i]?r[i].trim():"0"; obj[h]=isNaN(val)?val:parseFloat(val); });
    return obj;
  });
  fuse=new Fuse(allData,{keys:['eNodeB Name'], threshold:0.4});
  allSites=[...new Set(allData.map(d=>d["eNodeB Name"]))].sort();
  renderSiteCheckboxes();
  renderKpiCheckboxes();
  drawCurrentPageCharts();
}

// Unified Drawer toggle
const drawer=document.getElementById("kpiDrawer");
document.querySelector(".kpiDrawerToggle").addEventListener("click",()=>{ drawer.classList.toggle("open"); });

// Site checkboxes
function renderSiteCheckboxes(){
  const container=document.getElementById("siteCheckboxContainer");
  container.innerHTML="";
  allSites.forEach((site,i)=>{
    const div=document.createElement("div");
    div.innerHTML=`<input type="checkbox" class="siteOption" id="site_${i}" value="${site}"> <label for="site_${i}">${site}</label>`;
    container.appendChild(div);
  });
  container.querySelectorAll(".siteOption").forEach(chk=>{
    chk.addEventListener("change",()=>{
      selectedSites=Array.from(container.querySelectorAll(".siteOption:checked")).map(c=>c.value);
      drawCurrentPageCharts();
    });
  });
  document.getElementById("selectAllSitesBtn").onclick=()=>{
    container.querySelectorAll(".siteOption").forEach(c=>c.checked=true);
    selectedSites=allSites.slice();
    drawCurrentPageCharts();
  };
  document.getElementById("clearSitesBtn").onclick=()=>{
    container.querySelectorAll(".siteOption").forEach(c=>c.checked=false);
    selectedSites=[];
    drawCurrentPageCharts();
  };
}

// KPI checkboxes
function renderKpiCheckboxes(){
  const container=document.getElementById("kpiCheckboxContainer");
  const kpis = currentTab==="acceptance"?acceptanceKpis:monitoringKpis;
  container.innerHTML="";
  kpis.forEach((kpi,i)=>{
    const div=document.createElement("div");
    div.innerHTML=`<input type="checkbox" class="kpiOptionCheckbox" id="kpi_${i}" value="${kpi}" checked> <label for="kpi_${i}">${kpi}</label>`;
    container.appendChild(div);
  });
  const selectAll=document.getElementById("selectAllKpis");
  selectAll.checked=true;
  selectAll.onchange=()=>{ container.querySelectorAll(".kpiOptionCheckbox").forEach(c=>c.checked=selectAll.checked); };
}

// Apply button
document.getElementById("applyKpiBtn").addEventListener("click",()=>{
  const container=document.getElementById("kpiCheckboxContainer");
  selectedKpis=Array.from(container.querySelectorAll(".kpiOptionCheckbox:checked")).map(c=>c.value);
  drawer.classList.remove("open");
  drawCurrentPageCharts();
});

// Tab switching
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    currentTab=tab.dataset.tab;
    renderKpiCheckboxes();
    drawCurrentPageCharts();
  });
});

// Draw charts
function drawCurrentPageCharts(){
  const kpis = selectedKpis.length?selectedKpis:(currentTab==="acceptance"?acceptanceKpis:monitoringKpis);
  const container=document.getElementById(currentTab==="acceptance"?"acceptanceChartContainer":"monitoringChartContainer");
  container.innerHTML="";
  const timeline=[...new Set(allData.map(d=>d["Date"]))].sort((a,b)=>{
    const [da,ma,ya]=a.split('/').map(Number);
    const [db,mb,yb]=b.split('/').map(Number);
    return new Date(ya,ma-1,da)-new Date(yb,mb-1,db);
  });
  const timelineLabels = timeline.map(d=>{ const [day,month]=d.split('/').map(Number); const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]; return `${day} ${months[month-1]}`; });

  kpis.forEach(kpi=>{
    const card=document.createElement("div");
    card.className="chart-card";
    const title=document.createElement("div");
    title.className="chart-title";
    let label="All Sites";
    if(selectedSites.length===1) label=selectedSites[0];
    else if(selectedSites.length>1 && selectedSites.length<allSites.length) label="Multiple Sites";
    title.textContent=`${kpi} - ${label}`;
    const canvas=document.createElement("canvas");
    card.appendChild(title); card.appendChild(canvas);
    container.appendChild(card);

    let filtered=allData;
    if(selectedSites.length>0) filtered=allData.filter(d=>selectedSites.includes(d["eNodeB Name"]));

    const dataPoints=timeline.map(date=>{
      const vals=filtered.filter(d=>d["Date"]===date).map(d=>d[kpi]||0);
      if(vals.length===0) return 0;
      if(kpi.toLowerCase().includes("%")||kpi.toLowerCase().includes("rate")||kpi.toLowerCase().includes("ratio")) return vals.reduce((a,b)=>a+b,0)/vals.length;
      return vals.reduce((a,b)=>a+b,0);
    });

    new Chart(canvas.getContext("2d"),{
      type:'line',
      data:{labels:timelineLabels,datasets:[{label:label,data:dataPoints,borderColor:'#'+Math.floor(Math.random()*16777215).toString(16),fill:false,tension:0.3,pointRadius:3}]},
      options:{responsive:true,maintainAspectRatio:false,animation:{x:{type:'number',easing:'linear',duration:200,from:NaN,delay(ctx){return ctx.index*10}},y:{duration:0}},scales:{x:{display:true},y:{beginAtZero:true,ticks:{maxTicksLimit:6}}},plugins:{legend:{position:'top'}}}
    });
  });
}

// Fuzzy search
const siteInput=document.getElementById("siteFilter");
const dropdown=document.getElementById("dropdown");
siteInput.addEventListener("input", ()=>{
  const val=siteInput.value.trim();
  if(!val || !fuse){ dropdown.style.display="none"; return; }
  const results=fuse.search(val).slice(0,5).map(r=>r.item["eNodeB Name"]);
  dropdown.innerHTML="";
  results.forEach(r=>{
    const div=document.createElement("div");
    div.textContent=r;
    div.onclick=()=>{
      siteInput.value=r;
      dropdown.style.display="none";
      selectedSites=[r];
      document.querySelectorAll(".siteOption").forEach(c=>c.checked=c.value===r);
      drawCurrentPageCharts();
    };
    dropdown.appendChild(div);
  });
  dropdown.style.display=results.length?"block":"none";
});
document.addEventListener("click", e=>{ if(e.target!==siteInput) dropdown.style.display="none"; });

document.getElementById("refreshBtn").addEventListener("click", fetchData);
fetchData();
</script>

</body>
</html>
