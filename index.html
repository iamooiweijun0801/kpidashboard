<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LTE KPI Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<style>
/* --- BASE STYLES --- */
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f4f7f6; overflow-x:hidden; }
header { text-align:center; padding:15px 0; font-size:28px; font-weight:700; color:#333; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.05); margin-bottom:15px; }

/* --- NAVIGATION --- */
.navbar { display:flex; justify-content:center; gap:12px; margin-bottom:15px; }
.nav-btn { padding:8px 24px; cursor:pointer; border:1px solid #ccc; background:white; color:#555; border-radius:20px; font-weight:600; text-decoration:none; transition:0.2s; display:inline-block; }
.nav-btn:hover { background:#f0f0f0; color:#333; }
.nav-btn.active { background:#2F80ED; color:white; border-color:#2F80ED; }

/* --- TABS --- */
.tabs { display:flex; justify-content:center; margin-bottom:20px; gap:8px; }
.tab { padding:8px 20px; cursor:pointer; border-radius:6px; background:#e0e0e0; color:#555; font-weight:bold; border:none; transition:0.2s; }
.tab:hover { background:#d0d0d0; }
.tab.active { background:#2F80ED; color:white; }

/* --- CONTROLS --- */
.controls { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
.control-group { position:relative; }
input, select { padding:8px; border-radius:6px; border:1px solid #ccc; font-size:14px; outline:none; }
button.action-btn { padding:8px 16px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:600; transition:0.2s; }
button.action-btn:hover { background:#1f5ab5; }
button.ppt-btn { background:#D24726; } /* PowerPoint Orange */
button.ppt-btn:hover { background:#a8381e; }

/* --- GRID LAYOUT (3 Graphs per row) --- */
.chart-grid {Â 
Â  display:grid;Â 
Â  grid-template-columns: repeat(3, 1fr);Â 
Â  gap:20px;Â 
Â  padding:0 20px 40px 20px;Â 
Â  max-width: 1800px;Â 
Â  margin: 0 auto;Â 
}
@media (max-width: 1400px) { .chart-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) { .chart-grid { grid-template-columns: 1fr; } }

/* --- CARDS & CHARTS --- */
.chart-card { background:white; border-radius:8px; padding:15px; box-shadow:0 2px 8px rgba(0,0,0,0.08); display:flex; flex-direction:column; }
.chart-title { display:none; }Â 
.chart-container { position: relative; height: 280px; width: 100%; }

/* --- DROPDOWNS --- */
#dropdown, #siteDropdownList, #onAirDateDropdownList {Â 
Â  position:absolute;Â 
Â  background:white;Â 
Â  border:1px solid #ccc;Â 
Â  max-height:200px;Â 
Â  overflow-y:auto;Â 
Â  display:none;Â 
Â  z-index:100;Â 
Â  width:100%;Â 
Â  top:105%;Â 
Â  border-radius:6px;Â 
Â  box-shadow:0 4px 10px rgba(0,0,0,0.1);Â 
}
#dropdown div, #siteDropdownList div, #onAirDateDropdownList div { padding:6px 10px; cursor:pointer; font-size:13px; border-bottom:1px solid #eee; }
#dropdown div:hover, #siteDropdownList div:hover, #onAirDateDropdownList div:hover { background:#f0f7ff; color:#2F80ED; }

/* --- DRAWER TOGGLES (FIXED BUTTONS) --- */

/* Graph Style Toggle Button (TOP: 60px) */
.graphStyleToggle {
Â  Â  position: fixed;
Â  Â  top: 60px;
Â  Â  right: 0;
Â  Â  width: 36px;
Â  Â  height: 36px;
Â  Â  background: #F39C12; /* Orange */
Â  Â  color: white;
Â  Â  border-radius: 6px 0 0 6px;
Â  Â  cursor: pointer;
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  justify-content: center;
Â  Â  font-size: 18px;
Â  Â  z-index: 900;
}

/* KPI Settings Toggle Button (TOP: 100px) */
.kpiDrawerToggle { 
    position:fixed; 
    top:100px; 
    right:0; 
    width:36px; 
    height:36px; 
    background:#2F80ED; 
    color:white; 
    border-radius:6px 0 0 6px; 
    cursor:pointer; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    font-size:20px; 
    z-index:900; 
}


/* --- DRAWER PANELS (FIXED & FULL HEIGHT) --- */

/* Graph Style Drawer Panel */
.graphDrawer {
Â  Â  position:fixed; 
    top:0; 
    right:0;
Â  Â  width:320px;
Â  Â  height:100%; /* Corrected to full height */
    background:white;
Â  Â  box-shadow:-2px 0 10px rgba(0,0,0,0.1); 
    z-index:1000;
Â  Â  transform:translateX(100%); 
    transition:0.3s; 
    padding:20px;
Â  Â  display: flex; 
    flex-direction: column;
}
.graphDrawer.open { 
    transform:translateX(0); 
}

/* KPI Settings Drawer Panel */
.kpiDrawer {Â 
Â    position:fixed; 
    top:0; 
    right:0;Â 
Â    width:320px;Â 
Â    height:100%; /* Corrected to full height */
    background:white;Â 
Â    box-shadow:-2px 0 10px rgba(0,0,0,0.1); 
    z-index:1000;Â 
Â    transform:translateX(100%); 
    transition:0.3s; 
    padding:20px;Â 
Â    display: flex; 
    flex-direction: column;Â 
}
.kpiDrawer.open { 
    transform:translateX(0); 
}

/* --- DRAWER CONTENTS/CONTROLS --- */
.drawer-header {Â 
Â  Â  display: flex;Â 
Â  Â  justify-content: space-between;Â 
Â  Â  align-items: center;Â 
Â  Â  margin-bottom: 10px;Â 
Â  Â  padding-bottom: 10px;Â 
Â  Â  border-bottom: 1px solid #eee;Â 
}
.drawer-header h3 { margin: 0; }
.drawer-controls {Â 
Â  Â  display: flex;Â 
Â  Â  gap: 5px; 
Â  Â  align-items: center;Â 
}
.drawer-controls .action-btn {Â 
Â  Â  padding: 6px 10px; 
Â  Â  font-size: 13px; 
}
.kpi-options-body { flex-grow: 1; overflow-y: auto; padding-right: 5px; padding-bottom: 40px; }

/* Style buttons inside the drawer */
.style-btn {
Â  Â  padding: 8px 12px;
Â  Â  margin: 5px 0;
Â  Â  cursor: pointer;
Â  Â  border: 1px solid #ccc;
Â  Â  background: white;
Â  Â  color: #333;
Â  Â  border-radius: 6px;
Â  Â  font-weight: 600;
Â  Â  transition: 0.2s;
Â  Â  width: 100%;
Â  Â  text-align: left;
}
.style-btn.active {
Â  Â  background: #2F80ED;
Â  Â  color: white;
Â  Â  border-color: #2F80ED;
}


/* --- PREVIEW MODAL --- */
.modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(3px); }
.modal-content {Â 
Â  Â  background:white;Â 
Â  Â  width:95%;Â 
Â  Â  max-width: 1400px;Â 
Â  Â  height:90vh;Â 
Â  Â  border-radius:12px;Â 
Â  Â  display:flex;Â 
Â  Â  flex-direction:column;Â 
Â  Â  box-shadow:0 10px 25px rgba(0,0,0,0.3);Â 
}
.modal-header { padding:15px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; font-weight:bold; font-size:18px; }
.modal-body { flex:1; display: flex; padding:0; overflow: hidden; }Â 

/* Preview Side */
#previewBody {Â 
Â  Â  flex: 1;Â 
Â  Â  overflow-y:auto;Â 
Â  Â  padding:20px;Â 
Â  Â  background:#f5f5f5;Â 
}
.preview-slide { background:white; border:1px solid #ddd; margin-bottom:20px; padding:20px; box-shadow:0 2px 5px rgba(0,0,0,0.05); aspect-ratio: 16/9; position:relative; }
.preview-slide-title { position:absolute; top:10px; left:20px; font-size:16px; font-weight:bold; color:#D24726; }
.preview-grid { display:grid; height:100%; align-items:center; padding-top:30px; }
.preview-img-box { text-align:center; padding:5px; height:100%; display:flex; flex-direction:column; justify-content:center; }
.preview-img-box img { max-width:100%; max-height:calc(100% - 20px); object-fit:contain; border:1px solid #eee; }
.preview-label { display: none; }Â 

/* Settings Side (Fixed, not scrollable) */
#previewSettingsPanel {
Â  Â  width: 250px;
Â  Â  background: #fff;
Â  Â  border-left: 1px solid #eee;
Â  Â  padding: 20px;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  flex-shrink: 0;Â 
}
.settings-group h4 { margin-top: 0; margin-bottom: 10px; font-size: 14px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.graph-options button { margin: 5px; width: 100px; padding: 6px; font-size: 13px; }

/* Color Selector */
.color-option { margin: 5px; display: inline-block; cursor: pointer; border: 2px solid transparent; border-radius: 50%; width: 25px; height: 25px; transition: border 0.1s; }
.color-option.selected { border-color: #333; }

.modal-footer {Â 
Â  Â  padding:15px 20px;Â 
Â  Â  border-top:1px solid #eee;Â 
Â  Â  text-align:right;
Â  Â  flex-shrink: 0;Â 
}
</style>
</head>
<body>

<header>LTE KPI Dashboard</header>

<div class="navbar">
  <a href="gsm.html" class="nav-btn">GSM</a>
  <a href="index.html" class="nav-btn active">LTE</a>
  <a href="nr.html" class="nav-btn">NR</a>
</div>

<div class="tabs">
  <button class="tab active" onclick="switchTab('both')">All KPIs </button> 
  <button class="tab" onclick="switchTab('acceptance')">Acceptance</button>
  <button class="tab" onclick="switchTab('monitoring')">Monitoring</button>
</div>

<div class="controls">
  <div class="control-group" style="width:200px;">
    <button id="onAirDateDropdownBtn" class="action-btn" style="background:white; color:#333; border:1px solid #ccc; width:100%; text-align:left; display:flex; justify-content:space-between;">
      <span id="onAirDateBtnLabel">All On-Air Dates</span> <span>â–¼</span>
    </button>
    <div id="onAirDateDropdownList"></div>
  </div>

  <div class="control-group" style="width:200px;">
    <button id="siteDropdownBtn" class="action-btn" style="background:white; color:#333; border:1px solid #ccc; width:100%; text-align:left; display:flex; justify-content:space-between;">
      <span id="siteBtnLabel">All Sites</span> <span>â–¼</span>
    </button>
    <div id="siteDropdownList"></div>
  </div>

  <button onclick="fetchData()" class="action-btn">Refresh</button>
  <button onclick="openPreview()" class="action-btn ppt-btn">Export PPT</button>
</div>

<div class="chart-grid" id="mainChartContainer"></div>

<div class="graphStyleToggle" onclick="toggleGraphStyleDrawer()">ðŸŽ¨</div>

<div id="graphDrawer" class="graphDrawer">
Â  <div class="drawer-header">
Â  Â  <h3 id="graphDrawerHeaderTitle">Graph Style</h3>
Â  Â  <div class="drawer-controls">
Â  Â  Â  Â  <button onclick="toggleGraphStyleDrawer()" style="border:none; background:none; font-size:24px; cursor:pointer; color:#777;">âœ•</button>
Â  Â  </div>
Â  </div>
Â  <div class="kpi-options-body" id="graphStyleOptionsList">
        <h4>Chart Style Selection</h4>
        </div>
</div>

<div class="kpiDrawerToggle" onclick="toggleDrawer()">âš™</div>
<div id="kpiDrawer" class="kpiDrawer">
  <div class="drawer-header">
    <h3 id="drawerHeaderTitle">KPI Settings</h3>
    <div class="drawer-controls">
        <button class="action-btn" onclick="selectVisibleKpis()" style="background:#5cb85c;">Select All</button>
        <button class="action-btn" onclick="clearVisibleKpis()" style="background:#f0ad4e;">Clear All</button>
        <button class="action-btn" onclick="applyKpis()">Apply</button>
        <button onclick="toggleDrawer()" style="border:none; background:none; font-size:24px; cursor:pointer; color:#777;">âœ•</button>
    </div>
  </div>
  <div class="kpi-options-body" id="kpiOptionsList"></div>
</div>


<div id="previewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span id="previewTitle">PPT Export Preview</span>
      <button onclick="closePreview()" style="border:none; background:none; font-size:20px; cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body">
        
        <div id="previewBody">
          </div>

        <div id="previewSettingsPanel">
            <h3>Export Settings</h3>

            <div class="settings-group">
                <h4>Graphs per Slide (Rows)</h4>
                <div class="graph-options">
                    <button class="action-btn" data-count="1" onclick="updatePreviewSettings(1, chartExportColor, chartExportTitleColor)">1 Graph</button>
                    <button class="action-btn" data-count="2" onclick="updatePreviewSettings(2, chartExportColor, chartExportTitleColor)">2 Graphs</button>
                    <button class="action-btn" data-count="3" onclick="updatePreviewSettings(3, chartExportColor, chartExportTitleColor)">3 Graphs</button>
                    <button class="action-btn" data-count="4" onclick="updatePreviewSettings(4, chartExportColor, chartExportTitleColor)">4 Graphs</button>
                    <button class="action-btn" data-count="6" onclick="updatePreviewSettings(6, chartExportColor, chartExportTitleColor)">6 Graphs</button>
                    <button class="action-btn" data-count="9" onclick="updatePreviewSettings(9, chartExportColor, chartExportTitleColor)">9 Graphs</button>
                </div>
            </div>

            <div class="settings-group">
                <h4>Line & Dot Color for PPT</h4>
                <div id="lineColorOptions">
                    <span class="color-option" style="background-color:#2F80ED;" data-color="#2F80ED" onclick="updatePreviewSettings(graphsPerSlide, '#2F80ED', chartExportTitleColor)"></span>
                    <span class="color-option" style="background-color:#27AE60;" data-color="#27AE60" onclick="updatePreviewSettings(graphsPerSlide, '#27AE60', chartExportTitleColor)"></span>
                    <span class="color-option" style="background-color:#D24726;" data-color="#D24726" onclick="updatePreviewSettings(graphsPerSlide, '#D24726', chartExportTitleColor)"></span>
                    <span class="color-option" style="background-color:#8E44AD;" data-color="#8E44AD" onclick="updatePreviewSettings(graphsPerSlide, '#8E44AD', chartExportTitleColor)"></span>
                    <span class="color-option" style="background-color:#F39C12;" data-color="#F39C12" onclick="updatePreviewSettings(graphsPerSlide, '#F39C12', chartExportTitleColor)"></span>
                </div>
            </div>

            <div class="settings-group">
                <h4>Chart Title Color for PPT</h4>
                <div id="titleColorOptions">
                    <span class="color-option" style="background-color:#333333;" data-color="#333333" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#333333')"></span>
                    <span class="color-option" style="background-color:#000000;" data-color="#000000" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#000000')"></span>
                    <span class="color-option" style="background-color:#2F80ED;" data-color="#2F80ED" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#2F80ED')"></span>
                    <span class="color-option" style="background-color:#8E44AD;" data-color="#8E44AD" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#8E44AD')"></span>
                    <span class="color-option" style="background-color:#D24726;" data-color="#D24726" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#D24726')"></span>
                </div>
            </div>

            <div style="margin-top: auto; padding-top: 15px; border-top: 1px solid #eee;">
                <p style="font-size: 12px; color: #777;">Preview updates instantly.</p>
            </div>
        </div>

    </div>
    <div class="modal-footer">
      <button class="action-btn" style="background:#888;" onclick="closePreview()">Cancel</button>
      <button class="action-btn ppt-btn" onclick="downloadPPT()">Download .PPTX</button>
    </div>
  </div>
</div>

<script>
// --- CONFIG & STATE ---
let allData = [];
let fuse = null;
let allSites = [];
let siteCutoverMap = {}; // Maps eNodeB Name -> On-Air Date
let allOnAirDates = [];
let selectedOnAirDates = [];

let selectedSites = [];
let currentTab = "both"; // DEFAULT IS NOW 'BOTH'
let graphsPerSlide = 2; 

let chartExportColor = '#2F80ED'; // Default Line/Dot Color (Dark Blue)
let chartExportTitleColor = '#333333'; // Default Title Color (Dark Gray/Black)
let chartStyleKey = 'line_basic'; // Default chart style

// NEW: 10 Chart Styles Configuration
const CHART_STYLES = {
    'line_basic': { name: "1. Line Basic", type: 'line', stepped: false, tension: 0.0, fill: false, borderDash: [], borderWidth: 2, pointRadius: 3, defaultColor: '#2F80ED' },
    'line_smooth': { name: "2. Line Smooth", type: 'line', stepped: false, tension: 0.4, fill: false, borderDash: [], borderWidth: 2, pointRadius: 3, defaultColor: '#27AE60' },
    'line_step': { name: "3. Line Step", type: 'line', stepped: 'before', tension: 0.0, fill: false, borderDash: [], borderWidth: 2, pointRadius: 3, defaultColor: '#D24726' },
    'area_filled': { name: "4. Area Filled", type: 'line', stepped: false, tension: 0.4, fill: 'origin', borderDash: [], borderWidth: 2, pointRadius: 3, defaultColor: '#8E44AD' },
    'bar_basic': { name: "5. Bar Basic", type: 'bar', stepped: false, tension: 0.0, fill: false, borderDash: [], borderWidth: 1, pointRadius: 0, defaultColor: '#F39C12' },
    'bar_outline': { name: "6. Bar Outline", type: 'bar', stepped: false, tension: 0.0, fill: false, borderDash: [], borderWidth: 2, pointRadius: 0, defaultColor: '#2980B9', backgroundColor: 'transparent' },
    'line_monochrome': { name: "7. Monochrome", type: 'line', stepped: false, tension: 0.0, fill: false, borderDash: [], borderWidth: 2, pointRadius: 3, defaultColor: '#444444' },
    'line_dotted': { name: "8. Line Dotted", type: 'line', stepped: false, tension: 0.0, fill: false, borderDash: [5, 5], borderWidth: 2, pointRadius: 3, defaultColor: '#16A085' },
    'point_only': { name: "9. Point Only", type: 'line', stepped: false, tension: 0.0, fill: false, borderDash: [], borderWidth: 0, pointRadius: 6, defaultColor: '#C0392B' },
    'area_step': { name: "10. Area Step", type: 'line', stepped: 'before', tension: 0.0, fill: 'origin', borderDash: [], borderWidth: 2, pointRadius: 3, defaultColor: '#9B59B6' }
};

const acceptanceKpis = [
  "LTE RRC Setup Success Rate(%)","ERAB Setup Success Rate(%)","LTE Call Setup Success Rate(%)","E-RAB Call Drop Rate(%)",
  "CSFB Access Success Rate(%)","LTE Intra Freq HO Success Rate(%)","Intra-eNB HO Success Rate(%)","Inter-eNBX2HO Success Rate(%)",
  "Inter-eNBS1HO Success Rate(%)","Max RRC Connected Ue","DL Data Total Volume (Gbyte)","UL Data Total Volume (Gbyte)",
  "E-RAB Setup Success Rate (VoIP)(%)","Call Drop Rate (VoIP)(%)","Intra-frequency Handover Out Success Rate(VoIP)(%)",
  "Inter-frequency Handover Out Success Rate(VoIP)(%)","SRVCC Success Rate (L2W)(%)","SRVCC Success Rate (L2G)(%)"
];
const monitoringKpis = [
  "Cell Availability Ratio(%)","Average Latency Downlink (msecs)","DL PRB Utilization (%)","UL PRB Utilization (%)",
  "LTE DL - Cell Average Throughput (Mbit/s)","LTE UL - Cell Average Thoughput (Mbit/s)","LTE DL -USER Average Throughput (Mbit/s)",
  "LTE UL -USER Average Throughput (Mbit/s)","Downlink Packet Loss Rate (VoIP)(%)","Uplink Packet Loss Rate (VoIP)(%)",
  "VoLTE Traffic Erlang","VoLTE Traffic DL (MB)","VoLTE Traffic UL (MB)","DL BLER QCI1","UL BLER QCI1"
];
let selectedKpis = {
  acceptance: [...acceptanceKpis],
  monitoring: [...monitoringKpis]
};

// --- GLOBAL UTILITY FUNCTIONS ---

/**
 * Switches the active tab (Acceptance, Monitoring, Both).
 * @param {string} tab - The tab identifier ('acceptance', 'monitoring', 'both').
 */
function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
    currentTab = tab;
    renderCharts(); 
}

// --- DATA FETCHING & MAPPING ---
async function fetchData(){
  try {
    // 1. Fetch KPI Data
    const kpiUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=893314169&single=true&output=csv&t=" + Date.now();
    const kpiRes = await fetch(kpiUrl);
    const kpiText = await kpiRes.text();
    
    const kpiRows = kpiText.trim().split('\n').map(r=>r.split(','));
    const kpiHeaders = kpiRows.shift().map(h=>h.trim());
    allData = kpiRows.map(r=>{ 
      const obj={}; 
      kpiHeaders.forEach((h,i)=>{ 
        const val=r[i]?r[i].trim():""; 
        obj[h] = val==="" ? null : (isNaN(val) ? val : parseFloat(val)); 
      }); 
      return obj; 
    });

    // Determine all sites present in the KPI data
    allSites = [...new Set(allData.map(d=>d["eNodeB Name"]))].filter(s=>s).sort();

    // 2. Fetch Cutover Data
    const cutoverUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=19616562&single=true&output=csv&t=" + Date.now();
    const cutoverRes = await fetch(cutoverUrl);
    const cutoverText = await cutoverRes.text();
    
    const cutoverRows = cutoverText.trim().split('\n').map(r=>r.split(','));
    const cutoverHeaders = cutoverRows.shift().map(h=>h.trim());
    
    siteCutoverMap = {};
    cutoverRows.forEach(r => {
        const siteName = r[cutoverHeaders.indexOf("eNodeB Name")]?.trim();
        const onAirDate = r[cutoverHeaders.indexOf("On-Air Date")]?.trim();
        if (siteName && onAirDate) {
            // Only map sites that exist in the KPI data to prevent issues
            if (allSites.includes(siteName)) {
                 siteCutoverMap[siteName] = onAirDate;
            }
        }
    });

    // 3. Initialize Date Filter Options and State
    allOnAirDates = [...new Set(Object.values(siteCutoverMap))].filter(d => d).sort();
    selectedOnAirDates = [...allOnAirDates]; // Default: Select All Dates
    selectedSites = []; // Reset site selection

    // 4. Update UI
    setupOnAirDateDropdown();
    setupSiteDropdown();
    renderCharts();
    populateGraphStyleOptions();

  } catch(e) { console.error(e); alert("Failed to load data."); }
}

// --- FILTER UI LOGIC (ON-AIR DATE) ---

function setupOnAirDateDropdown(){
  const list = document.getElementById("onAirDateDropdownList");
  const btn = document.getElementById("onAirDateDropdownBtn");
  list.innerHTML = "";
  
  const setAll = () => { 
    selectedOnAirDates = [...allOnAirDates]; 
    // When All Dates are selected, all sites MUST be selected as well
    const allActiveSites = allSites.filter(site => siteCutoverMap[site] && allOnAirDates.includes(siteCutoverMap[site]));
    selectedSites = [...allActiveSites]; 

    // Update UI but DO NOT close the dropdown
    updateDateFilterUI({close: false}); 
    setupSiteDropdown(); // This re-renders charts
  };

  const clearAll = () => { 
    selectedOnAirDates = []; 
    // When All Dates are cleared, all sites MUST be cleared
    selectedSites = []; 
    
    // Update UI but DO NOT close the dropdown
    updateDateFilterUI({close: false}); 
    setupSiteDropdown(); 
  };
  
  // Actions
  list.innerHTML += `<div onclick="window.dateSetAll()"><b>Select All</b></div>`;
  list.innerHTML += `<div onclick="window.dateClearAll()"><b>Clear All</b></div>`;

  // Options
  allOnAirDates.forEach(date => {
    const d = document.createElement("div");
    const checked = selectedOnAirDates.includes(date) ? "checked" : "";
    d.innerHTML = `<input type='checkbox' value='${date}' class='date-chk' ${checked}> ${date}`;
    d.onclick = (e) => {
       if(e.target.tagName !== "INPUT") {
          const chk = d.querySelector("input");
          chk.checked = !chk.checked;
       }
       updateSelectedDates(); // Individual selection
    };
    list.appendChild(d);
  });
  
  btn.onclick = () => list.style.display = list.style.display==="block" ? "none" : "block";
  
  // Expose helpers globally for inline HTML
  window.dateSetAll = setAll;
  window.dateClearAll = clearAll;
  updateDateFilterUI({close: true}); // Initial UI update
}

function updateSelectedDates() {
    const list = document.getElementById("onAirDateDropdownList");
    selectedOnAirDates = Array.from(list.querySelectorAll(".date-chk:checked")).map(c => c.value);
    
    // Update the sites based on the new dates (select all sites under the new date scope)
    let activeSites = allSites.filter(site => {
        const date = siteCutoverMap[site];
        return date && selectedOnAirDates.includes(date);
    });
    selectedSites = [...activeSites]; 
    
    // Do not close dropdown on individual check
    updateDateFilterUI({close: false}); 
    setupSiteDropdown(); 
}

function updateDateFilterUI(options = {close: true}) {
    const btn = document.getElementById("onAirDateDropdownBtn");
    const span = document.getElementById("onAirDateBtnLabel");
    const list = document.getElementById("onAirDateDropdownList");
    
    span.textContent = selectedOnAirDates.length === 0 ? "No Dates Selected" : (selectedOnAirDates.length === allOnAirDates.length ? "All On-Air Dates" : `Selected (${selectedOnAirDates.length})`);
    
    // Update checkboxes visually
    list.querySelectorAll(".date-chk").forEach(c => c.checked = selectedOnAirDates.includes(c.value));
    
    // Close dropdown only if requested
    if (options.close) {
        list.style.display = "none";
    } else {
        // If not closing, ensure it's open
        list.style.display = "block";
    }
}

// --- FILTER UI LOGIC (eNodeB NAME) ---

function setupSiteDropdown(){
  const list = document.getElementById("siteDropdownList");
  const btn = document.getElementById("siteDropdownBtn");
  list.innerHTML = "";

  // 1. Determine which sites are active based on the date filter
  let activeSites = allSites.filter(site => {
      const date = siteCutoverMap[site];
      return date && selectedOnAirDates.includes(date);
  });
  
  // 2. Filter selectedSites to only include those that are currently active
  selectedSites = selectedSites.filter(site => activeSites.includes(site));
  
  // Actions
  const setAll = () => { 
    selectedSites = [...activeSites]; 
    updateSiteFilterUI({close: false}); 
    renderCharts();
  }; 

  const clearAll = () => { 
    selectedSites = []; 
    updateSiteFilterUI({close: false}); 
    renderCharts(); 
  };
  
  // Inject setAll/clearAll actions
  list.innerHTML += `<div onclick="window.siteSetAll()"><b>Select All (${activeSites.length})</b></div>`;
  list.innerHTML += `<div onclick="window.siteClearAll()"><b>Clear All</b></div>`;

  // Options
  activeSites.forEach(site => {
    const d = document.createElement("div");
    // Check if the site is in the current selectedSites list
    const checked = selectedSites.includes(site) ? "checked" : ""; 
    d.innerHTML = `<input type='checkbox' value='${site}' class='site-chk' ${checked}> ${site}`;
    d.onclick = (e) => {
       if(e.target.tagName !== "INPUT") {
          const chk = d.querySelector("input");
          chk.checked = !chk.checked;
       }
       updateSelectedSites(); // Individual selection
    };
    list.appendChild(d);
  });
  
  btn.onclick = () => list.style.display = list.style.display==="block" ? "none" : "block";

  // Expose helpers globally for inline HTML
  window.siteSetAll = setAll;
  window.siteClearAll = clearAll;
  
  // Initial UI update for site dropdown and rendering
  updateSiteFilterUI({close: true});
  renderCharts();
}

function updateSelectedSites() {
    const list = document.getElementById("siteDropdownList");
    // Ensure we only look at the sites currently visible/active in the list
    selectedSites = Array.from(list.querySelectorAll(".site-chk:checked")).map(c => c.value);
    // Do not close dropdown on individual check
    updateSiteFilterUI({close: false});
    renderCharts();
}

function updateSiteFilterUI(options = {close: true}) {
    const btn = document.getElementById("siteDropdownBtn");
    const span = document.getElementById("siteBtnLabel");
    const list = document.getElementById("siteDropdownList");
    
    let activeSites = allSites.filter(site => {
        const date = siteCutoverMap[site];
        return selectedOnAirDates.includes(date);
    });

    if(selectedSites.length === 0) span.textContent = "All Active Sites";
    else if(selectedSites.length === activeSites.length) span.textContent = `All Active Sites (${selectedSites.length})`;
    else if(selectedSites.length === 1) span.textContent = selectedSites[0];
    else span.textContent = `Selected (${selectedSites.length})`;

    // Re-check all site checkboxes to reflect the selectedSites state 
    list.querySelectorAll(".site-chk").forEach(c => c.checked = selectedSites.includes(c.value));
    
    // Close dropdown only if requested
    if (options.close) {
        list.style.display = "none";
    } else {
        // If not closing, ensure it's open
        list.style.display = "block";
    }
}

// --- CHART RENDERING ---

function renderCharts(){
  const container = document.getElementById("mainChartContainer");
  container.innerHTML = "";
  const styleConfig = CHART_STYLES[chartStyleKey];
  let kpisToShow = [];
  if(currentTab === "acceptance") kpisToShow = selectedKpis.acceptance;
  else if(currentTab === "monitoring") kpisToShow = selectedKpis.monitoring;
  else if(currentTab === "both") kpisToShow = [...selectedKpis.acceptance, ...selectedKpis.monitoring];

  // 1. Determine final list of sites based on date filter AND site filter
  let sitesFromDate = allSites.filter(site => {
      const date = siteCutoverMap[site];
      return selectedOnAirDates.includes(date);
  });

  let finalSiteList;
  if (selectedSites.length > 0) {
      // Use specifically selected sites
      finalSiteList = selectedSites;
  } else {
      // Use all sites allowed by the date filter (default behavior when no specific site is selected)
      finalSiteList = sitesFromDate;
  }
  
  let filteredData = allData.filter(d => finalSiteList.includes(d["eNodeB Name"]));


  // 2. Process Timeline (unchanged)
  const timeline = [...new Set(filteredData.map(d=>d["Date"]))].sort((a,b)=>{
    const [da,ma,ya]=a.split('/').map(Number);
    const [db,mb,yb]=b.split('/').map(Number);
    return new Date(ya,ma-1,da)-new Date(yb,mb-1,db);
  });

  const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
  const timelineLabels = timeline.map(d => {
      const [day, month] = d.split('/').map(Number);
      return `${day} ${monthNames[month - 1]}`; // e.g., "5 Jan"
  });

  // 3. Generate Charts
  kpisToShow.forEach((kpi, idx) => {
    const card = document.createElement("div");
    card.className = "chart-card";
    
    const wrapper = document.createElement("div");
    wrapper.className = "chart-container";
    
    const canvas = document.createElement("canvas");
    canvas.id = `chart_${idx}`;
    
    wrapper.appendChild(canvas);
    card.appendChild(wrapper);
    container.appendChild(card);

    // Calculate Data
const dataPoints = timeline.map(date => {
  const values = filteredData
    .filter(d => d["Date"] === date)
    .map(d => Number(d[kpi]))
    .filter(v => !isNaN(v));

  if(values.length === 0) return null;

  const avg = values.reduce((a,b) => a+b, 0) / values.length;
  return avg;
});

let validValues = dataPoints.filter(v => v !== null);
let minVal = Math.min(...validValues);
let maxVal = Math.max(...validValues);

// Special rule: if min >= 95 and max <= 100, set scale explicitly
if(minVal >= 95 && maxVal <= 100) {
    minVal = 95;
    maxVal = 100;
} else {
    // Apply your normal rules
    if(minVal < 40) minVal = Math.max(Math.floor(minVal), 42);
    if(maxVal > 100) maxVal = 100;

    // Optionally round to nearest 5 for nicer axis
    minVal = Math.floor(minVal / 5) * 5;
    maxVal = Math.ceil(maxVal / 5) * 5;
}


    // Draw Chart with Animation
    new Chart(canvas.getContext("2d"), {
Â  Â  Â  type: styleConfig.type, // MODIFIED: Use the configured type
Â  Â  Â  data: {
Â  Â  Â  Â  labels: timelineLabels,
Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  label: (finalSiteList.length > 0 && dataPoints.some(p => p !== null)) ? "Aggregate" : "No Data",
Â  Â  Â  Â  Â  data: dataPoints,
Â  Â  Â  Â  Â  borderColor: styleConfig.defaultColor, // MODIFIED: Use style-specific default color
Â  Â  Â  Â  Â  backgroundColor: styleConfig.fill ? (styleConfig.defaultColor + '80') : (styleConfig.backgroundColor || 'transparent'), // MODIFIED: Handle fill/transparency
             tension: styleConfig.tension, // NEW
             stepped: styleConfig.stepped || false, // NEW
             fill: styleConfig.fill || false, // NEW
             borderDash: styleConfig.borderDash, // NEW
             borderWidth: styleConfig.borderWidth, // NEW
             pointRadius: styleConfig.pointRadius, // NEW
Â  Â  Â  Â  Â  spanGaps: trueÂ 
Â  Â  Â  Â  }]
Â  Â  Â  },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
            x: {
                type: 'number',
                easing: 'linear',
                duration: 500,
                from: NaN,
                delay: (ctx) => ctx.index * 30 
            },
            y: { duration: 0 }
        },
        plugins: { 
            legend: { display: false },
            title: { // Chart.js built-in title
                display: true,
                text: kpi,
                font: {
                    size: 14,
                    weight: 'bold'
                },
                color: '#333'
            }
        },
        scales: {
           x: { 
               ticks: { font: {size:8} }, 
               grid: {display:false} 
           },
           y: { 
               beginAtZero: false, 
               grid: {color:'#eee'},
               // If no data points, fix the scale to prevent giant axes
               min: (finalSiteList.length === 0 || dataPoints.every(p => p === null)) ? 0 : undefined 
           }
        }
      }
    });
  });
}

function getRandomColor() {
Â  // MODIFIED: We now use the style's default color instead of a random one for consistency.
Â  return CHART_STYLES[chartStyleKey].defaultColor;
}
function toggleGraphStyleDrawer(){
    const d = document.getElementById("graphDrawer");
    d.classList.toggle("open");
    if(d.classList.contains("open")) populateGraphStyleOptions();
}

/**
 * Dynamically creates 10 style buttons based on the CHART_STYLES config.
 */
function populateGraphStyleOptions() {
    const list = document.getElementById('graphStyleOptionsList');
    list.innerHTML = ''; // Clear list
    
    Object.entries(CHART_STYLES).forEach(([key, config]) => {
        const btn = document.createElement('button');
        btn.className = `style-btn ${chartStyleKey === key ? 'active' : ''}`;
        btn.textContent = config.name;
        btn.setAttribute('onclick', `setChartStyle('${key}')`);
        list.appendChild(btn);
    });
}

function setChartStyle(key) {
    chartStyleKey = key;
    populateGraphStyleOptions(); // Update button look
    toggleGraphStyleDrawer(); // Close the drawer
    renderCharts(); // Re-render all charts with the new style
}

// --- KPI DRAWER & UTILITY LOGIC ---

function toggleDrawer(){
  const d = document.getElementById("kpiDrawer");
  d.classList.toggle("open");
  if(d.classList.contains("open")) populateKpiOptions();
}

function populateKpiOptions(){
  const list = document.getElementById("kpiOptionsList");
  list.innerHTML = "";
  
  document.getElementById('drawerHeaderTitle').textContent = 'KPI Settings';

  const acceptanceSection = currentTab === 'acceptance' || currentTab === 'both';
  const monitoringSection = currentTab === 'monitoring' || currentTab === 'both';
  
  const createGroup = (title, key, sourceArr) => {
    const h4 = document.createElement("h4");
    h4.textContent = title;
    h4.style.marginTop = "15px";
    list.appendChild(h4);
    
    sourceArr.forEach(kpi => {
      const div = document.createElement("div");
      const checked = selectedKpis[key].includes(kpi) ? "checked" : "";
      div.innerHTML = `<input type='checkbox' class='kpi-chk' data-group='${key}' value='${kpi}' ${checked}> <span style='font-size:13px'>${kpi}</span>`;
      div.onclick = (e) => {
        if(e.target.tagName !== "INPUT") {
            const chk = div.querySelector("input");
            chk.checked = !chk.checked;
        }
        // No auto-apply here, user must click Apply
      };
      list.appendChild(div);
    });
  };

  if (acceptanceSection) createGroup("Acceptance KPIs", "acceptance", acceptanceKpis);
  if (monitoringSection) createGroup("Monitoring KPIs", "monitoring", monitoringKpis);
}

/**
 * Selects all visible KPI checkboxes and updates the internal state.
 */
function selectVisibleKpis() {
    const chks = document.querySelectorAll(".kpi-chk");
    
    // 1. Update Checkboxes Visually
    chks.forEach(c => {
        c.checked = true;
    });

    // 2. Update Internal State
    if (currentTab === 'acceptance' || currentTab === 'both') {
        selectedKpis.acceptance = [...acceptanceKpis];
    }
    if (currentTab === 'monitoring' || currentTab === 'both') {
        selectedKpis.monitoring = [...monitoringKpis];
    }
}

/**
 * Clears all visible KPI checkboxes and updates the internal state.
 */
function clearVisibleKpis() {
    const chks = document.querySelectorAll(".kpi-chk");
    
    // 1. Update Checkboxes Visually
    chks.forEach(c => {
        c.checked = false;
    });

    // 2. Update Internal State
    if (currentTab === 'acceptance' || currentTab === 'both') {
        selectedKpis.acceptance = [];
    }
    if (currentTab === 'monitoring' || currentTab === 'both') {
        selectedKpis.monitoring = [];
    }
}


function applyKpis(){
  const chks = document.querySelectorAll(".kpi-chk");
  
  // Start with existing selections for non-visible tabs
  const tempAcceptance = currentTab === 'acceptance' || currentTab === 'both' ? [] : [...selectedKpis.acceptance];
  const tempMonitoring = currentTab === 'monitoring' || currentTab === 'both' ? [] : [...selectedKpis.monitoring];

  // Apply checked status from the UI
  chks.forEach(c => {
    if(c.checked) {
        if(c.dataset.group === 'acceptance') tempAcceptance.push(c.value);
        if(c.dataset.group === 'monitoring') tempMonitoring.push(c.value);
    }
  });

  selectedKpis.acceptance = tempAcceptance;
  selectedKpis.monitoring = tempMonitoring;
  
  toggleDrawer();
  renderCharts();
}

// --- PPT EXPORT CUSTOMIZATION & PREVIEW ---

// Centralized Layout Logic: Ensures Preview and PPT match exactly
function getLayoutConfig(count) {
    // Standard PPT Slide: 10 inches x 5.625 inches
    const slideWidth = 10.0;
    const slideHeight = 5.625;
    
    // Margins & Spacing (Inches)
    const marginX = 0.2; 
    const marginTop = 0.9; // Space for Slide Title
    const marginBottom = 0.2;
    const gap = 0.15;      // Space between charts

    let rows, cols;

    // Define Grid Logic
    switch(parseInt(count)) {
        case 1: rows = 1; cols = 1; break;
        case 2: rows = 1; cols = 2; break;
        case 3: rows = 2; cols = 2; break; // FIXED: 3 graphs now use 2x2 grid (not squished)
        case 4: rows = 2; cols = 2; break;
        case 6: rows = 2; cols = 3; break;
        case 9: rows = 3; cols = 3; break; // FIXED: 9 graphs strictly calculated to fit height
        default: rows = 2; cols = 2;
    }

    // Calculate Available Space
    const usableW = slideWidth - (marginX * 2);
    const usableH = slideHeight - marginTop - marginBottom;

    // Calculate Individual Chart Dimensions
    const chartW = (usableW - ((cols - 1) * gap)) / cols;
    const chartH = (usableH - ((rows - 1) * gap)) / rows;

    return { rows, cols, chartW, chartH, gap, marginX, marginTop, slideWidth, slideHeight };
}

function openPreview() {
    const canvases = document.querySelectorAll("canvas");
    if(canvases.length === 0) { alert("No charts to export."); return; }
    
    // Set defaults if not already set
    if(!graphsPerSlide) graphsPerSlide = 2; 
    
    updatePreviewSettings(graphsPerSlide, chartExportColor, chartExportTitleColor);
    document.getElementById("previewModal").style.display = "flex";
}

function highlightSettingButtons(count, lineColor, titleColor) {
    document.querySelectorAll('.graph-options button').forEach(btn => {
        btn.classList.remove('active');
        btn.style.backgroundColor = '#2F80ED'; // Reset blue
        btn.style.color = 'white';
        if (parseInt(btn.dataset.count) === count) {
            btn.classList.add('active');
            btn.style.backgroundColor = '#27AE60'; // Active Green
        }
    });

    document.querySelectorAll('#lineColorOptions .color-option').forEach(el => {
        el.classList.remove('selected');
        if (el.dataset.color === lineColor) el.classList.add('selected');
    });

    document.querySelectorAll('#titleColorOptions .color-option').forEach(el => {
        el.classList.remove('selected');
        if (el.dataset.color === titleColor) el.classList.add('selected');
    });
}

function updatePreviewSettings(newCount, newLineColor, newTitleColor) {
    if (newCount) graphsPerSlide = parseInt(newCount);
    if (newLineColor) chartExportColor = newLineColor;
    if (newTitleColor) chartExportTitleColor = newTitleColor;

    highlightSettingButtons(graphsPerSlide, chartExportColor, chartExportTitleColor);
    
    const count = graphsPerSlide;
    const body = document.getElementById("previewBody");
    const canvases = document.querySelectorAll("canvas");
    
    document.getElementById("previewTitle").textContent = `PPT Export Preview (${count} Graphs per Slide)`;
    body.innerHTML = "";

    // Get layout config to ensure HTML CSS matches PPT Logic
    const layout = getLayoutConfig(count);

    // Generate CSS Grid Template based on calculated columns
    const gridTemplateCols = `repeat(${layout.cols}, 1fr)`;

    for(let i=0; i<canvases.length; i+=count){
        const slideDiv = document.createElement("div");
        slideDiv.className = "preview-slide";
        
        const slideTitle = document.createElement("div");
        slideTitle.className = "preview-slide-title";
        slideTitle.textContent = `Slide ${Math.floor(i/count) + 1}`;
        slideDiv.appendChild(slideTitle);

        const grid = document.createElement("div");
        grid.className = "preview-grid";
        grid.style.display = "grid";
        grid.style.gridTemplateColumns = gridTemplateCols;
        grid.style.gap = "10px";
        grid.style.height = "100%";
        grid.style.paddingTop = "30px"; // Visual padding for preview
        grid.style.alignContent = "start"; // Prevent vertical stretching weirdness

        for(let j=0; j<count; j++){
            if(i+j < canvases.length){
                const c = canvases[i+j];
                const box = createPreviewBox(c, chartExportColor, chartExportTitleColor); 
                
                // Adjust height for preview based on row count
                // We use percentage height in preview to mimic the PPT ratio
                box.style.height = `calc((100% / ${layout.rows}) - 15px)`; 
                
                grid.appendChild(box);
            }
        }
        slideDiv.appendChild(grid);
        body.appendChild(slideDiv);
    }
}

function createPreviewBox(canvas, lineColor, titleColor) {
Â  const box = document.createElement("div");
Â  box.className = "preview-img-box";
Â Â 
Â  // Create a temp canvas to redraw with export colors
Â  const tempCanvas = document.createElement('canvas');
Â  tempCanvas.width = canvas.width;
Â  tempCanvas.height = canvas.height;
Â  const tempCtx = tempCanvas.getContext('2d');
Â Â 
Â  const chartInstance = Chart.getChart(canvas.id);
Â  let imgData = '';
Â Â 
Â  if (chartInstance) {
        // NEW: Get current style config
        const styleConfig = CHART_STYLES[chartStyleKey];

Â  Â  Â  Â  // Store original values before export
        const originalDatasetProps = chartInstance.data.datasets.map(d => ({
            borderColor: d.borderColor,
            pointBorderColor: d.pointBorderColor,
            pointBackgroundColor: d.pointBackgroundColor,
            pointRadius: d.pointRadius,
            borderWidth: d.borderWidth,
            tension: d.tension,
            stepped: d.stepped,
            fill: d.fill,
            borderDash: d.borderDash,
            backgroundColor: d.backgroundColor,
            type: chartInstance.config.type // Store original chart type
        }));
        const originalTitleColor = chartInstance.options.plugins.title.color;
Â  Â  Â  Â Â 
        // --- Apply Export Styles ---
        chartInstance.config.type = styleConfig.type; // NEW: Apply new chart type

Â  Â  Â  Â  chartInstance.data.datasets.forEach(d => {Â 
Â  Â  Â  Â  Â  d.borderColor = lineColor;Â 
Â  Â  Â  Â  Â  d.pointBorderColor = lineColor;Â 
Â  Â  Â  Â  Â  d.pointBackgroundColor = lineColor;Â 
Â  Â  Â  Â  Â Â 
            // NEW: Apply Style Configuration
            d.tension = styleConfig.tension;
            d.stepped = styleConfig.stepped || false;
            d.fill = styleConfig.fill || false;
            d.borderDash = styleConfig.borderDash;
            d.borderWidth = styleConfig.borderWidth;
            d.pointRadius = styleConfig.pointRadius;
            d.backgroundColor = styleConfig.fill ? (lineColor + '80') : (styleConfig.backgroundColor || 'transparent');
            
Â  Â  Â  Â  Â  d.spanGaps = true;Â 
Â  Â  Â  Â  });

Â  Â  Â  chartInstance.options.plugins.title.color = titleColor;Â 
Â  Â  Â Â 
Â  Â  Â  chartInstance.update('none');Â 
Â  Â  Â Â 
Â  Â  Â  tempCtx.drawImage(canvas, 0, 0);
Â  Â  Â  imgData = tempCanvas.toDataURL("image/png");
Â  Â  Â Â 
Â  Â  Â  // --- Revert Styles ---
        chartInstance.config.type = originalDatasetProps[0].type; // NEW: Revert chart type

Â  Â  Â  Â  chartInstance.data.datasets.forEach((d, index) => {Â 
            d.borderColor = originalDatasetProps[index].borderColor; 
            d.pointBorderColor = originalDatasetProps[index].pointBorderColor;
            d.pointBackgroundColor = originalDatasetProps[index].pointBackgroundColor;
            d.pointRadius = originalDatasetProps[index].pointRadius;
            d.borderWidth = originalDatasetProps[index].borderWidth;
            d.tension = originalDatasetProps[index].tension;
            d.stepped = originalDatasetProps[index].stepped;
            d.fill = originalDatasetProps[index].fill;
            d.borderDash = originalDatasetProps[index].borderDash;
            d.backgroundColor = originalDatasetProps[index].backgroundColor;
Â  Â  Â  Â  Â  d.spanGaps = true;Â 
Â  Â  Â  Â  });
Â  Â  Â  chartInstance.options.plugins.title.color = originalTitleColor;
Â  Â  Â  chartInstance.update('none');
Â  }

Â  const img = document.createElement("img");
  img.src = imgData;
  img.style.maxHeight = "100%";
  img.style.maxWidth = "100%";
  img.style.objectFit = "contain";
  
  box.appendChild(img);
  return box;
}

function closePreview(){ document.getElementById("previewModal").style.display = "none"; }

async function downloadPPT(){
  const pptx = new PptxGenJS();
  pptx.layout = 'LAYOUT_16x9'; // 10 x 5.625 inches
  
  // Title Slide
  let slide = pptx.addSlide();
  slide.addText("LTE KPI Report", { x:0.5, y:2, fontSize:32, bold:true, color:'2F80ED' });
  slide.addText(`Generated: ${new Date().toLocaleDateString()}`, { x:0.5, y:3, fontSize:14 });

  const canvases = document.querySelectorAll("canvas");
  const count = graphsPerSlide;
  const lineColor = chartExportColor; 
  const titleColor = chartExportTitleColor;
  const styleConfig = CHART_STYLES[chartStyleKey];
  
  // Get EXACT calculated layout
  const layout = getLayoutConfig(count);

  for(let i=0; i<canvases.length; i+=count){
    let slide = pptx.addSlide();
    
    // Slide Header
    slide.addText("LTE KPI Dashboard Overview", { 
        x: 0.2, y: 0.2, fontSize: 18, color: 'D24726', bold: true 
    });

    // Add Charts
    for(let j=0; j<count; j++){
      if(i+j < canvases.length){
        const c = canvases[i+j];
        
        // Calculate Position based on Grid Logic
        const colIndex = j % layout.cols;
        const rowIndex = Math.floor(j / layout.cols);

        const xPos = layout.marginX + (colIndex * (layout.chartW + layout.gap));
        const yPos = layout.marginTop + (rowIndex * (layout.chartH + layout.gap));
        
        // --- PPT CHART EXPORT LOGIC ---
Â  Â  Â  Â  const chartInstance = Chart.getChart(c.id);

        // Store original values before export
        const originalDatasetProps = chartInstance.data.datasets.map(d => ({
            borderColor: d.borderColor,
            pointBorderColor: d.pointBorderColor,
            pointBackgroundColor: d.pointBackgroundColor,
            pointRadius: d.pointRadius,
            borderWidth: d.borderWidth,
            tension: d.tension,
            stepped: d.stepped,
            fill: d.fill,
            borderDash: d.borderDash,
            backgroundColor: d.backgroundColor,
            type: chartInstance.config.type
        }));
Â  Â  Â  Â  const originalTitleColor = chartInstance.options.plugins.title.color;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // NEW: Override chart type for export
        chartInstance.config.type = styleConfig.type;
        
Â  Â  Â  Â  // Override style for PPT export
Â  Â  Â  Â  chartInstance.data.datasets.forEach(d => {Â 
Â  Â  Â  Â  Â  d.borderColor = lineColor;Â 
Â  Â  Â  Â  Â  d.pointBorderColor = lineColor;Â 
Â  Â  Â  Â  Â  d.pointBackgroundColor = lineColor;Â 
Â  Â  Â  Â  Â  
            // NEW: Apply Style Configuration
            d.tension = styleConfig.tension;
            d.stepped = styleConfig.stepped || false;
            d.fill = styleConfig.fill || false;
            d.borderDash = styleConfig.borderDash;
            d.borderWidth = styleConfig.borderWidth;
            d.pointRadius = styleConfig.pointRadius;
            d.backgroundColor = styleConfig.fill ? (lineColor + '80') : (styleConfig.backgroundColor || 'transparent');
            
Â  Â  Â  Â  Â  d.spanGaps = true;Â 
Â  Â  Â  Â  });
Â  Â  Â  Â  chartInstance.options.plugins.title.color = titleColor;Â 
Â  Â  Â  Â  chartInstance.update('none');Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  const imgData = c.toDataURL("image/png");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Restore original styles
        chartInstance.config.type = originalDatasetProps[0].type; // Revert chart type

Â  Â  Â  Â  chartInstance.data.datasets.forEach((d, index) => {Â 
            d.borderColor = originalDatasetProps[index].borderColor; 
            d.pointBorderColor = originalDatasetProps[index].pointBorderColor;
            d.pointBackgroundColor = originalDatasetProps[index].pointBackgroundColor;
            d.pointRadius = originalDatasetProps[index].pointRadius;
            d.borderWidth = originalDatasetProps[index].borderWidth;
            d.tension = originalDatasetProps[index].tension;
            d.stepped = originalDatasetProps[index].stepped;
            d.fill = originalDatasetProps[index].fill;
            d.borderDash = originalDatasetProps[index].borderDash;
            d.backgroundColor = originalDatasetProps[index].backgroundColor;
Â  Â  Â  Â  Â  d.spanGaps = true;Â 
Â  Â  Â  Â  });
Â  Â  Â  Â  chartInstance.options.plugins.title.color = originalTitleColor;
Â  Â  Â  Â  chartInstance.update('none');
        // --- END PPT CHART EXPORT LOGIC ---
        
        // Add Image to Slide with calculated coordinates
        slide.addImage({ 
          data: imgData, 
          x: xPos, 
          y: yPos, 
          w: layout.chartW, 
          h: layout.chartH 
        });
      }
    }
  }

  pptx.writeFile({ fileName: `KPI_Report_${new Date().getTime()}.pptx` });
  closePreview();
}

// Init
fetchData();
</script>
</body>
</html>
