<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LTE KPI Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<style>
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f4f6f8; overflow-x:hidden; }
header { text-align:center; padding:20px 0; font-size:28px; font-weight:700; color:#1a1a1a; background:white; box-shadow:0 1px 4px rgba(0,0,0,0.05); margin-bottom:20px; }

/* Navigation */
.navbar { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
.navbar button { padding:8px 20px; cursor:pointer; border:none; background:#ffffff; color:#555; border: 1px solid #ddd; border-radius:20px; font-weight:600; transition:0.2s; }
.navbar button:hover { background:#f0f0f0; color:#333; }
.navbar button.active-nav { background:#2F80ED; color:white; border-color:#2F80ED; }

/* Tabs */
.tabs { display:flex; justify-content:center; margin-bottom:20px; gap:10px; }
.tab { padding:10px 24px; cursor:pointer; border-radius:30px; background:#e0e0e0; color:#555; font-weight:600; transition:0.3s; border:none; }
.tab.active { background:#2F80ED; color:white; box-shadow: 0 4px 10px rgba(47, 128, 237, 0.3); }

/* Controls */
.controls { display:flex; justify-content:center; gap:12px; margin-bottom:24px; flex-wrap:wrap; align-items: center; }
select, input { padding:10px; border-radius:8px; border:1px solid #dae1e7; font-size:14px; outline:none; }
#siteFilter { width:220px; }

/* Buttons */
.action-btn { padding:10px 20px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:8px; font-weight:600; transition:0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.action-btn:hover { background:#1c6cdb; transform: translateY(-1px); }
#exportBtn { background: #27ae60; } 
#exportBtn:hover { background: #219150; }

/* Chart Grid */
.chart-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(500px,1fr)); gap:24px; padding:0 24px 40px 24px; max-width: 1600px; margin: 0 auto; }
.chart-card { 
  background:white; 
  border-radius:16px; 
  padding:20px; 
  box-shadow:0 2px 10px rgba(0,0,0,0.03); 
  border: 1px solid #f0f0f0;
  transition: transform 0.2s ease;
}
.chart-card:hover { transform: translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,0.06); }

.chart-header { display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.chart-title { font-size: 16px; font-weight: 700; color: #2c3e50; }
.chart-badge { font-size: 12px; background: #eef2ff; color: #2F80ED; padding: 4px 8px; border-radius: 6px; font-weight: 600; }

.chart-container { position: relative; height: 300px; width: 100%; }

/* Dropdown Custom */
.custom-dropdown-wrapper { position: relative; }
#dropdown, #siteDropdownList { position:absolute; background:white; border:1px solid #eee; max-height:250px; overflow-y:auto; display:none; z-index:100; width:100%; border-radius:8px; top:110%; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
#dropdown div, #siteDropdownList div { padding:8px 12px; cursor:pointer; font-size:14px; border-bottom: 1px solid #f9f9f9; }
#dropdown div:hover, #siteDropdownList div:hover { background:#f5f9ff; color:#2F80ED; }

/* KPI Drawer */
.kpiDrawer { position:fixed; top:0; right:0; width:340px; height:100%; background:white; box-shadow:-5px 0 20px rgba(0,0,0,0.1); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index:1000; padding:25px; overflow-y:auto; transform: translateX(100%); }
.kpiDrawer.open { transform: translateX(0); }
.drawer-header { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; }
.kpiDrawerToggle { position:fixed; top:120px; right:0; width:40px; height:40px; background:#2F80ED; border-radius:8px 0 0 8px; cursor:pointer; z-index:900; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; box-shadow: -2px 2px 5px rgba(0,0,0,0.1); }

/* Modal */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
.modal-content { background: white; padding: 24px; width: 600px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
.modal-title { font-size: 22px; font-weight: bold; margin-bottom: 10px; }
.modal-desc { color: #666; margin-bottom: 24px; }
</style>
</head>
<body>

<header>KPI Dashboard</header>

<div class="navbar">
  <button>GSM</button>
  <button class="active-nav">LTE</button>
  <button>NR</button>
</div>

<div class="tabs">
  <div class="tab active" data-tab="acceptance">Acceptance</div>
  <div class="tab" data-tab="monitoring">Monitoring</div>
</div>

<div class="controls">
  <div class="custom-dropdown-wrapper">
    <input type="text" id="siteFilter" placeholder="Search Site Name...">
    <div id="dropdown"></div>
  </div>

  <div class="custom-dropdown-wrapper" style="width: 200px;">
    <button id="siteDropdownBtn" class="action-btn" style="background:white; color:#333; border:1px solid #ccc; width:100%; text-align:left; display:flex; justify-content:space-between;">
      <span>All Sites</span> <span>▼</span>
    </button>
    <div id="siteDropdownList"></div>
  </div>

  <button id="refreshBtn" class="action-btn">Refresh Data</button>
  <button id="exportBtn" class="action-btn">Export PPT</button>
</div>

<div id="acceptancePage">
  <div class="chart-grid" id="acceptanceChartContainer"></div>
</div>
<div id="monitoringPage" style="display:none;">
  <div class="chart-grid" id="monitoringChartContainer"></div>
</div>

<div id="acceptanceDrawer" class="kpiDrawer">
  <div class="drawer-header">Select KPIs</div>
  <div><input type="checkbox" id="selectAllAcceptance"> <label for="selectAllAcceptance"><b>Select All</b></label></div>
  <div id="acceptanceKpiOptions" style="margin-top:10px;"></div>
  <button id="applyAcceptanceBtn" class="action-btn" style="width:100%; margin-top:20px;">Apply Changes</button>
</div>
<div id="monitoringDrawer" class="kpiDrawer">
  <div class="drawer-header">Select KPIs</div>
  <div><input type="checkbox" id="selectAllMonitoring"> <label for="selectAllMonitoring"><b>Select All</b></label></div>
  <div id="monitoringKpiOptions" style="margin-top:10px;"></div>
  <button id="applyMonitoringBtn" class="action-btn" style="width:100%; margin-top:20px;">Apply Changes</button>
</div>

<div id="drawerToggle" class="kpiDrawerToggle">⚙</div>

<div id="exportModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-title">Exporting to PowerPoint</div>
    <div class="modal-desc">Generating slides for <span id="slideCount">0</span> charts...</div>
    <div style="width:100%; height:4px; background:#eee; border-radius:2px; overflow:hidden;">
      <div id="progressBar" style="width:0%; height:100%; background:#27ae60; transition:width 0.3s;"></div>
    </div>
  </div>
</div>

<script>
// --- GLOBAL VARIABLES ---
let allData=[], fuse=null, allSites=[];
let selectedSites=[];
let selectedAcceptanceKpis=[], selectedMonitoringKpis=[];
let currentTab="acceptance";

// KPI Definitions
const acceptanceKpis = [
  "LTE RRC Setup Success Rate","ERAB Setup Success Rate","LTE Call Setup Success Rate","E-RAB Call Drop Rate",
  "CSFB Access Success Rate","LTE Intra Freq HO Success Rate","Intra-eNB HO Success Success Rate","Inter-eNBX2HO Success Rate",
  "Inter-eNBS1HO Success Rate","Max RRC Connected Ue","DL Data Total Volume (Gbyte)","UL Data Total Volume (Gbyte)",
  "E-RAB Setup Success Rate (VoIP)","Call Drop Rate (VoIP)","Intra-frequency Handover Out Success Rate(VoIP)",
  "Inter-frequency Handover Out Success Rate(VoIP)","SRVCC Success Rate (L2W)","SRVCC Success Rate (L2G)"
];
const monitoringKpis = [
  "Cell Availability Ratio","Average Latency Downlink (msecs)","DL PRB Utilization (%)","UL PRB Utilization (%)",
  "LTE DL - Cell Average Throughput (Mbit/s)","LTE UL - Cell Average Thoughput (Mbit/s)","LTE DL -USER Average Throughput (Mbit/s)",
  "LTE UL -USER Average Throughput (Mbit/s)","Downlink Packet Loss Rate (VoIP)","Uplink Packet Loss Rate (VoIP)",
  "VoLTE Traffic Erlang","VoLTE Traffic DL (MB)","VoLTE Traffic UL (MB)","DL BLER QCI1","UL BLER QCI1"
];

// --- DATA FETCHING ---
async function fetchData(){
  try {
    // Adding timestamp to avoid caching
    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=0&single=true&output=csv&t=" + Date.now();
    const res = await fetch(url);
    const text = await res.text();
    
    // Parse CSV
    const rows = text.trim().split('\n').map(r=>r.split(','));
    const headers = rows.shift().map(h=>h.trim());
    allData = rows.map(r=>{ 
      const obj={}; 
      headers.forEach((h,i)=>{ 
        const val=r[i]?r[i].trim():""; 
        // Handle numbers/empty strings
        if(val==="") obj[h]=null;
        else obj[h]=isNaN(val)?val:parseFloat(val); 
      }); 
      return obj; 
    });

    // Initialize Search & Filter
    fuse = new Fuse(allData,{ keys:['eNodeB Name'], threshold:0.4 });
    allSites = [...new Set(allData.map(d=>d["eNodeB Name"]))].filter(s=>s).sort();
    
    populateSiteDropdown();
    populateKpiDrawers();
    drawCurrentPageCharts();

  } catch(e) { console.error(e); alert("Error loading data."); }
}

// --- CHARTS & UI ---

function drawCharts(kpis, containerId){
  const container = document.getElementById(containerId);
  container.innerHTML = "";
  
  // 1. Process Timeline
  const timeline = [...new Set(allData.map(d=>d["Date"]))];
  timeline.sort((a,b)=>{
    const [da,ma,ya]=a.split('/').map(Number);
    const [db,mb,yb]=b.split('/').map(Number);
    return new Date(ya,ma-1,da)-new Date(yb,mb-1,db);
  });
  
  // 2. Filter Data
  let filteredData = allData;
  if(selectedSites.length > 0) {
    filteredData = allData.filter(d => selectedSites.includes(d["eNodeB Name"]));
  }

  // 3. Generate Charts
  kpis.forEach((kpi, index) => {
    // Create Layout
    const card = document.createElement("div");
    card.className = "chart-card";
    
    // Header
    const header = document.createElement("div");
    header.className = "chart-header";
    
    const title = document.createElement("div");
    title.className = "chart-title";
    let siteLabel = selectedSites.length === 1 ? selectedSites[0] : (selectedSites.length ? "Multiple Sites" : "All Sites");
    title.innerHTML = `${kpi} <br><span style="font-weight:400; font-size:12px; color:#777;">${siteLabel}</span>`;
    
    const badge = document.createElement("div");
    badge.className = "chart-badge";
    badge.textContent = currentTab.toUpperCase();

    header.appendChild(title);
    header.appendChild(badge);
    
    // Canvas Container
    const chartWrapper = document.createElement("div");
    chartWrapper.className = "chart-container";
    const canvas = document.createElement("canvas");
    canvas.id = `canvas_${containerId}_${index}`; // ID for export
    chartWrapper.appendChild(canvas);

    card.appendChild(header);
    card.appendChild(chartWrapper);
    container.appendChild(card);

    // Data Processing
    const dataPoints = timeline.map(date => {
      const vals = filteredData.filter(d => d["Date"] === date && d[kpi] !== null).map(d => d[kpi]);
      if (vals.length === 0) return null;
      const sum = vals.reduce((a,b) => a+b, 0);
      const isRate = kpi.toLowerCase().match(/(rate|%|ratio|average)/);
      return isRate ? sum / vals.length : sum;
    });

    // Chart.js Configuration
    const ctx = canvas.getContext("2d");
    
    // Create Gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(47, 128, 237, 0.4)'); // Top: Blue
    gradient.addColorStop(1, 'rgba(47, 128, 237, 0.0)'); // Bottom: Transparent

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: timeline,
        datasets: [{
          label: kpi,
          data: dataPoints,
          borderColor: '#2F80ED',
          backgroundColor: gradient,
          borderWidth: 2,
          pointBackgroundColor: '#ffffff',
          pointBorderColor: '#2F80ED',
          pointRadius: 4,
          pointHoverRadius: 6,
          fill: true,
          tension: 0.3, // Curve
          spanGaps: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }, // Hide legend, title is enough
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            titleColor: '#333',
            bodyColor: '#333',
            borderColor: '#ddd',
            borderWidth: 1
          }
        },
        scales: {
          x: { 
            grid: { display: false },
            ticks: { font: { size: 10 } }
          },
          y: { 
            beginAtZero: true,
            grid: { color: '#f0f0f0' },
            border: { display: false }
          }
        }
      }
    });
  });
}

// --- POWERPOINT EXPORT ---
document.getElementById("exportBtn").addEventListener("click", async () => {
  const containerId = currentTab === "acceptance" ? "acceptanceChartContainer" : "monitoringChartContainer";
  const container = document.getElementById(containerId);
  const canvases = container.querySelectorAll("canvas");
  
  if (canvases.length === 0) return alert("No charts to export.");

  // Show Modal
  const modal = document.getElementById("exportModal");
  const slideCount = document.getElementById("slideCount");
  const progressBar = document.getElementById("progressBar");
  modal.style.display = "flex";
  slideCount.textContent = canvases.length;
  
  // Init PPT
  const pptx = new PptxGenJS();
  pptx.layout = 'LAYOUT_WIDE'; // 16:9
  pptx.author = 'KPI Dashboard';
  pptx.company = 'Network Team';
  pptx.title = `KPI Report - ${currentTab.toUpperCase()}`;

  // Title Slide
  let slide = pptx.addSlide();
  slide.background = { color: "F4F6F8" };
  slide.addText(`LTE KPI Report: ${currentTab.toUpperCase()}`, { x:1, y:2, w:'80%', fontSize:36, bold:true, color:'2F80ED' });
  slide.addText(`Generated: ${new Date().toLocaleString()}`, { x:1, y:3, fontSize:14, color:'666666' });
  if(selectedSites.length > 0) {
     slide.addText(`Sites: ${selectedSites.join(", ")}`, { x:1, y:3.5, fontSize:12, color:'888888' });
  }

  // Loop Charts
  for (let i = 0; i < canvases.length; i++) {
    const canvas = canvases[i];
    // Find the title text from the DOM
    const titleDiv = canvas.closest('.chart-card').querySelector('.chart-title');
    // Extract text content, replacing <br> with space
    const titleText = titleDiv.innerText.replace(/\n/g, " - ");

    // Create Slide
    let slide = pptx.addSlide();
    slide.background = { color: "FFFFFF" };
    
    // Add Header Bar
    slide.addShape(pptx.ShapeType.rect, { x:0, y:0, w:'100%', h:0.8, fill:'2F80ED' });
    slide.addText(titleText, { x:0.5, y:0.1, w:'90%', fontSize:20, color:'FFFFFF', bold:true });

    // Add Image
    const imgData = canvas.toDataURL("image/png");
    slide.addImage({ data: imgData, x: 0.5, y: 1, w: 12.33, h: 5.5 });
    
    // Progress
    progressBar.style.width = `${((i+1)/canvases.length)*100}%`;
    await new Promise(r => setTimeout(r, 50)); // Small delay for UI update
  }

  // Save
  pptx.writeFile({ fileName: `KPI_Report_${currentTab}_${Date.now()}.pptx` });
  
  // Close Modal
  setTimeout(() => { modal.style.display = "none"; progressBar.style.width = "0%"; }, 1000);
});

// --- HELPER FUNCTIONS ---
function populateSiteDropdown(){
  const list = document.getElementById("siteDropdownList");
  const btn = document.getElementById("siteDropdownBtn");
  list.innerHTML = "";

  // Actions
  const actions = [
    { txt: "Select All", fn: () => { selectedSites = [...allSites]; redrawSite(); } },
    { txt: "Clear All", fn: () => { selectedSites = []; redrawSite(); } }
  ];
  
  actions.forEach(a => {
    const d = document.createElement("div");
    d.innerHTML = `<b>${a.txt}</b>`;
    d.onclick = a.fn;
    list.appendChild(d);
  });

  // Options
  allSites.forEach(site => {
    const d = document.createElement("div");
    d.innerHTML = `<input type='checkbox' value='${site}' class='site-chk'> ${site}`;
    d.onclick = (e) => {
       if(e.target.tagName !== "INPUT") {
          const chk = d.querySelector("input");
          chk.checked = !chk.checked;
       }
       updateSelected();
    };
    list.appendChild(d);
  });

  function updateSelected() {
    selectedSites = Array.from(list.querySelectorAll(".site-chk:checked")).map(c => c.value);
    const span = btn.querySelector("span");
    span.textContent = selectedSites.length === 0 ? "All Sites" : (selectedSites.length === 1 ? selectedSites[0] : `Selected (${selectedSites.length})`);
    drawCurrentPageCharts();
  }

  function redrawSite() {
    list.querySelectorAll(".site-chk").forEach(c => c.checked = selectedSites.includes(c.value));
    updateSelected();
  }

  btn.onclick = () => list.style.display = list.style.display==="block" ? "none" : "block";
}

// KPI Drawer Logic
function populateKpiDrawers(){
  function setupDrawer(kpiList, containerId, selectAllId) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    kpiList.forEach(kpi => {
      const div = document.createElement("div");
      div.style.padding = "5px 0";
      div.innerHTML = `<input type='checkbox' value='${kpi}' checked> <span style='font-size:14px'>${kpi}</span>`;
      container.appendChild(div);
    });
  }
  setupDrawer(acceptanceKpis, "acceptanceKpiOptions", "selectAllAcceptance");
  setupDrawer(monitoringKpis, "monitoringKpiOptions", "selectAllMonitoring");
}

document.getElementById("applyAcceptanceBtn").addEventListener("click", () => {
   const chks = document.querySelectorAll("#acceptanceKpiOptions input:checked");
   selectedAcceptanceKpis = Array.from(chks).map(c => c.value);
   document.getElementById("acceptanceDrawer").classList.remove("open");
   drawCharts(selectedAcceptanceKpis.length ? selectedAcceptanceKpis : acceptanceKpis, "acceptanceChartContainer");
});

document.getElementById("applyMonitoringBtn").addEventListener("click", () => {
   const chks = document.querySelectorAll("#monitoringKpiOptions input:checked");
   selectedMonitoringKpis = Array.from(chks).map(c => c.value);
   document.getElementById("monitoringDrawer").classList.remove("open");
   drawCharts(selectedMonitoringKpis.length ? selectedMonitoringKpis : monitoringKpis, "monitoringChartContainer");
});

// Search
const siteInput = document.getElementById("siteFilter");
const dropdown = document.getElementById("dropdown");
siteInput.addEventListener("input", () => {
  const val = siteInput.value.trim();
  if (!val) { dropdown.style.display = "none"; return; }
  const res = fuse.search(val).slice(0, 5);
  dropdown.innerHTML = "";
  res.forEach(r => {
     const d = document.createElement("div");
     d.textContent = r.item["eNodeB Name"];
     d.onclick = () => {
        selectedSites = [r.item["eNodeB Name"]];
        document.getElementById("siteDropdownBtn").querySelector("span").textContent = selectedSites[0];
        dropdown.style.display = "none";
        drawCurrentPageCharts();
     };
     dropdown.appendChild(d);
  });
  dropdown.style.display = res.length ? "block" : "none";
});

// UI Event Listeners
document.getElementById("drawerToggle").onclick = () => {
   const d = document.getElementById(currentTab + "Drawer");
   d.classList.toggle("open");
};
document.querySelectorAll(".tab").forEach(t => t.onclick = function() {
   document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
   this.classList.add("active");
   currentTab = this.dataset.tab;
   document.getElementById("acceptancePage").style.display = currentTab === "acceptance" ? "block" : "none";
   document.getElementById("monitoringPage").style.display = currentTab === "monitoring" ? "block" : "none";
   drawCurrentPageCharts();
});
document.getElementById("refreshBtn").onclick = fetchData;

function drawCurrentPageCharts() {
   const isAcc = currentTab === "acceptance";
   const kpis = isAcc ? (selectedAcceptanceKpis.length ? selectedAcceptanceKpis : acceptanceKpis) 
                      : (selectedMonitoringKpis.length ? selectedMonitoringKpis : monitoringKpis);
   drawCharts(kpis, isAcc ? "acceptanceChartContainer" : "monitoringChartContainer");
}

fetchData();
</script>
</body>
</html>
