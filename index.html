<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LTE KPI Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<style>
/* --- BASE STYLES --- */
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f4f7f6; overflow-x:hidden; }
header { text-align:center; padding:15px 0; font-size:28px; font-weight:700; color:#333; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.05); margin-bottom:15px; }

/* --- NAVIGATION --- */
.navbar { display:flex; justify-content:center; gap:12px; margin-bottom:15px; }
.nav-btn { padding:8px 24px; cursor:pointer; border:1px solid #ccc; background:white; color:#555; border-radius:20px; font-weight:600; text-decoration:none; transition:0.2s; display:inline-block; }
.nav-btn:hover { background:#f0f0f0; color:#333; }
.nav-btn.active { background:#2F80ED; color:white; border-color:#2F80ED; }

/* --- TABS --- */
.tabs { display:flex; justify-content:center; margin-bottom:20px; gap:8px; }
.tab { padding:8px 20px; cursor:pointer; border-radius:6px; background:#e0e0e0; color:#555; font-weight:bold; border:none; transition:0.2s; }
.tab:hover { background:#d0d0d0; }
.tab.active { background:#2F80ED; color:white; }

/* --- CONTROLS --- */
.controls { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
.control-group { position:relative; }
input, select { padding:8px; border-radius:6px; border:1px solid #ccc; font-size:14px; outline:none; }
button.action-btn { padding:8px 16px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:600; transition:0.2s; }
button.action-btn:hover { background:#1f5ab5; }
button.ppt-btn { background:#D24726; } /* PowerPoint Orange */
button.ppt-btn:hover { background:#a8381e; }

/* --- CHART STYLE SELECTOR (Inside Style Drawer) --- */
.style-options { 
    display: flex; 
    flex-direction: column; 
    gap: 5px; 
    margin-top: 5px;
}
.style-options button {
    background: #f0f0f0;
    color: #333;
    padding: 6px 10px;
    border: 1px solid #ddd;
    text-align: left;
}
.style-options button.active {
    background: #2F80ED;
    color: white;
    border-color: #2F80ED;
}


/* --- GRID LAYOUT (3 Graphs per row) --- */
.chart-grid { 
  display:grid; 
  grid-template-columns: repeat(3, 1fr); 
  gap:20px; 
  padding:0 20px 40px 20px; 
  max-width: 1800px; 
  margin: 0 auto; 
}
@media (max-width: 1400px) { .chart-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) { .chart-grid { grid-template-columns: 1fr; } }

/* --- CARDS & CHARTS --- */
.chart-card { background:white; border-radius:8px; padding:15px; box-shadow:0 2px 8px rgba(0,0,0,0.08); display:flex; flex-direction:column; }
.chart-title { display:none; } 
.chart-container { position: relative; height: 280px; width: 100%; }

/* --- DROPDOWNS --- */
#dropdown, #siteDropdownList, #onAirDateDropdownList { 
  position:absolute; 
  background:white; 
  border:1px solid #ccc; 
  max-height:200px; 
  overflow-y:auto; 
  display:none; 
  z-index:100; 
  width:100%; 
  top:105%; 
  border-radius:6px; 
  box-shadow:0 4px 10px rgba(0,0,0,0.1); 
}
#dropdown div, #siteDropdownList div, #onAirDateDropdownList div { padding:6px 10px; cursor:pointer; font-size:13px; border-bottom:1px solid #eee; }
#dropdown div:hover, #siteDropdownList div:hover, #onAirDateDropdownList div:hover { background:#f0f7ff; color:#2F80ED; }

/* --- DRAWER STYLES (KPI and Style) --- */
/* Base Toggle Button Style */
.drawerToggle { 
    position:fixed; 
    width:36px; 
    height:36px; 
    background:#2F80ED; 
    color:white; 
    border-radius:6px 0 0 6px; 
    cursor:pointer; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    font-size:20px; 
    z-index:900; 
    transition: right 0.3s; 
}
/* Positioning for KPI button (bottom) */
.kpiDrawerToggle { right:0; top:145px; } /* Moved down */

/* Positioning for Style button (top, just above KPI) */
.styleDrawerToggle { right:0; top:100px; } /* Moved up */ 

/* Base Drawer Style */
.drawer { 
  position:fixed; top:0; right:0; 
  width:320px; 
  height:100%; background:white; 
  box-shadow:-2px 0 10px rgba(0,0,0,0.1); z-index:1000; 
  transform:translateX(100%); transition:0.3s; padding:20px; 
  display: flex; flex-direction: column; 
}
.drawer.open { transform:translateX(0); }

/* Adjustments when drawers are open (both buttons move out of the way) */
#kpiDrawer.open ~ .styleDrawerToggle { right: 320px; }
#kpiDrawer.open ~ .kpiDrawerToggle { right: 320px; } 

/* The style drawer opens on top and doesn't need to push the KPI toggle out since it is now below it. */
#styleDrawer { z-index: 1001; }
#styleDrawer.open ~ .kpiDrawerToggle { right: 320px; }
#styleDrawer.open ~ .styleDrawerToggle { right: 320px; }


.drawer-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 10px; 
    padding-bottom: 10px; 
    border-bottom: 1px solid #eee; 
    flex-shrink: 0;
}
.drawer-header h3 { margin: 0; }
.drawer-controls { 
    display: flex; 
    gap: 5px; 
    align-items: center; 
}
.drawer-controls .action-btn { 
    padding: 6px 10px; 
    font-size: 13px; 
}
.drawer-body { flex-grow: 1; overflow-y: auto; padding-right: 5px; padding-bottom: 40px; } 

/* --- PREVIEW MODAL --- */
.modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(3px); }
.modal-content { 
    background:white; 
    width:95%; 
    max-width: 1400px; 
    height:90vh; 
    border-radius:12px; 
    display:flex; 
    flex-direction:column; 
    box-shadow:0 10px 25px rgba(0,0,0,0.3); 
}
.modal-header { padding:15px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; font-weight:bold; font-size:18px; }
.modal-body { flex:1; display: flex; padding:0; overflow: hidden; } 

/* Preview Side */
#previewBody { 
    flex: 1; 
    overflow-y:auto; 
    padding:20px; 
    background:#f5f5f5; 
}
.preview-slide { background:white; border:1px solid #ddd; margin-bottom:20px; padding:20px; box-shadow:0 2px 5px rgba(0,0,0,0.05); aspect-ratio: 16/9; position:relative; }
.preview-slide-title { position:absolute; top:10px; left:20px; font-size:16px; font-weight:bold; color:#D24726; }
.preview-grid { display:grid; height:100%; align-items:center; padding-top:30px; }
.preview-img-box { text-align:center; padding:5px; height:100%; display:flex; flex-direction:column; justify-content:center; }
.preview-img-box img { max-width:100%; max-height:calc(100% - 20px); object-fit:contain; border:1px solid #eee; }
.preview-label { display: none; } 

/* Settings Side (Fixed, not scrollable) */
#previewSettingsPanel {
    width: 250px;
    background: #fff;
    border-left: 1px solid #eee;
    padding: 20px;
    display: flex;
    flex-direction: column;
    flex-shrink: 0; 
}
.settings-group { margin-bottom: 20px; }
.settings-group h4 { margin-top: 0; margin-bottom: 10px; font-size: 14px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.graph-options button { margin: 5px; width: 100px; padding: 6px; font-size: 13px; }

/* Color Selector */
.color-option { margin: 5px; display: inline-block; cursor: pointer; border: 2px solid transparent; border-radius: 50%; width: 25px; height: 25px; transition: border 0.1s; }
.color-option.selected { border-color: #333; }

.modal-footer { 
    padding:15px 20px; 
    border-top:1px solid #eee; 
    text-align:right;
    flex-shrink: 0; 
}
</style>
</head>
<body>

<header>LTE KPI Dashboard</header>

<div class="navbar">
  <a href="gsm.html" class="nav-btn">GSM</a>
  <a href="index.html" class="nav-btn active">LTE</a>
  <a href="nr.html" class="nav-btn">NR</a>
</div>

<div class="tabs">
  <button class="tab active" onclick="switchTab('both')">All KPIs (Both)</button> 
  <button class="tab" onclick="switchTab('acceptance')">Acceptance</button>
  <button class="tab" onclick="switchTab('monitoring')">Monitoring</button>
</div>

<div class="controls">
  <div class="control-group" style="width:200px;">
    <button id="onAirDateDropdownBtn" class="action-btn" style="background:white; color:#333; border:1px solid #ccc; width:100%; text-align:left; display:flex; justify-content:space-between;">
      <span id="onAirDateBtnLabel">All On-Air Dates</span> <span>â–¼</span>
    </button>
    <div id="onAirDateDropdownList"></div>
  </div>

  <div class="control-group" style="width:200px;">
    <button id="siteDropdownBtn" class="action-btn" style="background:white; color:#333; border:1px solid #ccc; width:100%; text-align:left; display:flex; justify-content:space-between;">
      <span id="siteBtnLabel">All Sites</span> <span>â–¼</span>
    </button>
    <div id="siteDropdownList"></div>
  </div>

  <button onclick="fetchData()" class="action-btn">Refresh</button>
  <button onclick="openPreview()" class="action-btn ppt-btn">Export PPT</button>
</div>

<div class="chart-grid" id="mainChartContainer"></div>

<div class="styleDrawerToggle drawerToggle" onclick="toggleStyleDrawer()">ðŸŽ¨</div>
<div id="styleDrawer" class="drawer">
  <div class="drawer-header">
    <h3>Chart Style Settings</h3>
    <button onclick="toggleStyleDrawer()" style="border:none; background:none; font-size:24px; cursor:pointer; color:#777;">âœ•</button>
  </div>
  <div class="drawer-body">
    <h4>Chart Display Style (Select one)</h4>
    <div id="chartStyleOptions" class="style-options">
      </div>
    <p style="margin-top:20px; font-size:12px; color:#555;">Styles like 'Area Fill' use the segment painting feature you requested.</p>
  </div>
</div>

<div class="kpiDrawerToggle drawerToggle" onclick="toggleKpiDrawer()">âš™</div>
<div id="kpiDrawer" class="drawer">
  <div class="drawer-header">
    <h3>KPI Visibility Settings</h3>
    <div class="drawer-controls">
        <button class="action-btn" onclick="selectVisibleKpis()" style="background:#5cb85c;">Select All</button>
        <button class="action-btn" onclick="clearVisibleKpis()" style="background:#f0ad4e;">Clear All</button>
        <button class="action-btn" onclick="applyKpis()">Apply</button>
        <button onclick="toggleKpiDrawer()" style="border:none; background:none; font-size:24px; cursor:pointer; color:#777;">âœ•</button>
    </div>
  </div>
  <div class="drawer-body" id="kpiOptionsList">
    </div>
</div>


<div id="previewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span id="previewTitle">PPT Export Preview</span>
      <button onclick="closePreview()" style="border:none; background:none; font-size:20px; cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body">
        
        <div id="previewBody">
          </div>

        <div id="previewSettingsPanel">
            <h3>Export Settings</h3>

            <div class="settings-group">
                <h4>Graphs per Slide (Rows)</h4>
                <div class="graph-options">
                    <button class="action-btn" data-count="1" onclick="updatePreviewSettings(1, chartExportColor, chartExportTitleColor)">1 Graph</button>
                    <button class="action-btn" data-count="2" onclick="updatePreviewSettings(2, chartExportColor, chartExportTitleColor)">2 Graphs</button>
                    <button class="action-btn" data-count="3" onclick="updatePreviewSettings(3, chartExportColor, chartExportTitleColor)">3 Graphs</button>
                    <button class="action-btn" data-count="4" onclick="updatePreviewSettings(4, chartExportColor, chartExportTitleColor)">4 Graphs</button>
                    <button class="action-btn" data-count="6" onclick="updatePreviewSettings(6, chartExportColor, chartExportTitleColor)">6 Graphs</button>
                    <button class="action-btn" data-count="9" onclick="updatePreviewSettings(9, chartExportColor, chartExportTitleColor)">9 Graphs</button>
                </div>
            </div>

            <div class="settings-group">
                <h4>Line & Dot Color for PPT</h4>
                <div id="lineColorOptions">
                    <span class="color-option" style="background-color:#2F80ED;" data-color="#2F80ED" onclick="updatePreviewSettings(graphsPerSlide, '#2F80ED', chartExportTitleColor)"></span>
                    <span class="color-option" style="background-color:#27AE60;" data-color="#27AE60" onclick="updatePreviewSettings(graphsPerSlide, '#27AE60', chartExportTitleColor)"></span>
                    <span class="color-option" style="background-color:#D24726;" data-color="#D24726" onclick="updatePreviewSettings(graphsPerSlide, '#D24726', chartExportTitleColor)"></span>
                    <span class="color-option" style="background-color:#8E44AD;" data-color="#8E44AD" onclick="updatePreviewSettings(graphsPerSlide, '#8E44AD', chartExportTitleColor)"></span>
                    <span class="color-option" style="background-color:#F39C12;" data-color="#F39C12" onclick="updatePreviewSettings(graphsPerSlide, '#F39C12', chartExportTitleColor)"></span>
                </div>
            </div>

            <div class="settings-group">
                <h4>Chart Title Color for PPT</h4>
                <div id="titleColorOptions">
                    <span class="color-option" style="background-color:#333333;" data-color="#333333" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#333333')"></span>
                    <span class="color-option" style="background-color:#000000;" data-color="#000000" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#000000')"></span>
                    <span class="color-option" style="background-color:#2F80ED;" data-color="#2F80ED" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#2F80ED')"></span>
                    <span class="color-option" style="background-color:#8E44AD;" data-color="#8E44AD" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#8E44AD')"></span>
                    <span class="color-option" style="background-color:#D24726;" data-color="#D24726" onclick="updatePreviewSettings(graphsPerSlide, chartExportColor, '#D24726')"></span>
                </div>
            </div>

            <div style="margin-top: auto; padding-top: 15px; border-top: 1px solid #eee;">
                <p style="font-size: 12px; color: #777;">Preview updates instantly.</p>
            </div>
        </div>

    </div>
    <div class="modal-footer">
      <button class="action-btn" style="background:#888;" onclick="closePreview()">Cancel</button>
      <button class="action-btn ppt-btn" onclick="downloadPPT()">Download .PPTX</button>
    </div>
  </div>
</div>

<script>
// --- CONFIG & STATE ---
let allData = [];
let allSites = [];
let siteCutoverMap = {}; 
let allOnAirDates = [];
let selectedOnAirDates = [];

let selectedSites = [];
let currentTab = "both"; 
let graphsPerSlide = 2; 

let chartExportColor = '#2F80ED'; 
let chartExportTitleColor = '#333333'; 

// Chart styles
const chartStyles = {
  'Default': { border: 2, pointRadius: 3, tension: 0.1, gridColor: '#eee', bgColor: 'white', titleColor: '#333', fill: false, stepped: false },
  'Minimalist': { border: 1, pointRadius: 2, tension: 0.3, gridColor: '#f5f5f5', bgColor: 'white', titleColor: '#555', fill: false, stepped: false },
  'Bright Dots': { border: 3, pointRadius: 4, tension: 0.2, gridColor: '#ddd', bgColor: 'white', titleColor: '#333', fill: false, stepped: false },
  'Smooth & Thin': { border: 1, pointRadius: 0, tension: 0.4, gridColor: '#f0f0f0', bgColor: 'white', titleColor: '#333', fill: false, stepped: false },
  'Bold Lines': { border: 4, pointRadius: 0, tension: 0.1, gridColor: '#eee', bgColor: 'white', titleColor: '#333', fill: false, stepped: false },
  'Area Fill (Light)': { border: 2, pointRadius: 3, tension: 0.3, gridColor: '#eee', bgColor: 'white', titleColor: '#333', fill: 'origin', alpha: 0.15, stepped: false },
  'Shadowed Line': { border: 3, pointRadius: 4, tension: 0.2, gridColor: '#f0f0f0', bgColor: 'white', titleColor: '#333', fill: 'origin', alpha: 0.25, stepped: false },
  'Stepped Line': { border: 2, pointRadius: 3, tension: 0.0, gridColor: '#eee', bgColor: 'white', titleColor: '#333', fill: false, stepped: true },
  'High Contrast': { border: 4, pointRadius: 5, tension: 0.0, gridColor: 'rgba(0,0,0,0.1)', bgColor: 'white', titleColor: '#000', fill: false, stepped: false },
  'Monochromatic': { border: 3, pointRadius: 3, tension: 0.2, gridColor: '#f5f5f5', bgColor: 'white', titleColor: '#333', fill: false, stepped: false }
};
let selectedStyle = 'Default';

// KPI lists
const acceptanceKpis = [
  "LTE RRC Setup Success Rate","ERAB Setup Success Rate","LTE Call Setup Success Rate","E-RAB Call Drop Rate",
  "CSFB Access Success Rate","LTE Intra Freq HO Success Rate","Intra-eNB HO Success Rate","Inter-eNBX2HO Success Rate",
  "Inter-eNBS1HO Success Rate","Max RRC Connected Ue","DL Data Total Volume (Gbyte)","UL Data Total Volume (Gbyte)",
  "E-RAB Setup Success Rate (VoIP)","Call Drop Rate (VoIP)","Intra-frequency Handover Out Success Rate(VoIP)",
  "Inter-frequency Handover Out Success Rate(VoIP)","SRVCC Success Rate (L2W)","SRVCC Success Rate (L2G)"
];
const monitoringKpis = [
  "Cell Availability Ratio","Average Latency Downlink (msecs)","DL PRB Utilization (%)","UL PRB Utilization (%)",
  "LTE DL - Cell Average Throughput (Mbit/s)","LTE UL - Cell Average Thoughput (Mbit/s)","LTE DL -USER Average Throughput (Mbit/s)",
  "LTE UL -USER Average Throughput (Mbit/s)","Downlink Packet Loss Rate (VoIP)","Uplink Packet Loss Rate (VoIP)",
  "VoLTE Traffic Erlang","VoLTE Traffic DL (MB)","VoLTE Traffic UL (MB)","DL BLER QCI1","UL BLER QCI1"
];
let selectedKpis = { acceptance: [...acceptanceKpis], monitoring: [...monitoringKpis] };

// --- UTILITY ---
function getRandomColor() {
  const colors = ['#2F80ED', '#27AE60', '#D24726', '#8E44AD', '#F39C12', '#2980B9'];
  return colors[Math.floor(Math.random() * colors.length)];
}

// --- FETCH DATA ---
async function fetchData(){
  try {
    const kpiUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=0&single=true&output=csv&t=" + Date.now();
    const kpiText = await (await fetch(kpiUrl)).text();
    const kpiRows = kpiText.trim().split('\n').map(r=>r.split(','));
    const kpiHeaders = kpiRows.shift().map(h=>h.trim());
    allData = kpiRows.map(r=>{
      const obj={};
      kpiHeaders.forEach((h,i)=>{
        const val=r[i]?r[i].trim():"";
        obj[h] = val==="" ? null : (isNaN(val) ? val : parseFloat(val));
      });
      return obj;
    });

    allSites = [...new Set(allData.map(d=>d["eNodeB Name"]))].filter(s=>s).sort();

    const cutoverUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=19616562&single=true&output=csv&t=" + Date.now();
    const cutoverText = await (await fetch(cutoverUrl)).text();
    const cutoverRows = cutoverText.trim().split('\n').map(r=>r.split(','));
    const cutoverHeaders = cutoverRows.shift().map(h=>h.trim());

    siteCutoverMap = {};
    cutoverRows.forEach(r=>{
      const siteName = r[cutoverHeaders.indexOf("eNodeB Name")]?.trim();
      const onAirDate = r[cutoverHeaders.indexOf("On-Air Date")]?.trim();
      if(siteName && onAirDate && allSites.includes(siteName)) siteCutoverMap[siteName] = onAirDate;
    });

    allOnAirDates = [...new Set(Object.values(siteCutoverMap))].filter(d => d).sort();
    selectedOnAirDates = [...allOnAirDates];
    selectedSites = [];

    setupOnAirDateDropdown();
    setupSiteDropdown();
    renderCharts();
  } catch(e){ console.error(e); alert("Failed to load data."); }
}

// --- DROPDOWNS & FILTERS ---
function setupOnAirDateDropdown(){ /* same as your original, unchanged */ }
function setupSiteDropdown(){ /* same as your original, unchanged */ }
function updateSelectedDates(){ /* same as original */ }
function updateSelectedSites(){ /* same as original */ }

// --- RENDER CHARTS ---
function renderCharts(){
  const container = document.getElementById("mainChartContainer");
  container.innerHTML = "";

  let kpisToShow = [];
  if(currentTab === "acceptance") kpisToShow = selectedKpis.acceptance;
  else if(currentTab === "monitoring") kpisToShow = selectedKpis.monitoring;
  else kpisToShow = [...selectedKpis.acceptance, ...selectedKpis.monitoring];

  let finalSiteList = selectedSites.length > 0 ? selectedSites : allSites.filter(s => selectedOnAirDates.includes(siteCutoverMap[s]));
  let filteredData = allData.filter(d => finalSiteList.includes(d["eNodeB Name"]));

  const timeline = [...new Set(filteredData.map(d=>d["Date"]))].sort((a,b)=>{
    const [da,ma,ya]=a.split('/').map(Number);
    const [db,mb,yb]=b.split('/').map(Number);
    return new Date(ya,ma-1,da)-new Date(yb,mb-1,db);
  });

  const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const timelineLabels = timeline.map(d => {
    const [day, month] = d.split('/').map(Number);
    return `${day} ${monthNames[month-1]}`;
  });

  const style = chartStyles[selectedStyle];
  document.querySelectorAll('.chart-card').forEach(c => c.style.backgroundColor = style.bgColor);

  kpisToShow.forEach((kpi, idx)=>{
    const card = document.createElement("div");
    card.className = "chart-card";

    const wrapper = document.createElement("div");
    wrapper.className = "chart-container";

    const canvas = document.createElement("canvas");
    canvas.id = `chart_${idx}`;

    wrapper.appendChild(canvas);
    card.appendChild(wrapper);
    container.appendChild(card);

    const dataPoints = timeline.map(date => {
      const vals = filteredData.filter(d=>d["Date"]===date && d[kpi]!=null).map(d=>d[kpi]);
      if(vals.length===0) return null;
      const isAvg = kpi.match(/(rate|%|ratio|average)/i);
      const sum = vals.reduce((a,b)=>a+b,0);
      return isAvg ? sum/vals.length : sum;
    });

    let bColor = 'transparent', lineC = getRandomColor();
    if(style.fill){
      const hex = lineC.substring(1);
      const r = parseInt(hex.substring(0,2),16);
      const g = parseInt(hex.substring(2,4),16);
      const b = parseInt(hex.substring(4,6),16);
      bColor = `rgba(${r},${g},${b},${style.alpha||0.15})`;
    }

    new Chart(canvas.getContext("2d"), {
      type: 'line',
      data: { labels: timelineLabels, datasets:[{
        label: (finalSiteList.length>0 && dataPoints.some(p=>p!==null)) ? "Aggregate" : "No Data",
        data: dataPoints,
        borderColor: lineC,
        backgroundColor: bColor,
        fill: style.fill,
        borderWidth: style.border,
        pointRadius: style.pointRadius,
        tension: style.tension,
        stepped: style.stepped,
        spanGaps: true
      }]},
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:false},
          title:{display:true,text:kpi,font:{size:14,weight:'bold'},color:style.titleColor}
        },
        scales:{ x:{ticks:{font:{size:8}},grid:{display:false}}, y:{grid:{color:style.gridColor}} } // default Y-axis
      }
    });
  });
}

// --- PPT EXPORT ---
async function downloadPPT(){
  const pptx = new PptxGenJS();
  pptx.layout='LAYOUT_16x9';
  const canvases = document.querySelectorAll("canvas");
  const count = graphsPerSlide;
  const lineColor = chartExportColor;
  const titleColor = chartExportTitleColor;

  const layoutDef = {
    1:{cols:1,rows:1,chartW:9.0,chartH:5.5,padding:0.5},
    2:{cols:2,rows:1,chartW:4.5,chartH:3.5,padding:0.4},
    3:{cols:3,rows:1,chartW:3.0,chartH:3.0,padding:0.4},
    4:{cols:2,rows:2,chartW:4.5,chartH:2.5,padding:0.3},
    6:{cols:3,rows:2,chartW:3.0,chartH:2.5,padding:0.2},
    9:{cols:3,rows:3,chartW:3.0,chartH:1.7,padding:0.1}
  }[count] || {cols:2,rows:1,chartW:4.5,chartH:3.5,padding:0.4};

  for(let i=0;i<canvases.length;i+=count){
    const slide = pptx.addSlide();
    const chartsThisSlide = Math.min(count, canvases.length-i);
    const layoutPositions=[];

    const maxW = 9.5, startX=0.5, startY=1.0;
    const totalChartWidth = layoutDef.cols*layoutDef.chartW;
    const totalPaddingWidth = (layoutDef.cols-1)*layoutDef.padding;
    const marginX = ((maxW-totalChartWidth-totalPaddingWidth)/2)+startX;

    for(let r=0;r<layoutDef.rows;r++){
      for(let c=0;c<layoutDef.cols;c++){
        if(layoutPositions.length>=chartsThisSlide) break;
        layoutPositions.push({x:marginX+c*(layoutDef.chartW+layoutDef.padding),y:startY+r*(layoutDef.chartH+layoutDef.padding),w:layoutDef.chartW,h:layoutDef.chartH});
      }
    }

    for(let j=0;j<chartsThisSlide;j++){
      const c = canvases[i+j];
      const imgData = c.toDataURL("image/png");
      const {x,y,w,h} = layoutPositions[j];
      slide.addImage({data:imgData,x,y,w,h,sizing:{type:'contain',w,h}});
    }
  }

  pptx.writeFile({fileName:"LTE_KPI_Report.pptx"});
}

// --- INIT ---
document.addEventListener('DOMContentLoaded',fetchData);
</script>

</body>
</html>
