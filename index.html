<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KPI Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f0f2f5; overflow-x:hidden; }
header { text-align:center; padding:20px 0; font-size:32px; font-weight:bold; color:#2F80ED; background:white; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:16px; }
.tabs { display:flex; justify-content:center; margin-bottom:16px; flex-wrap:wrap; gap:8px; }
.tab { padding:10px 20px; cursor:pointer; border:1px solid #ccc; border-radius:8px; background:#eee; font-weight:bold; transition:0.3s; }
.tab.active { background:#2F80ED; color:white; }
.tab:hover:not(.active) { background:#d0e1ff; }
.controls { display:flex; justify-content:center; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
#siteFilter { padding:8px; width:250px; border-radius:6px; border:1px solid #ccc; }
#dropdown { position:absolute; background:white; border:1px solid #ccc; max-height:150px; overflow-y:auto; display:none; z-index:10; width:250px; top:38px; left:0; border-radius:6px; }
#dropdown div { padding:6px 10px; cursor:pointer; transition:0.2s; }
#dropdown div:hover { background:#2F80ED; color:white; }
#siteDropdownBtn { padding:8px 10px; cursor:pointer; border:1px solid #ccc; border-radius:6px; background:white; min-width:250px; text-align:left; position:relative; z-index:5; }
#siteDropdownList { position:absolute; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; display:none; z-index:10; width:250px; border-radius:6px; padding:6px; }

button { padding:10px 18px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:bold; transition:0.2s; }
button:hover { background:#1f5ab5; }

.chart-grid { 
  display:grid; 
  grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); 
  gap:20px; 
  padding:0 20px 20px 20px; 
}
canvas { background:white; border-radius:12px; padding:16px; width:100% !important; height:250px !important; }
.chart-card { padding:10px; border-radius:12px; background:white; box-shadow:0 2px 12px rgba(0,0,0,0.1); transition:0.3s; }
.chart-card:hover { transform:translateY(-4px); box-shadow:0 6px 20px rgba(0,0,0,0.15); }
.chart-title { text-align:center; font-weight:bold; margin-bottom:10px; color:#333; }

/* Drawer styles */
#kpiDrawer { position:fixed; top:0; right:-320px; width:320px; height:100%; background:white; box-shadow:-4px 0 12px rgba(0,0,0,0.15); transition:0.3s; z-index:20; padding:20px; overflow-y:auto; }
#kpiDrawer.open { right:0; }
#kpiDrawer h3 { margin-top:0; margin-bottom:12px; color:#2F80ED; }
.kpiOption { margin-bottom:6px; }
#applyKpiBtn { margin-top:10px; width:100%; }

/* Minimal blue tab button top-right */
#kpiDrawerToggle { position:fixed; top:20px; right:0; width:30px; height:80px; background:#2F80ED; border-radius:6px 0 0 6px; cursor:pointer; z-index:25; }
#kpiDrawerToggle:hover { background:#1f5ab5; }
</style>
</head>
<body>

<header>KPI Dashboard</header>

<div class="tabs">
  <div class="tab active" data-tab="acceptance">Acceptance KPIs</div>
  <div class="tab" data-tab="monitoring">Monitoring KPIs</div>
</div>

<div class="controls">
  <div style="position:relative;">
    <input type="text" id="siteFilter" placeholder="Search eNodeB Name">
    <div id="dropdown"></div>
  </div>
  <div style="position:relative;">
    <button id="siteDropdownBtn">All Sites ▼</button>
    <div id="siteDropdownList"></div>
  </div>
  <button id="refreshBtn">Refresh Data</button>
</div>

<div class="chart-grid" id="chartContainer"></div>

<!-- KPI Drawer -->
<div id="kpiDrawer">
  <h3>Select KPIs</h3>
  <div>
    <input type="checkbox" id="selectAllKpi"> <label for="selectAllKpi"><b>Select All</b></label>
  </div>
  <div id="kpiOptions"></div>
  <button id="applyKpiBtn">Apply</button>
</div>
<div id="kpiDrawerToggle"></div>

<script>
let allData = [], charts = [], fuse = null, currentTab = "acceptance", allSites = [];
let tempSelectedKpis = [], selectedKpis = [];
const animationDuration = 300;

const acceptanceKpis = [
  "LTE RRC Setup Success Rate","ERAB Setup Success Rate","LTE Call Setup Success Rate","E-RAB Call Drop Rate",
  "CSFB Access Success Rate","LTE Intra Freq HO Success Rate","Intra-eNB HO Success Rate","Inter-eNBX2HO Success Rate",
  "Inter-eNBS1HO Success Rate","Max RRC Connected Ue","DL Data Total Volume (Gbyte)","UL Data Total Volume (Gbyte)",
  "E-RAB Setup Success Rate (VoIP)","Call Drop Rate (VoIP)","Intra-frequency Handover Out Success Rate(VoIP)",
  "Inter-frequency Handover Out Success Rate(VoIP)","SRVCC Success Rate (L2W)","SRVCC Success Rate (L2G)"
];
const monitoringKpis = [
  "Cell Availability Ratio","Average Latency Downlink (msecs)","DL PRB Utilization (%)","UL PRB Utilization (%)",
  "LTE DL - Cell Average Throughput (Mbit/s)","LTE UL - Cell Average Thoughput (Mbit/s)","LTE DL -USER Average Throughput (Mbit/s)",
  "LTE UL -USER Average Throughput (Mbit/s)","Downlink Packet Loss Rate (VoIP)","Uplink Packet Loss Rate (VoIP)",
  "VoLTE Traffic Erlang","VoLTE Traffic DL (MB)","VoLTE Traffic UL (MB)","DL BLER QCI1","UL BLER QCI1"
];

async function fetchData(){
  try{
    const res = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?output=csv");
    const text = await res.text();
    parseCSV(text);
    populateSiteDropdown();
    populateKpiDrawer();
    drawCharts();
  }catch(err){ console.error(err); }
}

function parseCSV(str){
  const rows = str.trim().split('\n').map(r=>r.split(','));
  const headers = rows.shift().map(h=>h.trim());
  allData = rows.map(r=>{
    const obj = {};
    headers.forEach((h,i)=>{
      const val = r[i]?r[i].trim():"0";
      obj[h] = isNaN(val)?val:parseFloat(val);
    });
    return obj;
  });
  fuse = new Fuse(allData, { keys:['eNodeB Name'], threshold:0.4 });
  allSites = [...new Set(allData.map(d=>d["eNodeB Name"]))].sort();
}

// Site dropdown
function populateSiteDropdown(){
  const dropdownList = document.getElementById("siteDropdownList");
  dropdownList.innerHTML = '';
  allSites.forEach((site,i)=>{
    const div = document.createElement("div");
    div.innerHTML = `<input type="checkbox" class="siteOption" id="site_${i}" value="${site}"> <label for="site_${i}">${site}</label>`;
    dropdownList.appendChild(div);
  });
  document.getElementById("siteDropdownBtn").onclick = ()=>{
    dropdownList.style.display = dropdownList.style.display==="block"?"none":"block";
  };
  const updateButtonLabel = ()=>{
    const checked = Array.from(dropdownList.querySelectorAll(".siteOption:checked")).map(c=>c.value);
    let labelText = "All Sites";
    if(checked.length === 1){ labelText = checked[0]; }
    else if(checked.length > 1 && checked.length<allSites.length){ labelText = "Multiple Sites"; }
    document.getElementById("siteDropdownBtn").textContent = labelText + " ▼";
  };
  dropdownList.querySelectorAll(".siteOption").forEach(c=>{
    c.addEventListener("change", updateButtonLabel);
  });
}

// KPI drawer
function populateKpiDrawer(){
  const kpiDiv = document.getElementById("kpiOptions");
  kpiDiv.innerHTML = '';
  const kpis = currentTab==="acceptance"?acceptanceKpis:monitoringKpis;
  tempSelectedKpis = selectedKpis.length? selectedKpis.slice():kpis.slice();

  const selectAllKpiChk = document.getElementById("selectAllKpi");
  selectAllKpiChk.checked = tempSelectedKpis.length===kpis.length;
  selectAllKpiChk.onchange = ()=>{
    if(selectAllKpiChk.checked){ tempSelectedKpis = kpis.slice(); }
    else { tempSelectedKpis = []; }
    renderKpiOptions();
  };

  function renderKpiOptions(){
    kpiDiv.innerHTML = '';
    kpis.forEach(kpi=>{
      const checked = tempSelectedKpis.includes(kpi)? "checked":"";
      const div = document.createElement("div");
      div.className = "kpiOption";
      div.innerHTML = `<input type="checkbox" class="kpiCheckbox" value="${kpi}" ${checked}> ${kpi}`;
      kpiDiv.appendChild(div);
    });
    document.querySelectorAll(".kpiCheckbox").forEach(chk=>{
      chk.onchange = ()=>{
        const checkedKpis = Array.from(document.querySelectorAll(".kpiCheckbox:checked")).map(c=>c.value);
        tempSelectedKpis = checkedKpis;
        selectAllKpiChk.checked = tempSelectedKpis.length===kpis.length;
      };
    });
  }
  renderKpiOptions();
}

// Drawer toggle
const drawer = document.getElementById("kpiDrawer");
const toggle = document.getElementById("kpiDrawerToggle");
toggle.addEventListener("click", ()=>{
  drawer.classList.toggle("open");
});

// Apply button
document.getElementById("applyKpiBtn").addEventListener("click", ()=>{
  selectedKpis = tempSelectedKpis.slice();
  drawCharts();
  drawer.classList.remove("open");
});

// Draw charts
function drawCharts(){
  const container = document.getElementById("chartContainer");
  container.innerHTML = "";
  charts = [];

  const siteNameSearch = document.getElementById("siteFilter").value.trim();
  const selectedSites = Array.from(document.querySelectorAll("#siteDropdownList .siteOption:checked")).map(c=>c.value);
  let filteredData = allData;
  if(siteNameSearch) filteredData = filteredData.filter(d=>d["eNodeB Name"]===siteNameSearch);
  else if(selectedSites.length>0) filteredData = filteredData.filter(d=>selectedSites.includes(d["eNodeB Name"]));
  if(filteredData.length===0) return;

  const kpis = selectedKpis.length? selectedKpis:(currentTab==="acceptance"?acceptanceKpis:monitoringKpis);

  const timeline = [...new Set(allData.map(d=>d["Date"]))];
  timeline.sort((a,b)=>{
    const [da, ma, ya] = a.split('/').map(Number);
    const [db, mb, yb] = b.split('/').map(Number);
    return new Date(ya, ma-1, da) - new Date(yb, mb-1, db);
  });

  const timelineLabels = timeline.map(d=>{
    const [day, month] = d.split('/').map(Number);
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return `${day} ${monthNames[month-1]}`;
  });

  kpis.forEach(kpi=>{
    const card = document.createElement("div");
    card.className = "chart-card";
    const title = document.createElement("div");
    title.className = "chart-title";

    let labelText = "All Sites";
    if(selectedSites.length === 1){ labelText = selectedSites[0]; }
    else if(selectedSites.length > 1 && selectedSites.length<allSites.length){ labelText = "Multiple Sites"; }

    title.textContent = `${kpi} - ${labelText}`;
    const canvas = document.createElement("canvas");
    card.appendChild(title);
    card.appendChild(canvas);
    container.appendChild(card);

    const dataPoints = timeline.map(date=>{
      const values = filteredData.filter(d=>d["Date"]===date).map(d=>{
        const v = d[kpi];
        return (v === "" || v === null || isNaN(v)) ? 0 : v;
      });
      if(values.length===0) return 0;
      if(kpi.toLowerCase().includes("%") || kpi.toLowerCase().includes("rate") || kpi.toLowerCase().includes("ratio")){
        return values.reduce((a,b)=>a+b,0)/values.length;
      }else{ return values.reduce((a,b)=>a+b,0); }
    });

    const ctx = canvas.getContext("2d");
    charts.push(new Chart(ctx,{
      type:'line',
      data:{ labels: timelineLabels, datasets:[{ label: labelText, data:dataPoints, borderColor:'#'+Math.floor(Math.random()*16777215).toString(16), fill:false, tension:0.3, pointRadius:3 }] },
      options:{ responsive:true, maintainAspectRatio:false, animation:{ x:{ type:'number', easing:'linear', duration:animationDuration, from:NaN, delay(ctx){ return ctx.index*10; } }, y:{duration:0} }, scales:{ x:{display:true}, y:{beginAtZero:true, ticks:{ maxTicksLimit:6 }} }, plugins:{ legend:{ position:'top' } } }
    }));
  });
}

// Fuzzy search dropdown
const siteInput = document.getElementById("siteFilter");
const dropdown = document.getElementById("dropdown");
siteInput.addEventListener("input", ()=>{
  const val = siteInput.value.trim();
  if(!val || !fuse){ dropdown.style.display="none"; return; }
  const results = fuse.search(val).slice(0,5).map(r=>r.item["eNodeB Name"]);
  dropdown.innerHTML = "";
  results.forEach(r=>{
    const div = document.createElement("div");
    div.textContent = r;
    div.onclick = ()=>{
      siteInput.value=r;
      dropdown.style.display="none";
      drawCharts();
    };
    dropdown.appendChild(div);
  });
  dropdown.style.display = results.length? "block":"none";
});
document.addEventListener("click", e=>{ if(e.target!==siteInput) dropdown.style.display="none"; });

// Tabs switching
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    currentTab = tab.dataset.tab;
    populateKpiDrawer(); // refresh drawer options
    drawCharts(); // redraw charts immediately
  });
});

// Refresh
document.getElementById("refreshBtn").addEventListener("click", fetchData);

// Initial fetch
fetchData();
</script>

</body>
</html>
